<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BGT PRO - Aplikasi Komunitas</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#4285f4">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BGT PRO">
    <meta name="application-name" content="BGT PRO">
    <meta name="msapplication-TileColor" content="#4285f4">
    
    <!-- Manifest untuk PWA -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkJHVCBQUk8iLAogICJzaG9ydF9uYW1lIjogIkJHVCBQUk8iLAogICJzdGFydF91cmwiOiAiLiIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI2ZmZmZmZiIsCiAgInRoZW1lX2NvbG9yIjogIiM0Mjg1ZjQiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJodHRwczovL3BpY3N1bS5waG90b3Mvc2VlZC9iZ3Rwcm8taWNvbi8xOTIvMTkyLmpwZyIsCiAgICAgICJzaXplcyI6ICIxOTJ4MTkyIiwKICAgICAgInR5cGUiOiAiaW1hZ2UvanBlZyIKICAgIH0sCiAgICB7CiAgICAgICJzcmMiOiAiaHR0cHM6Ly9waWNzdW0ucGhvdG9zL3NlZWQvYmd0cHJvLWljb24vNTEyLzUxMi5qcGciLAogICAgICAic2l6ZXMiOiAiNTEyeDUxMiIsCiAgICAgICJ0eXBlIjogImltYWdlL2pwZWciCiAgICB9CiAgXQp9">
    
    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" sizes="192x192" href="https://picsum.photos/seed/bgtpro-icon/192/192.jpg">
    <link rel="apple-touch-icon" sizes="512x512" href="https://picsum.photos/seed/bgtpro-icon/512/512.jpg">
    
    <!-- External Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
    
    <style>
        /* CSS Variables untuk Theme Support */
        :root {
            --primary-color: #4285f4;
            --primary-dark: #1a73e8;
            --secondary-color: #ff6b6b;
            --secondary-dark: #ee5a24;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --info-color: #3498db;
            
            /* Light Theme */
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --text-color: #2c3e50;
            --text-secondary: #7f8c8d;
            --border-color: #e9ecef;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --overlay-bg: rgba(0, 0, 0, 0.5);
            --header-bg: linear-gradient(135deg, #4285f4, #1a73e8);
            --nav-bg: #ffffff;
            
            /* Transitions */
            --transition-fast: 0.2s;
            --transition-normal: 0.3s;
            --transition-slow: 0.5s;
        }
        
        [data-theme="dark"] {
            /* Dark Theme */
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-color: #ffffff;
            --text-secondary: #b0b0b0;
            --border-color: #333333;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --overlay-bg: rgba(0, 0, 0, 0.7);
            --header-bg: linear-gradient(135deg, #1a73e8, #0d47a1);
            --nav-bg: #1e1e1e;
        }
        
        /* Global Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-color);
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            padding: 20px; 
            -webkit-font-smoothing: antialiased; 
            -moz-osx-font-smoothing: grayscale;
            transition: background-color var(--transition-normal), color var(--transition-normal);
        }
        
        /* Phone Container */
        .phone-container { 
            width: 350px; 
            height: 750px; 
            background-color: var(--card-bg); 
            border-radius: 16px; 
            box-shadow: 0 10px 30px var(--shadow-color); 
            overflow: hidden; 
            position: relative; 
            transition: background-color var(--transition-normal);
        }
        
        /* App Container */
        .app-container { 
            height: 100%; 
            overflow-y: auto; 
            background-color: var(--bg-color); 
            position: relative; 
            transition: background-color var(--transition-normal);
        }
        
        /* Custom Scrollbar */
        .app-container::-webkit-scrollbar { 
            width: 4px; 
        } 
        .app-container::-webkit-scrollbar-track { 
            background: transparent; 
        } 
        .app-container::-webkit-scrollbar-thumb { 
            background: var(--text-secondary); 
            border-radius: 2px; 
        }
        
        /* Header */
        .header { 
            background: var(--header-bg); 
            color: white; 
            padding: 12px 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            box-shadow: 0 4px 12px rgba(26, 115, 232, 0.3); 
            position: sticky; 
            top: 0; 
            z-index: 100; 
            transition: background var(--transition-normal);
        }
        
        .header-left { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
        }
        
        .profile-photo { 
            width: 30px; 
            height: 30px; 
            border-radius: 50%; 
            object-fit: cover; 
            border: 2px solid white; 
            cursor: pointer; 
            transition: transform var(--transition-normal), box-shadow var(--transition-normal); 
        }
        
        .profile-photo:hover { 
            transform: scale(1.1); 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); 
        }
        
        .logo { 
            font-size: 18px; 
            font-weight: 800; 
            letter-spacing: -0.5px; 
            position: absolute; 
            left: 50%; 
            transform: translateX(-50%); 
        }
        
        .header-right { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            margin-left: auto; 
        }
        
        .notification-btn, .menu-btn, .theme-toggle { 
            position: relative; 
            background: none; 
            border: none; 
            color: white; 
            font-size: 16px; 
            cursor: pointer; 
            padding: 5px; 
            border-radius: 8px; 
            transition: background-color var(--transition-normal); 
        }
        
        .notification-btn:hover, .menu-btn:hover, .theme-toggle:hover { 
            background-color: rgba(255, 255, 255, 0.2); 
        }
        
        .notification-badge { 
            position: absolute; 
            top: -2px; 
            right: -2px; 
            background: linear-gradient(135deg, #ff4757, #ff6348); 
            color: white; 
            font-size: 9px; 
            font-weight: 700; 
            width: 16px; 
            height: 16px; 
            border-radius: 50%; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            box-shadow: 0 2px 6px rgba(255, 71, 87, 0.4); 
        }
        
        /* Side Menu */
        .side-menu { 
            position: absolute; 
            top: 0; 
            right: -280px; 
            width: 280px; 
            height: 100%; 
            background-color: var(--card-bg); 
            box-shadow: -4px 0 20px var(--shadow-color); 
            transition: right var(--transition-normal) cubic-bezier(0.4, 0, 0.2, 1); 
            z-index: 1000; 
            display: flex; 
            flex-direction: column; 
            border-radius: 0 16px 16px 0; 
        }
        
        .side-menu.active { 
            right: 0; 
        }
        
        .side-menu-header { 
            background: var(--header-bg); 
            color: white; 
            padding: 20px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-radius: 0 0 0 16px; 
        }
        
        .close-menu { 
            background: none; 
            border: none; 
            color: white; 
            font-size: 24px; 
            cursor: pointer; 
            padding: 5px; 
            border-radius: 8px; 
            transition: background-color var(--transition-normal); 
        }
        
        .close-menu:hover { 
            background-color: rgba(255, 255, 255, 0.2); 
        }
        
        .side-menu-content { 
            flex: 1; 
            padding: 20px; 
            overflow-y: auto; 
        }
        
        .menu-item { 
            display: flex; 
            align-items: center; 
            padding: 15px; 
            margin-bottom: 10px; 
            border-radius: 12px; 
            cursor: pointer; 
            transition: all var(--transition-normal); 
            background-color: var(--bg-color); 
        }
        
        .menu-item:hover { 
            background-color: var(--border-color); 
            transform: translateX(-5px); 
        }
        
        .menu-item i { 
            font-size: 20px; 
            margin-right: 15px; 
            color: var(--primary-color); 
        }
        
        .menu-item span { 
            font-size: 16px; 
            font-weight: 600; 
            color: var(--text-color); 
        }
        
        /* Overlay */
        .overlay { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background-color: var(--overlay-bg); 
            z-index: 999; 
            opacity: 0; 
            visibility: hidden; 
            transition: all var(--transition-normal); 
            border-radius: 16px; 
        }
        
        .overlay.active { 
            opacity: 1; 
            visibility: visible; 
        }
        
        /* Event Section */
        .event-section { 
            margin: 0 15px 15px; 
            background-color: var(--card-bg); 
            border-radius: 16px; 
            overflow: hidden; 
            box-shadow: 0 4px 15px var(--shadow-color); 
            transition: transform var(--transition-normal), box-shadow var(--transition-normal), background-color var(--transition-normal); 
            cursor: pointer; 
            position: relative; 
            height: 200px;
        }
        
        .event-section:hover { 
            transform: translateY(-3px); 
            box-shadow: 0 8px 25px var(--shadow-color); 
        }
        
        .event-image { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            transition: transform var(--transition-normal);
        }
        
        .event-section:hover .event-image {
            transform: scale(1.05);
        }
        
        .event-badge { 
            position: absolute; 
            top: 15px; 
            right: 15px; 
            background: linear-gradient(135deg, #ff4757, #ff6348); 
            color: white; 
            font-size: 11px; 
            font-weight: 700; 
            padding: 4px 10px; 
            border-radius: 12px; 
            text-transform: uppercase; 
            letter-spacing: 0.5px; 
            box-shadow: 0 2px 8px rgba(255, 71, 87, 0.3); 
            z-index: 3;
        }
        
        /* Click indicator */
        .click-indicator {
            position: absolute;
            bottom: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            opacity: 0;
            transition: opacity var(--transition-normal);
            z-index: 3;
        }
        
        .event-section:hover .click-indicator {
            opacity: 1;
        }
        
        /* Admin Carousel */
        .admin-carousel { 
            margin: 15px; 
            position: relative; 
            overflow: hidden; 
            border-radius: 16px; 
            background: var(--card-bg); 
            box-shadow: 0 4px 15px var(--shadow-color); 
            transition: background-color var(--transition-normal);
            height: 180px;
        }
        
        .carousel-container { 
            position: relative; 
            height: 100%; 
            overflow: hidden; 
        }
        
        .carousel-slide { 
            position: absolute; 
            width: 100%; 
            height: 100%; 
            opacity: 0; 
            transition: opacity 1s ease-in-out; 
            cursor: pointer;
        }
        
        .carousel-slide.active { 
            opacity: 1; 
        }
        
        .carousel-slide img { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            transition: transform var(--transition-normal);
        }
        
        .carousel-slide:hover img {
            transform: scale(1.05);
        }
        
        .carousel-indicators { 
            position: absolute; 
            bottom: 10px; 
            left: 50%; 
            transform: translateX(-50%); 
            display: flex; 
            gap: 8px; 
            z-index: 10; 
        }
        
        .indicator { 
            width: 8px; 
            height: 8px; 
            border-radius: 50%; 
            background-color: rgba(255, 255, 255, 0.5); 
            cursor: pointer; 
            transition: all var(--transition-normal); 
        }
        
        .indicator.active { 
            width: 24px; 
            border-radius: 4px; 
            background-color: white; 
        }
        
        /* Transport Cards Section */
        .transport-section {
            margin: 0 15px 15px;
        }
        
        .transport-section-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-color);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .transport-section-title i {
            color: var(--primary-color);
        }
        
        .transport-cards {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .transport-card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 2px 8px var(--shadow-color);
            transition: transform var(--transition-normal), box-shadow var(--transition-normal);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            min-height: 80px;
            position: relative;
            overflow: hidden;
        }
        
        .transport-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px var(--shadow-color);
        }
        
        .transport-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, transparent, rgba(66, 133, 244, 0.05));
            opacity: 0;
            transition: opacity var(--transition-normal);
        }
        
        .transport-card:hover::before {
            opacity: 1;
        }
        
        .transport-logo {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            margin-bottom: 8px;
            object-fit: contain;
            transition: transform var(--transition-normal);
        }
        
        .transport-card:hover .transport-logo {
            transform: scale(1.1);
        }
        
        .transport-name {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 2px;
        }
        
        .transport-desc {
            font-size: 10px;
            color: var(--text-secondary);
            line-height: 1.3;
        }
        
        /* Bottom Navigation */
        .bottom-nav { 
            position: absolute; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            background-color: var(--nav-bg); 
            display: flex; 
            justify-content: space-around; 
            padding: 6px 0 10px; 
            box-shadow: 0 -4px 20px var(--shadow-color); 
            border-top: 1px solid var(--border-color); 
            transition: background-color var(--transition-normal), border-color var(--transition-normal);
        }
        
        .nav-item { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            color: var(--text-secondary); 
            cursor: pointer; 
            transition: all var(--transition-normal); 
            position: relative; 
            padding: 3px; 
        }
        
        .nav-item.active { 
            color: var(--primary-color); 
        }
        
        .nav-item.active i { 
            transform: scale(1.1); 
        }
        
        .nav-item i { 
            font-size: 18px; 
            margin-bottom: 3px; 
            transition: transform var(--transition-normal); 
        }
        
        .nav-item span { 
            font-size: 9px; 
            font-weight: 600; 
        }
        
        /* Modal */
        .modal { 
            display: none; 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background-color: var(--overlay-bg); 
            z-index: 2000; 
            justify-content: center; 
            align-items: center; 
            opacity: 0; 
            transition: opacity var(--transition-normal); 
            border-radius: 16px; 
        }
        
        .modal.active { 
            display: flex; 
            opacity: 1; 
        }
        
        .modal-content { 
            background-color: var(--card-bg); 
            border-radius: 20px; 
            width: 90%; 
            max-width: 320px; 
            max-height: 80%; 
            overflow: hidden; 
            position: relative; 
            animation: modalSlideIn var(--transition-slow); 
            transition: background-color var(--transition-normal);
        }
        
        @keyframes modalSlideIn { 
            from { transform: translateY(-50px); opacity: 0; } 
            to { transform: translateY(0); opacity: 1; } 
        }
        
        .modal-header { 
            padding: 18px; 
            border-bottom: 1px solid var(--border-color); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            transition: border-color var(--transition-normal);
        }
        
        .modal-title { 
            font-size: 18px; 
            font-weight: 700; 
            color: var(--text-color); 
        }
        
        .modal-close { 
            background: none; 
            border: none; 
            font-size: 22px; 
            color: var(--text-secondary); 
            cursor: pointer; 
            transition: color var(--transition-normal); 
        }
        
        .modal-close:hover { 
            color: var(--text-color); 
        }
        
        .modal-body { 
            padding: 18px; 
            max-height: 60vh; 
            overflow-y: auto; 
        }
        
        .modal-image { 
            width: 100%; 
            border-radius: 12px; 
            margin-bottom: 18px; 
        }
        
        .modal-details { 
            color: var(--text-color); 
        }
        
        .modal-details h3 { 
            font-size: 16px; 
            margin-bottom: 8px; 
        }
        
        .modal-details p { 
            font-size: 13px; 
            line-height: 1.6; 
            color: var(--text-secondary); 
            margin-bottom: 15px; 
            white-space: pre-line; 
        }
        
        .modal-action { 
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 20px; 
            font-size: 14px; 
            font-weight: 600; 
            cursor: pointer; 
            width: 100%; 
            transition: transform var(--transition-normal), box-shadow var(--transition-normal); 
        }
        
        .modal-action:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.4); 
        }
        
        /* Animations */
        @keyframes fadeInUp { 
            from { opacity: 0; transform: translateY(20px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        
        .fade-in-up { 
            animation: fadeInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        
        /* Page Views */
        .page-view { 
            display: none; 
            padding: 20px; 
            padding-bottom: 80px;
            animation: fadeInUp var(--transition-slow) ease-out; 
        }
        
        .page-view.active { 
            display: block; 
        }
        
        /* Profile Page */
        .profile-header { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            margin-bottom: 20px; 
        }
        
        .profile-header h2 { 
            font-size: 24px; 
            color: var(--text-color); 
        }
        
        .back-btn { 
            background: none; 
            border: 1px solid var(--border-color); 
            color: var(--text-secondary); 
            padding: 8px 15px; 
            border-radius: 20px; 
            cursor: pointer; 
            font-size: 14px; 
            transition: all var(--transition-normal); 
        }
        
        .back-btn:hover { 
            background-color: var(--bg-color); 
            border-color: var(--text-secondary); 
        }
        
        .profile-content { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
        }
        
        .profile-avatar { 
            width: 120px; 
            height: 120px; 
            border-radius: 50%; 
            object-fit: cover; 
            border: 4px solid var(--card-bg); 
            box-shadow: 0 4px 12px var(--shadow-color); 
            margin-bottom: 20px; 
        }
        
        .profile-info { 
            text-align: center; 
        }
        
        .profile-info h3 { 
            font-size: 22px; 
            color: var(--text-color); 
            margin: 0 0 5px 0; 
        }
        
        .profile-info p { 
            font-size: 14px; 
            color: var(--text-secondary); 
            margin: 5px 0; 
        }
        
        .profile-stats { 
            display: flex; 
            justify-content: space-around; 
            width: 100%; 
            margin-top: 20px; 
            padding-top: 20px; 
            border-top: 1px solid var(--border-color); 
        }
        
        .stat-item { 
            text-align: center; 
        }
        
        .stat-item .stat-value { 
            font-size: 18px; 
            font-weight: 700; 
            color: var(--text-color); 
        }
        
        .stat-item .stat-label { 
            font-size: 12px; 
            color: var(--text-secondary); 
            text-transform: uppercase; 
            margin-top: 5px; 
        }
        
        /* Card Styles */
        .card {
            background-color: var(--card-bg);
            border-radius: 16px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px var(--shadow-color);
            transition: transform var(--transition-normal), box-shadow var(--transition-normal);
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px var(--shadow-color);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .card-title i {
            color: var(--primary-color);
        }
        
        .card-body {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.6;
        }
        
        /* Button Styles */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-normal);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3);
        }
        
        .btn-secondary {
            background-color: var(--bg-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }
        
        .btn-secondary:hover {
            background-color: var(--border-color);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #229954);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color), #c0392b);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color), #e67e22);
            color: white;
        }
        
        .btn-block {
            width: 100%;
            justify-content: center;
        }
        
        /* Form Styles */
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-color);
        }
        
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            background-color: var(--card-bg);
            color: var(--text-color);
            transition: border-color var(--transition-normal);
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        /* List Styles */
        .list-group {
            background-color: var(--card-bg);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px var(--shadow-color);
        }
        
        .list-item {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            transition: background-color var(--transition-normal);
            cursor: pointer;
        }
        
        .list-item:last-child {
            border-bottom: none;
        }
        
        .list-item:hover {
            background-color: var(--bg-color);
        }
        
        .list-item-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 5px;
        }
        
        .list-item-subtitle {
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            transition: opacity var(--transition-slow) ease-out;
        }
        
        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .loading-logo {
            font-size: 32px;
            font-weight: 800;
            color: var(--primary-color);
            margin-bottom: 20px;
            letter-spacing: -1px;
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            margin-top: 15px;
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        /* Tombol Batal Loading */
        .cancel-loading-btn {
            margin-top: 20px;
            padding: 8px 16px;
            background-color: var(--card-bg);
            border: 1px solid var(--danger-color);
            color: var(--danger-color);
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            display: none; /* Hidden by default */
        }
        
        .cancel-loading-btn:hover {
            background-color: var(--danger-color);
            color: white;
        }
        
        /* Install Prompt */
        .install-prompt {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 15px 20px;
            box-shadow: 0 4px 20px var(--shadow-color);
            z-index: 1000;
            display: none;
            align-items: center;
            gap: 15px;
            max-width: 320px;
            animation: slideUp var(--transition-slow) ease-out;
        }
        
        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(100px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        
        .install-prompt-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
        }
        
        .install-prompt-content {
            flex: 1;
        }
        
        .install-prompt-title {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-color);
            margin-bottom: 2px;
        }
        
        .install-prompt-text {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .install-prompt-buttons {
            display: flex;
            gap: 8px;
        }
        
        .install-prompt-btn {
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all var(--transition-normal);
        }
        
        .install-prompt-btn-install {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
        }
        
        .install-prompt-btn-install:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(66, 133, 244, 0.3);
        }
        
        .install-prompt-btn-dismiss {
            background-color: var(--bg-color);
            color: var(--text-secondary);
        }
        
        .install-prompt-btn-dismiss:hover {
            background-color: var(--border-color);
        }
        
        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background-color: var(--card-bg);
            color: var(--text-color);
            padding: 12px 20px;
            border-radius: 20px;
            box-shadow: 0 4px 12px var(--shadow-color);
            z-index: 1001;
            opacity: 0;
            transition: all var(--transition-normal);
            font-size: 14px;
            font-weight: 600;
            max-width: 300px;
            text-align: center;
        }
        
        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        
        .toast.success {
            background-color: var(--success-color);
            color: white;
        }
        
        .toast.error {
            background-color: var(--danger-color);
            color: white;
        }
        
        .toast.warning {
            background-color: var(--warning-color);
            color: white;
        }
        
        .toast.info {
            background-color: var(--info-color);
            color: white;
        }
        
        /* Error Message */
        .error-message { 
            background-color: var(--danger-color); 
            color: white; 
            padding: 10px 15px; 
            border-radius: 8px; 
            margin: 10px 15px; 
            font-size: 13px; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
        }
        
        .error-message i { 
            font-size: 16px; 
        }
        
        .error-message a { 
            color: white; 
            text-decoration: underline; 
            font-weight: 600; 
        }
        
        /* Permission Guide */
        .permission-guide { 
            background-color: var(--primary-color); 
            color: white; 
            padding: 15px; 
            border-radius: 8px; 
            margin: 10px 15px; 
            font-size: 13px; 
            display: none; 
        }
        
        .permission-guide.active { 
            display: block; 
        }
        
        .permission-guide h4 { 
            margin-bottom: 10px; 
            font-size: 16px; 
        }
        
        .permission-guide ol { 
            padding-left: 20px; 
            margin-bottom: 10px; 
        }
        
        .permission-guide li { 
            margin-bottom: 5px; 
        }
        
        .permission-guide code { 
            background-color: rgba(255, 255, 255, 0.2); 
            padding: 2px 5px; 
            border-radius: 4px; 
            font-family: monospace; 
        }
        
        .permission-guide .copy-btn { 
            background-color: rgba(255, 255, 255, 0.2); 
            border: none; 
            color: white; 
            padding: 5px 10px; 
            border-radius: 4px; 
            cursor: pointer; 
            margin-top: 10px; 
            font-size: 12px; 
            transition: background-color var(--transition-normal); 
        }
        
        .permission-guide .copy-btn:hover { 
            background-color: rgba(255, 255, 255, 0.3); 
        }
        
        /* Realtime Indicator */
        .realtime-indicator { 
            position: absolute; 
            top: 15px; 
            right: 15px; 
            width: 10px; 
            height: 10px; 
            border-radius: 50%; 
            background-color: var(--success-color); 
            opacity: 0; 
            transition: opacity var(--transition-normal); 
        }
        
        .realtime-indicator.active { 
            opacity: 1; 
        }
        
        /* Disruption Overlay */
        #disruption-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition-slow) ease-in-out, visibility var(--transition-slow) ease-in-out;
            border-radius: 16px;
        }
        
        #disruption-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        #disruption-overlay img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            border: 3px solid red;
            animation: glitch 1.5s infinite;
        }
        
        #disruption-overlay h1 {
            font-family: 'Courier New', Courier, monospace;
            font-size: 2.5rem;
            color: #ff0000;
            text-shadow: 0 0 10px #ff0000, 0 0 20px #ff00de;
            text-align: center;
            margin-top: 20px;
            animation: textGlitch 0.3s infinite;
        }
        
        @keyframes glitch {
            0%, 100% { transform: translate(0, 0); }
            20% { transform: translate(-5px, 5px); }
            40% { transform: translate(-5px, -5px); }
            60% { transform: translate(5px, 5px); }
            80% { transform: translate(5px, -5px); }
        }
        
        @keyframes textGlitch {
            0%, 100% { text-shadow: 0 0 10px red, 0 0 20px #ff00de; }
            50% { text-shadow: 0 0 10px #ff00de, 0 0 20px red; }
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }
        
        .empty-state i {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
            color: var(--primary-color);
        }
        
        .empty-state h3 {
            font-size: 20px;
            margin-bottom: 10px;
            color: var(--text-color);
        }
        
        .empty-state p {
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 20px;
        }
        
        /* Map Related Styles */
        .map-activity-indicator {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255,255,255, 0.9);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        
        .map-activity-indicator.updating i {
            color: var(--warning-color);
        }
        
        .map-stats {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(255,255,255, 0.9);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            color: var(--text-color);
            z-index: 1000;
        }
        
        .map-dot {
            width: 100%;
            height: 100%;
            background-color: var(--text-secondary);
            border-radius: 50%;
            display: block;
        }
        
        .active-dot {
            background-color: var(--primary-color);
        }
        
        .inactive-dot {
            background-color: #999;
        }
        
        .blinking {
            animation: blink 1.5s infinite;
        }
        
        @keyframes blink {
            0% { opacity: 1; }
            50% { opacity: 0.4; }
            100% { opacity: 1; }
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 10px;
        }
        
        .status-indicator.active {
            background-color: var(--success-color);
        }
        
        .status-indicator.inactive {
            background-color: var(--text-secondary);
        }
        
        /* Responsive Design */
        @media (max-width: 480px) {
            .phone-container { 
                width: 100%; 
                height: 100vh; 
                border-radius: 0; 
            }
            body { 
                padding: 0; 
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-logo">BGT PRO</div>
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingText">Memuat aplikasi...</div>
        <!-- Tombol Cancel Loading Jika Macet -->
        <button class="cancel-loading-btn" id="cancelLoadingBtn" onclick="app.forceCancelLoading()">
            Batal / Muat Ulang
        </button>
    </div>

    <!-- Install Prompt -->
    <div class="install-prompt" id="installPrompt">
        <div class="install-prompt-icon">
            <i class="fas fa-download"></i>
        </div>
        <div class="install-prompt-content">
            <div class="install-prompt-title">Install Aplikasi</div>
            <div class="install-prompt-text">Install BGT PRO untuk pengalaman lebih baik</div>
        </div>
        <div class="install-prompt-buttons">
            <button class="install-prompt-btn install-prompt-btn-dismiss" onclick="app.dismissInstallPrompt()">Tidak</button>
            <button class="install-prompt-btn install-prompt-btn-install" onclick="app.installApp()">Install</button>
        </div>
    </div>

    <div class="phone-container">
        <div class="app-container">
            <!-- Konten Utama (Home, dll) -->
            <div id="main-content">
                <div class="header">
                    <div class="header-left">
                        <img src="https://picsum.photos/seed/default-user/100/100.jpg" alt="Profile" class="profile-photo" id="headerProfilePhoto" onclick="app.showProfile()">
                    </div>
                    <div class="logo">BGT PRO</div>
                    <div class="header-right">
                        <button class="notification-btn" onclick="app.showNotifications()">
                            <i class="fas fa-bell"></i>
                            <div class="notification-badge" id="notificationBadge" style="display: none;">3</div>
                        </button>
                        <button class="theme-toggle" onclick="app.toggleTheme()" title="Ganti Tema">
                            <i class="fas fa-moon" id="themeIcon"></i>
                        </button>
                        <button class="menu-btn" onclick="app.toggleMenu()">
                            <i class="fas fa-bars"></i>
                        </button>
                    </div>
                </div>
                
                <div class="event-section fade-in-up" style="animation-delay: 0.05s;" id="eventSection">
                    <div class="event-badge">Upcoming</div>
                    <img alt="Event" class="event-image" id="eventImage" style="display: none;">
                    <div class="click-indicator">
                        <i class="fas fa-info-circle"></i>
                    </div>
                </div>
                
                <div class="admin-carousel fade-in-up">
                    <div class="carousel-container" id="adminCarousel">
                        <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-secondary); position: relative; z-index: 3;">
                            <div style="text-align: center;">
                                <i class="fas fa-images" style="font-size: 32px; margin-bottom: 10px; opacity: 0.5;"></i>
                                <p>Memuat banner...</p>
                            </div>
                        </div>
                    </div>
                    <div class="carousel-indicators" id="carouselIndicators"></div>
                </div>
                
                <!-- Transport Cards Section -->
                <div class="transport-section fade-in-up" style="animation-delay: 0.1s;">
                    <div class="transport-section-title">
                        <i class="fas fa-car"></i>
                        <span>Transport Online</span>
                    </div>
                    <div class="transport-cards">
                        <div class="transport-card" onclick="app.openTransportApp('grab')">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/8/86/Grab_Logo_2022.svg/2560px-Grab_Logo_2022.svg.png" alt="Grab" class="transport-logo">
                            <div class="transport-name">Grab</div>
                            <div class="transport-desc">Ojek & Makanan</div>
                        </div>
                        <div class="transport-card" onclick="app.openTransportApp('gojek')">
                            <img src="https://upload.wikimedia.org/wikipedia/id/thumb/c/c4/Gojek_logo_2019.svg/2560px-Gojek_logo_2019.svg.png" alt="Gojek" class="transport-logo">
                            <div class="transport-name">Gojek</div>
                            <div class="transport-desc">Ojek & Makanan</div>
                        </div>
                        <div class="transport-card" onclick="app.openTransportApp('maxim')">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/69/Maxim_logo.svg/2560px-Maxim_logo.svg.png" alt="Maxim" class="transport-logo">
                            <div class="transport-name">Maxim</div>
                            <div class="transport-desc">Ojek Online</div>
                        </div>
                        <div class="transport-card" onclick="app.openTransportApp('indriver')">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/1b/InDriver_logo.svg/2560px-InDriver_logo.svg.png" alt="inDriver" class="transport-logo">
                            <div class="transport-name">inDriver</div>
                            <div class="transport-desc">Ojek & Car</div>
                        </div>
                    </div>
                </div>
                
                <div style="height: 60px;"></div>
            </div>

            <!-- Halaman Profil -->
            <div id="profile-page" class="page-view">
                <div class="profile-header">
                    <h2>Profil Saya</h2>
                    <button class="back-btn" onclick="app.showMainContent()">
                        <i class="fas fa-arrow-left"></i> Kembali
                    </button>
                </div>
                <div class="profile-content">
                    <img src="https://picsum.photos/seed/default-user/100/100.jpg" alt="Profile Avatar" class="profile-avatar" id="profilePageAvatar">
                    <div class="profile-info">
                        <h3 id="profilePageUsername">Loading...</h3>
                        <p id="profilePageEmail">Loading...</p>
                    </div>
                    <div class="profile-stats">
                        <div class="stat-item">
                            <div class="stat-value" id="profilePageRole">-</div>
                            <div class="stat-label">Role</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">Aktif</div>
                            <div class="stat-label">Status</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Halaman Kas -->
            <div id="kas-page" class="page-view">
                <div class="profile-header">
                    <h2>Manajemen Kas</h2>
                    <button class="back-btn" onclick="app.showMainContent()">
                        <i class="fas fa-arrow-left"></i> Kembali
                    </button>
                </div>
                <div id="kasContent">
                    <div class="empty-state">
                        <i class="fas fa-wallet"></i>
                        <h3>Memuat Data Kas</h3>
                        <p>Mengambil informasi kas dari server...</p>
                    </div>
                </div>
            </div>

            <!-- Halaman Peta -->
            <div id="peta-page" class="page-view">
                <div class="profile-header">
                    <h2>Peta Lokasi Anggota</h2>
                    <button class="back-btn" onclick="app.showMainContent()">
                        <i class="fas fa-arrow-left"></i> Kembali
                    </button>
                </div>
                <div id="petaContent">
                    <div class="empty-state">
                        <i class="fas fa-map-marked-alt"></i>
                        <h3>Memuat Peta</h3>
                        <p>Mengambil data lokasi dari server...</p>
                    </div>
                </div>
            </div>

            <!-- Halaman Explorer -->
            <div id="explorer-page" class="page-view">
                <div class="profile-header">
                    <h2>Explorer</h2>
                    <button class="back-btn" onclick="app.showMainContent()">
                        <i class="fas fa-arrow-left"></i> Kembali
                    </button>
                </div>
                <div id="explorerContent">
                    <div class="empty-state">
                        <i class="fas fa-compass"></i>
                        <h3>Memuat Explorer</h3>
                        <p>Mengambil data explorer dari server...</p>
                    </div>
                </div>
            </div>

            <!-- Halaman Activity -->
            <div id="activity-page" class="page-view">
                <div class="profile-header">
                    <h2>Aktivitas</h2>
                    <button class="back-btn" onclick="app.showMainContent()">
                        <i class="fas fa-arrow-left"></i> Kembali
                    </button>
                </div>
                <div id="activityContent">
                    <div class="empty-state">
                        <i class="fas fa-chart-line"></i>
                        <h3>Memuat Aktivitas</h3>
                        <p>Mengambil data aktivitas dari server...</p>
                    </div>
                </div>
            </div>

            <!-- Halaman Pengaturan -->
            <div id="pengaturan-page" class="page-view">
                <div class="profile-header">
                    <h2>Pengaturan</h2>
                    <button class="back-btn" onclick="app.showMainContent()">
                        <i class="fas fa-arrow-left"></i> Kembali
                    </button>
                </div>
                <div id="pengaturanContent">
                    <div class="empty-state">
                        <i class="fas fa-cog"></i>
                        <h3>Memuat Pengaturan</h3>
                        <p>Mengambil data pengaturan dari server...</p>
                    </div>
                </div>
            </div>

            <!-- Halaman Bantuan -->
            <div id="bantuan-page" class="page-view">
                <div class="profile-header">
                    <h2>Bantuan</h2>
                    <button class="back-btn" onclick="app.showMainContent()">
                        <i class="fas fa-arrow-left"></i> Kembali
                    </button>
                </div>
                <div id="bantuanContent">
                    <div class="empty-state">
                        <i class="fas fa-question-circle"></i>
                        <h3>Memuat Bantuan</h3>
                        <p>Mengambil informasi bantuan dari server...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- UPDATE: BOTTOM NAV (Perubahan Menu) -->
        <div class="bottom-nav">
            <div class="nav-item active" onclick="app.handleNavClick(this, 'Home')">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </div>
            <!-- Pindah ke sini: Peta (mep) -->
            <div class="nav-item" onclick="app.handleNavClick(this, 'Peta')">
                <i class="fas fa-map-marked-alt"></i>
                <span>Peta</span>
            </div>
            <div class="nav-item" onclick="app.handleNavClick(this, 'Activity')">
                <i class="fas fa-chart-line"></i>
                <span>Activity</span>
            </div>
            <!-- Pindah ke sini: Pesan (ganti Profil) -->
            <div class="nav-item" onclick="app.handleNavClick(this, 'Pesan')">
                <i class="fas fa-comment-dots"></i>
                <span>Pesan</span>
            </div>
        </div>

        <!-- UPDATE: SIDE MENU (Perubahan Menu) -->
        <div class="side-menu" id="sideMenu">
            <div class="side-menu-header">
                <div class="logo">Menu</div>
                <button class="close-menu" onclick="app.toggleMenu()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="side-menu-content">
                <div class="menu-item" onclick="app.handleMenuClick('Kas')">
                    <i class="fas fa-wallet"></i><span>Kas</span>
                </div>
                <!-- Pindah ke sini: Explore -->
                <div class="menu-item" onclick="app.handleMenuClick('Explore')">
                    <i class="fas fa-compass"></i><span>Explore</span>
                </div>
                <!-- Pesan Dihapus dari sini karena pindah ke bawah -->
                <div class="menu-item" onclick="app.handleMenuClick('Pengaturan')">
                    <i class="fas fa-cog"></i><span>Pengaturan</span>
                </div>
                <div class="menu-item" onclick="app.handleMenuClick('Bantuan')">
                    <i class="fas fa-question-circle"></i><span>Bantuan</span>
                </div>
                <div class="menu-item" onclick="app.logout()">
                    <i class="fas fa-sign-out-alt"></i><span>Keluar</span>
                </div>
            </div>
        </div>

        <div class="overlay" id="overlay" onclick="app.toggleMenu()"></div>

        <div class="modal" id="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title" id="modalTitle">Detail</div>
                    <button class="modal-close" onclick="app.closeModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <img id="modalImage" class="modal-image" src="" alt="" style="display:none;">
                    <div class="modal-details">
                        <h3 id="modalDetailTitle"></h3>
                        <p id="modalDetailDesc"></p>
                        <button class="modal-action" onclick="app.handleModalAction()">Tutup</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Overlay Disrupsi -->
        <div id="disruption-overlay">
            <h1>DISRUPTED!</h1>
            <img src="512B.png" alt="Disrupted">
        </div>

        <div class="realtime-indicator" id="realtimeIndicator"></div>
        
        <div class="permission-guide" id="permissionGuide">
            <h4><i class="fas fa-exclamation-triangle"></i> Konfigurasi Izin Firebase</h4>
            <p>Untuk mengatasi error "Missing or insufficient permissions", ikuti langkah-langkah berikut:</p>
            <ol>
                <li>Buka <a href="https://console.firebase.google.com/" target="_blank" style="color: white; text-decoration: underline;">Firebase Console</a></li>
                <li>Pilih project <strong>bali-global-trans</strong></li>
                <li>Buka menu <strong>Firestore Database</strong></li>
                <li>Klik tab <strong>Rules</strong></li>
                <li>Ganti kode aturan dengan kode di bawah ini:</li>
            </ol>
            <code id="rulesCode">rules_version = '2';<br>service cloud.firestore {<br>&nbsp;&nbsp;match /databases/{database}/documents {<br>&nbsp;&nbsp;&nbsp;&nbsp;allow read: if request.auth != null;<br>&nbsp;&nbsp;&nbsp;&nbsp;allow write: if request.auth != null;<br>&nbsp;&nbsp;}<br>}</code>
            <button class="copy-btn" onclick="app.copyRulesCode()">Salin Kode</button>
            <p style="margin-top: 10px;">Klik <strong>Publish</strong> setelah mengganti kode aturan.</p>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast" class="toast"></div>

    <script>
        // Main Application Object
        const app = {
            // Configuration
            config: {
                firebase: {
                    apiKey: "AIzaSyCahZIFKFXMCokFNxCpFokNSVtKzN4llus",
                    authDomain: "cedar-setup-425414-d7.firebaseapp.com",
                    databaseURL: "https://cedar-setup-425414-d7-default-rtdb.firebaseio.com",
                    projectId: "cedar-setup-425414-d7",
                    storageBucket: "cedar-setup-425414-d7.firebasestorage.app",
                    messagingSenderId: "723545991983",
                    appId: "1:723545991983:web:379548d2b425a502a60fda",
                    measurementId: "G-FPL6PF3KWJ"
                },
                cacheName: 'bgt-pro-v1',
                deferredPrompt: null
            },
            
            // Transport Apps Configuration
            transportApps: {
                grab: {
                    name: 'Grab',
                    package: 'com.grabtaxi.passenger',
                    url: 'grab://'
                },
                gojek: {
                    name: 'Gojek',
                    package: 'com.gojek.app',
                    url: 'gojek://'
                },
                maxim: {
                    name: 'Maxim',
                    package: 'com.maxim.driver',
                    url: 'maxim://'
                },
                indriver: {
                    name: 'inDriver',
                    package: 'com.indriver',
                    url: 'indriver://'
                }
            },
            
            // State
            state: {
                currentSlide: 0,
                firebaseErrorShown: false,
                indexErrorShown: false,
                currentUserData: null,
                isExplicitLogout: false,
                authInitialized: false,
                sessionRestoreAttempted: false,
                theme: localStorage.getItem('bgt-pro-theme') || 'light',
                map: null,
                userMarker: null,
                locationMarkers: {},
                locationListener: null,
                isGuestMode: false
            },
            
            // Initialize Application
            init() {
                this.initTheme();
                this.initFirebase();
                this.initPWA();
                this.initServiceWorker();
                this.initEventListeners();
                this.showLoadingScreen('Memeriksa koneksi...');
                
                setTimeout(() => {
                    const cancelBtn = document.getElementById('cancelLoadingBtn');
                    if (!this.state.authInitialized && cancelBtn) {
                        cancelBtn.style.display = 'block';
                        document.getElementById('loadingText').textContent = "Memerlukan waktu lebih lama...";
                    }
                }, 3000);

                setTimeout(() => {
                    if (!this.state.authInitialized) {
                        console.error("Auth initialization timeout");
                        this.showToast("Koneksi ke server terputus. Masuk Mode Tamu.", "warning");
                        this.enterGuestMode();
                    }
                }, 10000);
            },
            
            forceCancelLoading() {
                this.showToast("Loading dibatalkan. Masuk Mode Tamu.", "warning");
                this.enterGuestMode();
            },
            
            enterGuestMode() {
                this.hideLoadingScreen();
                this.state.isGuestMode = true;
                this.state.authInitialized = true;
                
                this.state.currentUserData = { 
                    username: 'Guest User', 
                    email: 'guest@bgtpro.com', 
                    role: 'Guest',
                    profilePicUrl: 'https://picsum.photos/seed/guest/100/100.jpg' 
                };
                
                this.updateUserProfileUI(this.state.currentUserData);
                this.loadAppContent();
                this.animateAppEntrance();
            },
            
            initTheme() {
                document.body.setAttribute('data-theme', this.state.theme);
                this.updateThemeIcon();
            },
            
            toggleTheme() {
                this.state.theme = this.state.theme === 'light' ? 'dark' : 'light';
                document.body.setAttribute('data-theme', this.state.theme);
                localStorage.setItem('bgt-pro-theme', this.state.theme);
                this.updateThemeIcon();
                this.showToast(`Tema ${this.state.theme === 'light' ? 'Terang' : 'Gelap'} diaktifkan`, 'success');
            },
            
            updateThemeIcon() {
                const themeIcon = document.getElementById('themeIcon');
                if (themeIcon) {
                    themeIcon.className = this.state.theme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
                }
            },
            
            initFirebase() {
                try {
                    if (typeof firebase === 'undefined') {
                        throw new Error("Library Firebase tidak dapat dimuat. Periksa koneksi internet Anda.");
                    }

                    firebase.initializeApp(this.config.firebase);
                    this.db = firebase.firestore();
                    this.auth = firebase.auth();
                    this.storage = firebase.storage();
                    
                    console.log("Firebase initialized successfully");
                    
                    // Set persistence to LOCAL untuk menyimpan sesi pengguna
                    this.auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
                        .then(() => {
                            console.log("Firebase auth persistence set to LOCAL");
                            
                            // Periksa apakah ada sesi yang tersimpan
                            const hasSession = localStorage.getItem('bgtProSession') === 'active';
                            
                            if (hasSession) {
                                console.log("Found existing session, attempting to restore...");
                                this.showLoadingScreen('Memulihkan sesi...');
                            }
                        })
                        .catch((error) => {
                            console.error("Error setting auth persistence:", error);
                        });
                    
                    this.auth.onAuthStateChanged(user => {
                        this.handleAuthStateChange(user);
                    });
                    
                } catch (error) {
                    console.error("CRITICAL: Gagal inisialisasi Firebase", error);
                    this.showToast("Gagal memuat Firebase: " + error.message, "error");
                    setTimeout(() => this.enterGuestMode(), 2000);
                }
            },
            
            handleAuthStateChange(user) {
                this.state.authInitialized = true;
                this.hideLoadingScreen();
                
                try {
                    if (user) {
                        console.log("User logged in:", user.uid);
                        this.state.isExplicitLogout = false;
                        this.state.sessionRestoreAttempted = false;
                        this.state.isGuestMode = false;
                        
                        // Simpan status sesi aktif di localStorage
                        localStorage.setItem('bgtProSession', 'active');
                        
                        this.loadUserData(user.uid);
                        this.loadAppContent();
                        this.setupRealtimeListeners();
                        this.animateAppEntrance();
                    } else {
                        console.log("No user logged in.");
                        
                        // Periksa apakah pengguna secara eksplisit logout
                        if (this.state.isExplicitLogout) {
                            console.log("User explicitly logged out. Session cleared.");
                            return;
                        }
                        
                        // Periksa apakah ada sesi yang tersimpan
                        const hasSession = localStorage.getItem('bgtProSession') === 'active';
                        
                        if (hasSession && !this.state.sessionRestoreAttempted) {
                            this.state.sessionRestoreAttempted = true;
                            console.log("Session found but user is null. Entering Guest Mode to prevent loop.");
                            localStorage.removeItem('bgtProSession');
                            this.enterGuestMode();
                        } else if (!hasSession) {
                            console.log("No session found. Entering Guest Mode.");
                            this.enterGuestMode();
                        }
                    }
                } catch (error) {
                    console.error("Error in handleAuthStateChange:", error);
                    this.showToast("Terjadi kesalahan otentikasi", "error");
                    this.hideLoadingScreen();
                }
            },
            
            async loadUserData(userId) {
                try {
                    const doc = await this.db.collection('users').doc(userId).get();
                    if (doc.exists) {
                        this.state.currentUserData = doc.data();
                        this.updateUserProfileUI(this.state.currentUserData);
                        
                        this.db.collection('users').doc(userId).onSnapshot(doc => {
                            const userData = doc.data();
                            if (userData && userData.pmStatus === 'disrupted') {
                                this.triggerDisruption();
                            } else {
                                this.stopDisruption();
                            }
                        });
                    } else {
                        console.error("User document not found!");
                        this.state.currentUserData = { 
                            username: 'Anggota', 
                            email: this.auth.currentUser.email, 
                            profilePicUrl: 'https://picsum.photos/seed/default-user/100/100.jpg' 
                        };
                        this.updateUserProfileUI(this.state.currentUserData);
                    }
                } catch (error) {
                    console.error("Error getting user document:", error);
                    if (!this.state.isGuestMode) {
                        this.handleFirebaseError(error);
                    }
                }
            },
            
            updateUserProfileUI(userData) {
                const imageUrl = userData.profilePicUrl || 'https://picsum.photos/seed/default-user/100/100.jpg';
                
                const headerProfilePhoto = document.getElementById('headerProfilePhoto');
                if (headerProfilePhoto) {
                    headerProfilePhoto.src = imageUrl;
                    headerProfilePhoto.onerror = () => {
                        headerProfilePhoto.src = 'https://picsum.photos/seed/default-user/100/100.jpg';
                    };
                }
                
                const profilePageAvatar = document.getElementById('profilePageAvatar');
                const profilePageUsername = document.getElementById('profilePageUsername');
                const profilePageEmail = document.getElementById('profilePageEmail');
                const profilePageRole = document.getElementById('profilePageRole');
                
                if (profilePageAvatar) {
                    profilePageAvatar.src = imageUrl;
                    profilePageAvatar.onerror = () => {
                        profilePageAvatar.src = 'https://picsum.photos/seed/default-user/100/100.jpg';
                    };
                }
                
                if (profilePageUsername) profilePageUsername.textContent = userData.username || 'Tidak ada username';
                if (profilePageEmail) profilePageEmail.textContent = userData.email || 'Tidak ada email';
                if (profilePageRole) profilePageRole.textContent = userData.role || 'anggota';
            },
            
            loadAppContent() {
                this.loadEventsFromFirebase();
                this.loadBannersFromFirebase();
                this.loadKasData();
                this.loadPetaData();
                this.loadPengaturanData();
                this.loadBantuanData();
                this.loadExplorerData();
                this.loadActivityData();
            },
            
            openTransportApp(appName) {
                const app = this.transportApps[appName];
                if (!app) {
                    this.showToast('Aplikasi tidak tersedia', 'error');
                    return;
                }
                
                window.location.href = app.url;
                setTimeout(() => {
                    window.location.href = `intent://${app.package}#Intent;package=${app.package};scheme=${app.url.replace('://', '')};end`;
                }, 1000);
                
                setTimeout(() => {
                    window.open(`https://play.google.com/store/apps/details?id=${app.package}`, '_blank');
                }, 2000);
                
                this.showToast(`Membuka ${app.name}...`, 'info');
            },
            
            async loadKasData() {
                const kasContent = document.getElementById('kasContent');
                
                if (this.state.isGuestMode) {
                    kasContent.innerHTML = `
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-wallet"></i>
                                    Total Kas (Demo)
                                </div>
                                <div style="font-size: 20px; font-weight: 700; color: var(--success-color);">
                                    Rp 1.500.000
                                </div>
                            </div>
                            <div class="card-body">
                                <p>Data ini adalah simulasi karena Anda berada dalam Mode Tamu.</p>
                            </div>
                        </div>
                    `;
                    return;
                }

                try {
                    const snapshot = await this.db.collection('kas').get();
                    let totalKas = 0;
                    const transactions = [];
                    
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        totalKas += data.amount || 0;
                        transactions.push({
                            description: data.description || 'Transaksi',
                            amount: data.amount || 0,
                            timestamp: data.timestamp ? data.timestamp.toDate() : new Date()
                        });
                    });
                    
                    kasContent.innerHTML = `
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-wallet"></i>
                                    Total Kas
                                </div>
                                <div style="font-size: 20px; font-weight: 700; color: var(--success-color);">
                                    Rp ${totalKas.toLocaleString('id-ID')}
                                </div>
                            </div>
                            <div class="card-body">
                                <p>Total kas komunitas saat ini</p>
                                <button class="btn btn-primary btn-block" style="margin-top: 15px;" onclick="app.showAddTransactionModal()">
                                    <i class="fas fa-plus"></i> Tambah Transaksi
                                </button>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-history"></i>
                                    Transaksi Terakhir
                                </div>
                            </div>
                            <div class="list-group">
                                ${transactions.slice(0, 5).map(t => `
                                    <div class="list-item">
                                        <div class="list-item-title">${t.description}</div>
                                        <div class="list-item-subtitle">Rp ${Math.abs(t.amount).toLocaleString('id-ID')} - ${t.timestamp.toLocaleDateString('id-ID')}</div>
                                    </div>
                                `).join('')}
                                ${transactions.length === 0 ? '<div class="list-item"><div class="list-item-subtitle">Belum ada transaksi</div></div>' : ''}
                            </div>
                        </div>
                    `;
                } catch (error) {
                    console.error("Error loading kas data:", error);
                    kasContent.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-exclamation-triangle"></i>
                            <h3>Gagal Memuat Data</h3>
                            <p>Terjadi kesalahan saat mengambil data kas</p>
                        </div>
                    `;
                }
            },
            
            async loadPetaData() {
                const petaContent = document.getElementById('petaContent');
                
                petaContent.innerHTML = `
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-map-marked-alt"></i>
                                Lokasi Real-time
                            </div>
                        </div>
                        <div class="card-body" style="height: 300px; position: relative;">
                            <div id="map" style="height: 100%; border-radius: 8px;"></div>
                            <div class="map-activity-indicator" id="mapActivityIndicator">
                                <i class="fas fa-circle"></i>
                                <span>Real-time</span>
                            </div>
                            <div class="map-stats">
                                <span id="memberCount">0</span> anggota aktif
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-users"></i>
                                Anggota Terdekat
                            </div>
                        </div>
                        <div class="list-group" id="locationList">
                            <div class="list-item">
                                <div class="list-item-subtitle">Memuat data lokasi...</div>
                            </div>
                        </div>
                    </div>
                `;
                
                setTimeout(() => {
                    this.initializeMap();
                    this.loadUserLocations();
                }, 100);
            },
            
            initializeMap() {
                if (!document.getElementById('map')) return;
                
                try {
                    this.map = L.map('map').setView([-6.2088, 106.8456], 13);
                    
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                    }).addTo(this.map);
                    
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(
                            (position) => {
                                const { latitude, longitude } = position.coords;
                                this.map.setView([latitude, longitude], 15);
                                
                                const userIcon = L.divIcon({
                                    className: 'user-location-marker',
                                    html: '<div class="map-dot user-dot blinking"></div>',
                                    iconSize: [12, 12],
                                    iconAnchor: [6, 6]
                                });
                                
                                this.userMarker = L.marker([latitude, longitude], { icon: userIcon })
                                    .addTo(this.map)
                                    .bindPopup('Lokasi Anda')
                                    .openPopup();
                            },
                            (error) => {
                                console.error("Error getting location:", error);
                            }
                        );
                    }
                } catch (error) {
                    console.error("Map initialization error:", error);
                }
            },
            
            async loadUserLocations() {
                const locationList = document.getElementById('locationList');
                
                if (this.state.isGuestMode) {
                    locationList.innerHTML = `
                        <div class="list-item">
                            <div class="list-item-subtitle">Data Lokasi tidak tersedia dalam Mode Tamu.</div>
                        </div>
                    `;
                    return;
                }

                try {
                    const snapshot = await this.db.collection('user_locations').limit(10).get();
                    
                    if (snapshot.empty) {
                        locationList.innerHTML = '<div class="list-item"><div class="list-item-subtitle">Tidak ada anggota yang online</div></div>';
                        return;
                    }
                    
                    const locations = [];
                    const markers = {};
                    let activeCount = 0;
                    
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const userId = doc.id;
                        
                        const now = new Date();
                        const lastSeen = data.lastSeen ? data.lastSeen.toDate() : new Date();
                        const timeDiff = now - lastSeen;
                        const isActive = timeDiff < 120000;
                        
                        if (isActive) activeCount++;
                        
                        locations.push({
                            id: userId,
                            username: data.username || 'Anggota',
                            latitude: data.latitude,
                            longitude: data.longitude,
                            lastSeen: lastSeen,
                            isActive: isActive
                        });
                    });
                    
                    const memberCountElement = document.getElementById('memberCount');
                    if (memberCountElement) {
                        memberCountElement.textContent = activeCount;
                    }
                    
                    locationList.innerHTML = locations.map(loc => `
                        <div class="list-item">
                            <div style="display: flex; align-items: center;">
                                <div class="status-indicator ${loc.isActive ? 'active' : 'inactive'}"></div>
                                <div class="list-item-title">${loc.username}</div>
                            </div>
                            <div class="list-item-subtitle">Terakhir seen: ${loc.lastSeen.toLocaleString('id-ID')}</div>
                        </div>
                    `).join('');
                    
                    locations.forEach(loc => {
                        if (this.map && loc.latitude && loc.longitude) {
                            const userIcon = L.divIcon({
                                className: 'user-location-marker',
                                html: `<div class="map-dot ${loc.isActive ? 'active-dot' : 'inactive-dot'} ${loc.isActive ? 'blinking' : ''}"></div>`,
                                iconSize: [10, 10],
                                iconAnchor: [5, 5]
                            });
                            
                            const marker = L.marker([loc.latitude, loc.longitude], { icon: userIcon })
                                .addTo(this.map)
                                .bindPopup(loc.username);
                            
                            markers[loc.id] = marker;
                        }
                    });
                    
                    this.locationMarkers = markers;
                    this.setupLocationListener();
                    
                } catch (error) {
                    console.error("Error loading user locations:", error);
                    locationList.innerHTML = '<div class="list-item"><div class="list-item-subtitle">Gagal memuat lokasi</div></div>';
                }
            },
            
            setupLocationListener() {
                if (this.locationListener) {
                    this.locationListener(); 
                }
                
                const mapActivityIndicator = document.getElementById('mapActivityIndicator');
                if (mapActivityIndicator) {
                    mapActivityIndicator.classList.add('updating');
                }
                
                this.locationListener = this.db.collection('user_locations')
                    .onSnapshot(snapshot => {
                        const now = new Date();
                        const updatedMarkers = {};
                        let activeCount = 0;
                        
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            const userId = doc.id;
                            
                            const lastSeen = data.lastSeen ? data.lastSeen.toDate() : new Date();
                            const timeDiff = now - lastSeen;
                            const isActive = timeDiff < 120000;
                            
                            if (isActive) activeCount++;
                            
                            if (this.locationMarkers[userId]) {
                                this.locationMarkers[userId].setLatLng([data.latitude, data.longitude]);
                                
                                const markerElement = this.locationMarkers[userId].getElement();
                                const mapDot = markerElement.querySelector('.map-dot');
                                if (mapDot) {
                                    mapDot.className = `map-dot ${isActive ? 'active-dot' : 'inactive-dot'} ${isActive ? 'blinking' : ''}`;
                                }
                            } else if (data.latitude && data.longitude) {
                                const userIcon = L.divIcon({
                                    className: 'user-location-marker',
                                    html: `<div class="map-dot ${isActive ? 'active-dot' : 'inactive-dot'} ${isActive ? 'blinking' : ''}"></div>`,
                                    iconSize: [10, 10],
                                    iconAnchor: [5, 5]
                                });
                                
                                const marker = L.marker([data.latitude, data.longitude], { icon: userIcon })
                                    .addTo(this.map)
                                    .bindPopup(data.username || 'Anggota');
                                
                                this.locationMarkers[userId] = marker;
                            }
                            
                            updatedMarkers[userId] = true;
                        });
                        
                        Object.keys(this.locationMarkers).forEach(userId => {
                            if (!updatedMarkers[userId]) {
                                this.map.removeLayer(this.locationMarkers[userId]);
                                delete this.locationMarkers[userId];
                            }
                        });
                        
                        const memberCountElement = document.getElementById('memberCount');
                        if (memberCountElement) {
                            memberCountElement.textContent = activeCount;
                        }
                        
                        this.updateLocationList();
                        
                        setTimeout(() => {
                            if (mapActivityIndicator) {
                                mapActivityIndicator.classList.remove('updating');
                            }
                        }, 500);
                    }, error => {
                        console.error("Error in location listener:", error);
                        if (mapActivityIndicator) {
                            mapActivityIndicator.classList.remove('updating');
                        }
                    });
            },
            
            async updateLocationList() {
                const locationList = document.getElementById('locationList');
                if (!locationList) return;
                
                try {
                    const snapshot = await this.db.collection('user_locations').limit(10).get();
                    
                    if (snapshot.empty) {
                        locationList.innerHTML = '<div class="list-item"><div class="list-item-subtitle">Tidak ada anggota yang online</div></div>';
                        return;
                    }
                    
                    const locations = [];
                    
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const userId = doc.id;
                        
                        const now = new Date();
                        const lastSeen = data.lastSeen ? data.lastSeen.toDate() : new Date();
                        const timeDiff = now - lastSeen;
                        const isActive = timeDiff < 120000;
                        
                        locations.push({
                            id: userId,
                            username: data.username || 'Anggota',
                            latitude: data.latitude,
                            longitude: data.longitude,
                            lastSeen: lastSeen,
                            isActive: isActive
                        });
                    });
                    
                    locationList.innerHTML = locations.map(loc => `
                        <div class="list-item">
                            <div style="display: flex; align-items: center;">
                                <div class="status-indicator ${loc.isActive ? 'active' : 'inactive'}"></div>
                                <div class="list-item-title">${loc.username}</div>
                            </div>
                            <div class="list-item-subtitle">Terakhir seen: ${loc.lastSeen.toLocaleString('id-ID')}</div>
                        </div>
                    `).join('');
                    
                } catch (error) {
                    console.error("Error updating location list:", error);
                }
            },
            
            async loadPengaturanData() {
                const pengaturanContent = document.getElementById('pengaturanContent');
                const user = this.auth.currentUser;
                
                if (this.state.isGuestMode) {
                    pengaturanContent.innerHTML = `
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-user-cog"></i>
                                    Mode Tamu
                                </div>
                            </div>
                            <div class="card-body">
                                <p>Anda sedang berada dalam Mode Tamu. Beberapa fitur mungkin terbatas.</p>
                                <button class="btn btn-primary btn-block" style="margin-top: 15px;" onclick="window.location.reload()">
                                    <i class="fas fa-sync"></i> Coba Login Kembali
                                </button>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                if (!user) {
                    pengaturanContent.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-exclamation-triangle"></i>
                            <h3>Belum Login</h3>
                            <p>Silakan login untuk mengakses pengaturan</p>
                        </div>
                    `;
                    return;
                }
                
                try {
                    const userDoc = await this.db.collection('users').doc(user.uid).get();
                    const userData = userDoc.exists ? userDoc.data() : {};
                    
                    pengaturanContent.innerHTML = `
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-bell"></i>
                                    Notifikasi
                                </div>
                            </div>
                            <div class="card-body">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <span>Event</span>
                                    <label style="position: relative; display: inline-block; width: 50px; height: 24px;">
                                        <input type="checkbox" ${userData.notifications?.event !== false ? 'checked' : ''} onchange="app.updateNotificationSetting('event', this.checked)" style="opacity: 0; width: 0; height: 0;">
                                        <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: ${userData.notifications?.event !== false ? 'var(--primary-color)' : '#ccc'}; transition: 0.3s; border-radius: 24px;">
                                            <span style="position: absolute; content: ''; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: 0.3s; border-radius: 50%; transform: translateX(${userData.notifications?.event !== false ? '26' : '0'}px);"></span>
                                        </span>
                                    </label>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span>Pesan</span>
                                    <label style="position: relative; display: inline-block; width: 50px; height: 24px;">
                                        <input type="checkbox" ${userData.notifications?.message === true ? 'checked' : ''} onchange="app.updateNotificationSetting('message', this.checked)" style="opacity: 0; width: 0; height: 0;">
                                        <span style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: ${userData.notifications?.message === true ? 'var(--primary-color)' : '#ccc'}; transition: 0.3s; border-radius: 24px;">
                                            <span style="position: absolute; content: ''; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: 0.3s; border-radius: 50%; transform: translateX(${userData.notifications?.message === true ? '26' : '0'}px);"></span>
                                        </span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-user-cog"></i>
                                    Akun
                                </div>
                            </div>
                            <div class="card-body">
                                <button class="btn btn-secondary btn-block" style="margin-bottom: 10px;" onclick="app.showChangePasswordModal()">
                                    <i class="fas fa-key"></i> Ganti Password
                                </button>
                                <button class="btn btn-danger btn-block" onclick="app.logout()">
                                    <i class="fas fa-sign-out-alt"></i> Keluar
                                </button>
                            </div>
                        </div>
                    `;
                    
                } catch (error) {
                    console.error("Error loading pengaturan data:", error);
                    pengaturanContent.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-exclamation-triangle"></i>
                            <h3>Gagal Memuat Data</h3>
                            <p>Terjadi kesalahan saat mengambil data pengaturan</p>
                        </div>
                    `;
                }
            },
            
            async updateNotificationSetting(type, value) {
                if (this.state.isGuestMode) {
                    this.showToast("Tidak bisa mengubah pengaturan di Mode Tamu", "warning");
                    return;
                }

                try {
                    const user = this.auth.currentUser;
                    if (!user) return;
                    
                    await this.db.collection('users').doc(user.uid).update({
                        [`notifications.${type}`]: value
                    });
                    
                    this.showToast(`Pengaturan notifikasi ${type} diperbarui`, 'success');
                    
                    this.loadPengaturanData();
                    
                } catch (error) {
                    console.error("Error updating notification setting:", error);
                    this.showToast('Gagal memperbarui pengaturan', 'error');
                }
            },
            
            async loadBantuanData() {
                const bantuanContent = document.getElementById('bantuanContent');
                
                try {
                    const snapshot = await this.db.collection('help').get();
                    
                    let helpArticles = [];
                    snapshot.forEach(doc => {
                        helpArticles.push({ id: doc.id, ...doc.data() });
                    });
                    
                    if (helpArticles.length === 0) {
                        helpArticles = [
                            {
                                title: 'Tentang Aplikasi',
                                icon: 'fa-question-circle',
                                content: 'BGT PRO adalah aplikasi manajemen komunitas yang membantu mengelola kas, acara, dan komunikasi anggota.'
                            },
                            {
                                title: 'Panduan Penggunaan',
                                icon: 'fa-book',
                                content: 'Home: Menampilkan informasi utama\nKas: Mengelola transaksi kas\nProfil: Menampilkan informasi profil\nPeta: Menampilkan lokasi anggota\nPesan: Mengirim dan menerima pesan\nPengaturan: Mengatur preferensi aplikasi'
                            },
                            {
                                title: 'Hubungi Kami',
                                icon: 'fa-headset',
                                content: 'Email: support@bgtpro.com\nPhone: +62 812-3456-7890\nWebsite: www.bgtpro.com'
                            }
                        ];
                    }
                    
                    bantuanContent.innerHTML = helpArticles.map(article => `
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas ${article.icon}"></i>
                                    ${article.title}
                                </div>
                            </div>
                            <div class="card-body">
                                <p style="white-space: pre-line;">${article.content}</p>
                            </div>
                        </div>
                    `).join('');
                    
                } catch (error) {
                    console.error("Error loading bantuan data:", error);
                    bantuanContent.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-exclamation-triangle"></i>
                            <h3>Gagal Memuat Data</h3>
                            <p>Terjadi kesalahan saat mengambil data bantuan</p>
                        </div>
                    `;
                }
            },
            
            async loadExplorerData() {
                const explorerContent = document.getElementById('explorerContent');
                
                if (this.state.isGuestMode) {
                    explorerContent.innerHTML = `<div class="empty-state"><h3>Mode Tamu</h3><p>Data Explorer tidak tersedia.</p></div>`;
                    return;
                }

                try {
                    const trendingSnapshot = await this.db.collection('trending').get();
                    const trending = [];
                    trendingSnapshot.forEach(doc => {
                        trending.push({ id: doc.id, ...doc.data() });
                    });
                    
                    const recommendationsSnapshot = await this.db.collection('recommendations').get();
                    const recommendations = [];
                    recommendationsSnapshot.forEach(doc => {
                        recommendations.push({ id: doc.id, ...doc.data() });
                    });
                    
                    const defaultTrending = [
                        { title: 'Event Kopdar Malam Ini', subtitle: '235 orang tertarik' },
                        { title: 'Program Donasi', subtitle: 'Target Rp 5.000.000' },
                        { title: 'Turnamen Game Online', subtitle: 'Pendaftaran dibuka' }
                    ];
                    
                    const defaultRecommendations = [
                        { title: 'Grup Diskusi Teknologi', subtitle: 'Bergabung sekarang' },
                        { title: 'Kelas Online Gratis', subtitle: 'Minggu depan' }
                    ];
                    
                    explorerContent.innerHTML = `
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-compass"></i>
                                    Jelajahi Komunitas
                                </div>
                            </div>
                            <div class="card-body">
                                <p>Temukan konten menarik dari komunitas BGT PRO</p>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-fire"></i>
                                    Trending
                                </div>
                            </div>
                            <div class="list-group">
                                ${(trending.length > 0 ? trending : defaultTrending).map(item => `
                                    <div class="list-item">
                                        <div class="list-item-title">${item.title}</div>
                                        <div class="list-item-subtitle">${item.subtitle}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-star"></i>
                                    Rekomendasi
                                </div>
                            </div>
                            <div class="list-group">
                                ${(recommendations.length > 0 ? recommendations : defaultRecommendations).map(item => `
                                    <div class="list-item">
                                        <div class="list-item-title">${item.title}</div>
                                        <div class="list-item-subtitle">${item.subtitle}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                    
                } catch (error) {
                    console.error("Error loading explorer data:", error);
                    explorerContent.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-exclamation-triangle"></i>
                            <h3>Gagal Memuat Data</h3>
                            <p>Terjadi kesalahan saat mengambil data explorer</p>
                        </div>
                    `;
                }
            },
            
            async loadActivityData() {
                const activityContent = document.getElementById('activityContent');
                const user = this.auth.currentUser;
                
                if (this.state.isGuestMode) {
                    activityContent.innerHTML = `<div class="empty-state"><h3>Mode Tamu</h3><p>Data Aktivitas tidak tersedia.</p></div>`;
                    return;
                }

                if (!user) {
                    activityContent.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-exclamation-triangle"></i>
                            <h3>Belum Login</h3>
                            <p>Silakan login untuk melihat aktivitas</p>
                        </div>
                    `;
                    return;
                }
                
                try {
                    const statsDoc = await this.db.collection('user_stats').doc(user.uid).get();
                    const stats = statsDoc.exists ? statsDoc.data() : {};
                    
                    const activitiesSnapshot = await this.db.collection('user_activities')
                        .doc(user.uid)
                        .collection('activities')
                        .orderBy('timestamp', 'desc')
                        .limit(10)
                        .get();
                    
                    const activities = [];
                    activitiesSnapshot.forEach(doc => {
                        activities.push({ id: doc.id, ...doc.data() });
                    });
                    
                    const defaultStats = {
                        eventsAttended: 15,
                        totalContribution: 350000,
                        messagesSent: 28
                    };
                    
                    const defaultActivities = [
                        { title: 'Membayar iuran bulanan', time: '2 jam yang lalu' },
                        { title: 'Bergabung di event Kopdar', time: '1 hari yang lalu' },
                        { title: 'Mengirim pesan di grup', time: '2 hari yang lalu' },
                        { title: 'Memperbarui profil', time: '3 hari yang lalu' }
                    ];
                    
                    activityContent.innerHTML = `
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-chart-line"></i>
                                    Statistik Anda
                                </div>
                            </div>
                            <div class="card-body">
                                <div style="display: flex; justify-content: space-around; text-align: center;">
                                    <div>
                                        <div style="font-size: 24px; font-weight: 700; color: var(--primary-color);">${stats.eventsAttended || defaultStats.eventsAttended}</div>
                                        <div style="font-size: 12px; color: var(--text-secondary);">Event Diikuti</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 24px; font-weight: 700; color: var(--success-color);">Rp ${(stats.totalContribution || defaultStats.totalContribution).toLocaleString('id-ID')}</div>
                                        <div style="font-size: 12px; color: var(--text-secondary);">Total Kontribusi</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 24px; font-weight: 700; color: var(--warning-color);">${stats.messagesSent || defaultStats.messagesSent}</div>
                                        <div style="font-size: 12px; color: var(--text-secondary);">Pesan Terkirim</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-history"></i>
                                    Aktivitas Terbaru
                                </div>
                            </div>
                            <div class="list-group">
                                ${(activities.length > 0 ? activities.map(a => ({
                                    title: a.title || 'Aktivitas',
                                    time: a.timestamp ? this.formatTimeAgo(a.timestamp.toDate()) : 'Baru saja'
                                })) : defaultActivities).map(activity => `
                                    <div class="list-item">
                                        <div class="list-item-title">${activity.title}</div>
                                        <div class="list-item-subtitle">${activity.time}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-trophy"></i>
                                    Pencapaian
                                </div>
                            </div>
                            <div class="card-body">
                                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                    <div style="background: linear-gradient(135deg, #ffd700, #ffb347); color: white; padding: 8px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                                        <i class="fas fa-medal"></i> Anggota Aktif
                                    </div>
                                    <div style="background: linear-gradient(135deg, #c0c0c0, #808080); color: white; padding: 8px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                                        <i class="fas fa-hand-holding-usd"></i> Donatur
                                    </div>
                                    <div style="background: linear-gradient(135deg, #cd7f32, #8b4513); color: white; padding: 8px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">
                                        <i class="fas fa-comments"></i> Komunikator
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                } catch (error) {
                    console.error("Error loading activity data:", error);
                    activityContent.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-exclamation-triangle"></i>
                            <h3>Gagal Memuat Data</h3>
                            <p>Terjadi kesalahan saat mengambil data aktivitas</p>
                        </div>
                    `;
                }
            },
            
            formatTimeAgo(date) {
                const seconds = Math.floor((new Date() - date) / 1000);
                
                let interval = seconds / 31536000;
                if (interval > 1) return Math.floor(interval) + " tahun yang lalu";
                
                interval = seconds / 2592000;
                if (interval > 1) return Math.floor(interval) + " bulan yang lalu";
                
                interval = seconds / 86400;
                if (interval > 1) return Math.floor(interval) + " hari yang lalu";
                
                interval = seconds / 3600;
                if (interval > 1) return Math.floor(interval) + " jam yang lalu";
                
                interval = seconds / 60;
                if (interval > 1) return Math.floor(interval) + " menit yang lalu";
                
                return "Baru saja";
            },
            
            setupRealtimeListeners() {
                if (this.state.isGuestMode) return;

                this.db.collection('kas').onSnapshot((snapshot) => {
                    if (!snapshot.metadata.hasPendingWrites) {
                        this.updateBalanceFromFirebase();
                        this.showRealtimeIndicator();
                    }
                }, (error) => {
                    console.error("Error in kas listener:", error);
                    this.handleFirebaseError(error);
                });
                
                this.db.collection('promos').onSnapshot((snapshot) => {
                    if (!snapshot.metadata.hasPendingWrites) {
                        this.loadBannersFromFirebase();
                    }
                }, (error) => {
                    console.error("Error in promos listener:", error);
                    this.handleFirebaseError(error);
                });
                
                this.db.collection('events').onSnapshot((snapshot) => {
                    if (!snapshot.metadata.hasPendingWrites) {
                        this.loadEventsFromFirebase();
                    }
                }, (error) => {
                    console.error("Error in events listener:", error);
                    if (error.message.includes("The query requires an index")) {
                        this.handleIndexError(error);
                    } else {
                        this.handleFirebaseError(error);
                    }
                });
            },
            
            animateAppEntrance() {
                document.body.style.opacity = '0';
                document.body.style.transition = 'opacity 0.5s';
                setTimeout(() => { 
                    document.body.style.opacity = '1'; 
                }, 100);
            },
            
            initPWA() {
                window.addEventListener('beforeinstallprompt', (e) => {
                    e.preventDefault();
                    this.config.deferredPrompt = e;
                    this.showInstallPrompt();
                });
            },
            
            showInstallPrompt() {
                setTimeout(() => {
                    const installPrompt = document.getElementById('installPrompt');
                    if (installPrompt && this.config.deferredPrompt) {
                        installPrompt.style.display = 'flex';
                    }
                }, 3000);
            },
            
            dismissInstallPrompt() {
                const installPrompt = document.getElementById('installPrompt');
                installPrompt.style.display = 'none';
                localStorage.setItem('bgtProInstallDismissed', 'true');
            },
            
            async installApp() {
                const installPrompt = document.getElementById('installPrompt');
                installPrompt.style.display = 'none';
                
                if (!this.config.deferredPrompt) {
                    this.showToast('Install prompt tidak tersedia', 'warning');
                    return;
                }
                
                this.config.deferredPrompt.prompt();
                
                const { outcome } = await this.config.deferredPrompt.userChoice;
                console.log(`User response to the install prompt: ${outcome}`);
                
                this.config.deferredPrompt = null;
                
                if (outcome === 'accepted') {
                    localStorage.setItem('bgtProInstalled', 'true');
                    this.showToast('Aplikasi berhasil diinstall!', 'success');
                }
            },
            
            initServiceWorker() {
                if ('serviceWorker' in navigator) {
                    window.addEventListener('load', () => {
                        const swCode = `
                            self.addEventListener('install', event => {
                                console.log('Service Worker installing...');
                                self.skipWaiting();
                            });
                            
                            self.addEventListener('activate', event => {
                                console.log('Service Worker activating...');
                                event.waitUntil(clients.claim());
                            });
                            
                            self.addEventListener('fetch', event => {
                                event.respondWith(
                                    caches.match(event.request)
                                        .then(response => {
                                            return response || fetch(event.request);
                                        })
                                );
                            });
                        `;
                        
                        const blob = new Blob([swCode], { type: 'application/javascript' });
                        const swUrl = URL.createObjectURL(blob);
                        
                        navigator.serviceWorker.register(swUrl)
                            .then(registration => {
                                console.log('Service Worker registered with scope:', registration.scope);
                            })
                            .catch(error => {
                                console.error('Service Worker registration failed:', error);
                            });
                    });
                }
            },
            
            initEventListeners() {
                document.addEventListener('keydown', (event) => {
                    if (event.key === 'Escape') {
                        if (document.getElementById('sideMenu').classList.contains('active')) {
                            this.toggleMenu();
                        }
                        if (document.getElementById('modal').classList.contains('active')) {
                            this.closeModal();
                        }
                        if (document.getElementById('disruption-overlay').classList.contains('active')) {
                            this.stopDisruption();
                        }
                    }
                });
                
                window.onclick = (event) => { 
                    if (event.target === document.getElementById('modal')) this.closeModal();
                };
            },
            
            async loadEventsFromFirebase() {
                const eventTitleText = document.getElementById('eventTitleText');
                const eventTimeText = document.getElementById('eventTimeText');
                const eventImage = document.getElementById('eventImage');
                
                if (this.state.isGuestMode) {
                     this.currentEventData = {
                        name: 'EVENT DEMO',
                        description: 'Ini adalah contoh event yang muncul dalam Mode Tamu.',
                        time: 'Senin, 20:00 WIB',
                        imageUrl: 'https://picsum.photos/seed/event-demo/400/200.jpg'
                    };
                    eventImage.src = this.currentEventData.imageUrl;
                    eventImage.style.display = 'block';
                    eventSection.onclick = () => this.showEventModal();
                    return;
                }

                try {
                    const snapshot = await this.db.collection('events').where('status', '==', 'active').get();
                    
                    if (snapshot.empty) {
                        this.currentEventData = {
                            name: 'KOPDAR RUTIN',
                            description: 'Kopdar rutin mingguan komunitas BGT PRO',
                            time: 'Sabtu, 20:00 WIB',
                            imageUrl: null
                        };
                        eventImage.style.display = 'none';
                        return;
                    }
                    
                    const events = [];
                    snapshot.forEach(doc => {
                        const eventData = { id: doc.id, ...doc.data() };
                        if (eventData.startDate) {
                            events.push(eventData);
                        }
                    });
                    
                    events.sort((a, b) => {
                        const dateA = a.startDate.toDate();
                        const dateB = b.startDate.toDate();
                        return dateA - dateB;
                    });
                    
                    const event = events.length > 0 ? events[0] : null;
                    if (!event) {
                        this.currentEventData = {
                            name: 'KOPDAR RUTIN',
                            description: 'Kopdar rutin mingguan komunitas BGT PRO',
                            time: 'Sabtu, 20:00 WIB',
                            imageUrl: null
                        };
                        eventImage.style.display = 'none';
                        return;
                    }
                    
                    this.currentEventData = {
                        name: event.name || 'KOPDAR RUTIN',
                        description: event.description || 'Kopdar rutin mingguan komunitas BGT PRO',
                        time: event.startDate ? new Date(event.startDate.toDate()).toLocaleString('id-ID', { 
                            weekday: 'long', 
                            hour: '2-digit', 
                            minute: '2-digit' 
                        }) : 'Sabtu, 20:00 WIB',
                        imageUrl: event.imageUrl || null
                    };
                    
                    const imageUrl = event.imageUrl || '';
                    if (imageUrl) {
                        if (imageUrl.startsWith('data:image') || imageUrl.startsWith('http')) {
                            eventImage.src = imageUrl;
                            eventImage.style.display = 'block';
                        } else if (imageUrl.startsWith('gs://')) {
                            this.getValidImageUrl(imageUrl).then(url => {
                                if (url) {
                                    eventImage.src = url;
                                    eventImage.style.display = 'block';
                                } else {
                                    eventImage.style.display = 'none';
                                }
                            }).catch(error => {
                                console.error("Error loading event image:", error);
                                eventImage.style.display = 'none';
                            });
                        }
                    } else {
                        eventImage.style.display = 'none';
                    }
                    
                    eventImage.onerror = function() { 
                        this.onerror = null; 
                        this.style.display = 'none'; 
                        console.error("Gambar event gagal dimuat, menyembunyikan gambar."); 
                    };
                    
                    document.getElementById('eventSection').onclick = () => {
                        this.showEventModal();
                    };
                    
                    this.checkEventNotification();
                    
                } catch (error) {
                    console.error("Error loading events:", error);
                    if (error.message.includes("The query requires an index")) {
                        this.handleIndexError(error);
                    } else {
                        this.handleFirebaseError(error);
                    }
                    this.currentEventData = {
                        name: 'KOPDAR RUTIN',
                        description: 'Kopdar rutin mingguan komunitas BGT PRO',
                        time: 'Sabtu, 20:00 WIB',
                        imageUrl: null
                    };
                    eventImage.style.display = 'none';
                }
            },
            
            showEventModal() {
                if (!this.currentEventData) return;
                
                const modal = document.getElementById('modal');
                document.getElementById('modalTitle').textContent = 'Detail Event';
                document.getElementById('modalDetailTitle').textContent = this.currentEventData.name;
                
                const description = `Waktu: ${this.currentEventData.time}\n\n${this.currentEventData.description}`;
                document.getElementById('modalDetailDesc').textContent = description;
                
                const modalImage = document.getElementById('modalImage');
                if (this.currentEventData.imageUrl) {
                    if (this.currentEventData.imageUrl.startsWith('data:image') || this.currentEventData.imageUrl.startsWith('http')) {
                        modalImage.src = this.currentEventData.imageUrl;
                        modalImage.style.display = 'block';
                    } else if (this.currentEventData.imageUrl.startsWith('gs://')) {
                        this.getValidImageUrl(this.currentEventData.imageUrl).then(url => {
                            if (url) {
                                modalImage.src = url;
                                modalImage.style.display = 'block';
                            } else {
                                modalImage.style.display = 'none';
                            }
                        }).catch(error => {
                            console.error("Error loading modal image:", error);
                            modalImage.style.display = 'none';
                        });
                    }
                } else {
                    modalImage.style.display = 'none';
                }
                
                modalImage.onerror = function() { 
                    this.onerror = null; 
                    this.style.display = 'none'; 
                };
                
                modal.classList.add('active');
                document.querySelector('.app-container').style.overflow = 'hidden';
            },
            
            async loadBannersFromFirebase() {
                const container = document.getElementById('adminCarousel');
                const indicators = document.getElementById('carouselIndicators');
                container.innerHTML = '';
                indicators.innerHTML = '';
                
                if (this.state.isGuestMode) {
                    const slideDiv = document.createElement('div');
                    slideDiv.className = `carousel-slide active`;
                    slideDiv.innerHTML = `<img src="https://picsum.photos/seed/banner1/600/300.jpg" alt="Demo Banner">`;
                    container.appendChild(slideDiv);
                    
                    const indicator = document.createElement('div');
                    indicator.className = `indicator active`;
                    indicators.appendChild(indicator);
                    return;
                }

                try {
                    const snapshot = await this.db.collection('promos').where('status', '==', 'active').get();
                    
                    if (snapshot.empty) {
                        container.innerHTML = `
                            <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-secondary); position: relative; z-index: 3;">
                                <div style="text-align: center;">
                                    <i class="fas fa-images" style="font-size: 32px; margin-bottom: 10px; opacity: 0.5;"></i>
                                    <p>Belum ada banner</p>
                                </div>
                            </div>
                        `;
                        return;
                    }
                    
                    const banners = [];
                    snapshot.forEach(doc => {
                        banners.push({ id: doc.id, ...doc.data() });
                    });
                    
                    for (let index = 0; index < banners.length; index++) {
                        const banner = banners[index];
                        const slideDiv = document.createElement('div');
                        slideDiv.className = `carousel-slide ${index === 0 ? 'active' : ''}`;
                        
                        const imageUrl = banner.imageUrl || '';
                        let imageHtml = '';
                        
                        if (imageUrl) {
                            if (imageUrl.startsWith('data:image') || imageUrl.startsWith('http')) {
                                imageHtml = `<img src="${imageUrl}" alt="${banner.title}">`;
                            } else if (imageUrl.startsWith('gs://')) {
                                imageHtml = `<img src="" alt="${banner.title}" data-firebase-url="${imageUrl}">`;
                            }
                        }
                        
                        if (imageHtml) {
                            slideDiv.innerHTML = imageHtml;
                        } else {
                            slideDiv.innerHTML = `
                                <div style="display:flex;align-items:center;justify-content:center;height:100%;background:linear-gradient(135deg, var(--primary-color), var(--primary-dark));color:white;text-align:center;padding:20px; position: relative; z-index: 3;">
                                    <div>
                                        <h2 style="margin-bottom:10px;">${banner.title}</h2>
                                        <p>${banner.description}</p>
                                    </div>
                                </div>
                            `;
                        }
                        
                        slideDiv.bannerData = {
                            title: banner.title,
                            description: banner.description,
                            imageUrl: imageUrl
                        };
                        
                        slideDiv.onclick = () => {
                            this.showBannerModal(slideDiv.bannerData);
                        };
                        
                        container.appendChild(slideDiv);
                        
                        const indicator = document.createElement('div');
                        indicator.className = `indicator ${index === 0 ? 'active' : ''}`;
                        indicator.onclick = () => this.goToSlide(index);
                        indicators.appendChild(indicator);
                        
                        const firebaseImage = slideDiv.querySelector('img[data-firebase-url]');
                        if (firebaseImage) {
                            const firebaseUrl = firebaseImage.getAttribute('data-firebase-url');
                            this.getValidImageUrl(firebaseUrl).then(url => {
                                if (url) {
                                    firebaseImage.src = url;
                                } else {
                                    firebaseImage.parentElement.innerHTML = `
                                        <div style="display:flex;align-items:center;justify-content:center;height:100%;background:linear-gradient(135deg, var(--primary-color), var(--primary-dark));color:white;text-align:center;padding:20px; position: relative; z-index: 3;">
                                            <div>
                                                <h2 style="margin-bottom:10px;">${banner.title}</h2>
                                                <p>${banner.description}</p>
                                            </div>
                                        </div>
                                    `;
                                }
                            }).catch(error => {
                                console.error("Error loading Firebase image:", error);
                                firebaseImage.parentElement.innerHTML = `
                                    <div style="display:flex;align-items:center;justify-content:center;height:100%;background:linear-gradient(135deg, var(--primary-color), var(--primary-dark));color:white;text-align:center;padding:20px; position: relative; z-index: 3;">
                                        <div>
                                            <h2 style="margin-bottom:10px;">${banner.title}</h2>
                                            <p>${banner.description}</p>
                                        </div>
                                    </div>
                                `;
                            });
                        }
                    }
                    
                    if (banners.length > 1) {
                        setInterval(() => this.nextSlide(), 5000);
                    }
                    
                } catch (error) {
                    console.error("Error loading banners:", error);
                    this.handleFirebaseError(error);
                    container.innerHTML = '<p style="text-align:center; padding: 20px; color:var(--text-secondary); position: relative; z-index: 3;">Gagal memuat banner</p>';
                }
            },
            
            showBannerModal(bannerData) {
                const modal = document.getElementById('modal');
                document.getElementById('modalTitle').textContent = 'Detail Promo';
                document.getElementById('modalDetailTitle').textContent = bannerData.title;
                document.getElementById('modalDetailDesc').textContent = bannerData.description;
                
                const modalImage = document.getElementById('modalImage');
                if (bannerData.imageUrl) {
                    if (bannerData.imageUrl.startsWith('data:image') || bannerData.imageUrl.startsWith('http')) {
                        modalImage.src = bannerData.imageUrl;
                        modalImage.style.display = 'block';
                    } else if (bannerData.imageUrl.startsWith('gs://')) {
                        this.getValidImageUrl(bannerData.imageUrl).then(url => {
                            if (url) {
                                modalImage.src = url;
                                modalImage.style.display = 'block';
                            } else {
                                modalImage.style.display = 'none';
                            }
                        }).catch(error => {
                            console.error("Error loading modal image:", error);
                            modalImage.style.display = 'none';
                        });
                    }
                } else {
                    modalImage.style.display = 'none';
                }
                
                modalImage.onerror = function() { 
                    this.onerror = null; 
                    this.style.display = 'none'; 
                };
                
                modal.classList.add('active');
                document.querySelector('.app-container').style.overflow = 'hidden';
            },
            
            updateBalanceFromFirebase() {
            },
            
            showRealtimeIndicator() {
                const indicator = document.getElementById('realtimeIndicator');
                indicator.classList.add('active');
                setTimeout(() => { 
                    indicator.classList.remove('active'); 
                }, 2000);
            },
            
            nextSlide() {
                const slides = document.querySelectorAll('.carousel-slide');
                const indicators = document.querySelectorAll('.indicator');
                
                if (slides.length === 0) return;
                
                slides[this.state.currentSlide].classList.remove('active');
                indicators[this.state.currentSlide].classList.remove('active');
                
                this.state.currentSlide = (this.state.currentSlide + 1) % slides.length;
                
                slides[this.state.currentSlide].classList.add('active');
                indicators[this.state.currentSlide].classList.add('active');
            },
            
            goToSlide(index) {
                const slides = document.querySelectorAll('.carousel-slide');
                const indicators = document.querySelectorAll('.indicator');
                
                if (slides.length === 0) return;
                
                slides[this.state.currentSlide].classList.remove('active');
                indicators[this.state.currentSlide].classList.remove('active');
                
                this.state.currentSlide = index;
                
                slides[this.state.currentSlide].classList.add('active');
                indicators[this.state.currentSlide].classList.add('active');
            },
            
            checkEventNotification() {
            },
            
            async getValidImageUrl(imagePath) {
                if (!imagePath) return null;
                
                if (imagePath.startsWith('data:image')) {
                    return imagePath;
                }
                
                if (imagePath.startsWith('http')) {
                    return imagePath;
                }
                
                if (imagePath.startsWith('gs://')) {
                    try {
                        const storageRef = this.storage.refFromURL(imagePath);
                        return await storageRef.getDownloadURL();
                    } catch (error) {
                        console.error("Gagal mendapatkan URL unduhan untuk:", imagePath, error);
                        return null;
                    }
                }
                
                return null;
            },
            
            handleFirebaseError(error) {
                if (this.state.firebaseErrorShown) return;
                this.state.firebaseErrorShown = true;
                
                const existingError = document.querySelector('.error-message');
                if (existingError) existingError.remove();
                
                if (error.message.includes("permission-denied")) {
                    const permissionGuide = document.getElementById('permissionGuide');
                    permissionGuide.classList.add('active');
                    
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'error-message';
                    errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i><span>Anda tidak memiliki izin untuk mengakses data. Lihat panduan di bawah untuk mengatasi masalah ini.</span>`;
                    document.getElementById('main-content').insertBefore(errorDiv, document.querySelector('.eventSection'));
                } else {
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'error-message';
                    errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i><span>Terjadi kesalahan saat mengambil data: ${error.message}</span>`;
                    document.getElementById('main-content').insertBefore(errorDiv, document.querySelector('.eventSection'));
                }
            },
            
            handleIndexError(error) {
                if (this.state.indexErrorShown) return;
                this.state.indexErrorShown = true;
                
                const existingError = document.querySelector('.error-message');
                if (existingError) existingError.remove();
                
                const urlMatch = error.message.match(/https:\/\/console\.firebase\.google\.com[^\s]+/);
                const indexUrl = urlMatch ? urlMatch[0] : 'https://console.firebase.google.com/';
                
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i><span>Query memerlukan indeks Firebase. <a href="${indexUrl}" target="_blank">Buat indeks di sini</a></span>`;
                document.getElementById('main-content').insertBefore(errorDiv, document.querySelector('.eventSection'));
            },
            
            copyRulesCode() {
                const rulesCode = document.getElementById('rulesCode').innerText;
                navigator.clipboard.writeText(rulesCode).then(() => { 
                    this.showToast('Kode aturan disalin!', 'success'); 
                }).catch(err => { 
                    console.error('Gagal menyalin kode: ', err); 
                    this.showToast('Gagal menyalin kode', 'error'); 
                });
            },
            
            toggleMenu() {
                const sideMenu = document.getElementById('sideMenu');
                const overlay = document.getElementById('overlay');
                sideMenu.classList.toggle('active');
                overlay.classList.toggle('active');
                const appContainer = document.querySelector('.app-container');
                appContainer.style.overflow = sideMenu.classList.contains('active') ? 'hidden' : 'auto';
            },
            
            // UPDATE: Handle Menu Click (Burger)
            handleMenuClick(item) {
                if (item === 'Kas') {
                    this.showPage('kas-page');
                } else if (item === 'Peta') {
                    this.showPage('peta-page');
                } else if (item === 'Explore') {
                    // Explore sekarang ada di Burger
                    this.showPage('explorer-page');
                } else if (item === 'Pengaturan') {
                    this.showPage('pengaturan-page');
                } else if (item === 'Bantuan') {
                    this.showPage('bantuan-page');
                }
                this.toggleMenu();
            },
            
            // UPDATE: Handle Nav Click (Bottom)
            handleNavClick(element, section) {
                document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
                element.classList.add('active');
                
                if (section === 'Home') {
                    this.showMainContent();
                } else if (section === 'Peta') {
                    // Peta sekarang di Bottom Nav
                    this.showPage('peta-page');
                } else if (section === 'Activity') {
                    this.showPage('activity-page');
                } else if (section === 'Pesan') {
                    // Pesan sekarang di Bottom Nav, buka file pesan.html
                    window.location.href = 'pesan.html';
                } else {
                    this.showToast(`Navigasi ke ${section}`, 'info');
                }
            },
            
            showMainContent() {
                document.getElementById('main-content').style.display = 'block';
                document.querySelectorAll('.page-view').forEach(page => page.classList.remove('active'));
                
                document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
                document.querySelector('.nav-item').classList.add('active');
            },
            
            showPage(pageId) {
                document.getElementById('main-content').style.display = 'none';
                document.querySelectorAll('.page-view').forEach(page => page.classList.remove('active'));
                document.getElementById(pageId).classList.add('active');
            },
            
            showProfile() {
                this.showPage('profile-page');
            },
            
            showNotifications() {
                this.showModal('notifications', 'Notifikasi', 'Tidak ada notifikasi baru');
            },
            
            showModal(type, title, description, image = null) {
                const modal = document.getElementById('modal');
                document.getElementById('modalTitle').textContent = title;
                document.getElementById('modalDetailTitle').textContent = title;
                document.getElementById('modalDetailDesc').textContent = description;
                const modalImage = document.getElementById('modalImage');
                
                if (image) {
                    if (image.startsWith('data:image') || image.startsWith('http')) {
                        modalImage.src = image;
                        modalImage.style.display = 'block';
                    } else if (image.startsWith('gs://')) {
                        this.getValidImageUrl(image).then(url => {
                            if (url) {
                                modalImage.src = url;
                                modalImage.style.display = 'block';
                            } else {
                                modalImage.style.display = 'none';
                            }
                        }).catch(error => {
                            console.error("Error loading modal image:", error);
                            modalImage.style.display = 'none';
                        });
                    }
                } else {
                    modalImage.style.display = 'none';
                }
                
                modalImage.onerror = function() { 
                    this.onerror = null; 
                    this.style.display = 'none'; 
                };
                
                modal.classList.add('active');
                document.querySelector('.app-container').style.overflow = 'hidden';
            },
            
            closeModal() {
                document.getElementById('modal').classList.remove('active');
                document.querySelector('.app-container').style.overflow = 'auto';
            },
            
            handleModalAction() { 
                this.closeModal(); 
            },
            
            triggerDisruption() {
                document.getElementById('disruption-overlay').classList.add('active');
            },
            
            stopDisruption() {
                document.getElementById('disruption-overlay').classList.remove('active');
            },
            
            showLoadingScreen(text = 'Memuat...') {
                const loadingScreen = document.getElementById('loadingScreen');
                const loadingText = document.getElementById('loadingText');
                loadingText.textContent = text;
                loadingScreen.classList.remove('hidden');
                
                document.getElementById('cancelLoadingBtn').style.display = 'none';
            },
            
            hideLoadingScreen() {
                const loadingScreen = document.getElementById('loadingScreen');
                loadingScreen.classList.add('hidden');
            },
            
            showToast(message, type = 'default') {
                let toast = document.getElementById('toast');
                if (!toast) {
                    toast = document.createElement('div');
                    toast.id = 'toast';
                    toast.className = 'toast';
                    document.querySelector('.phone-container').appendChild(toast);
                }
                
                toast.textContent = message;
                toast.className = `toast ${type}`;
                toast.classList.add('show');
                
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            },
            
            logout() {
                // Tandai logout sebagai eksplisit
                this.state.isExplicitLogout = true;
                
                // Hapus status sesi dari localStorage
                localStorage.removeItem('bgtProSession');
                
                // Logout dari Firebase
                if (this.auth.currentUser) {
                    this.auth.signOut().then(() => {
                        // Tidak perlu reload halaman karena handleAuthStateChange akan menanganinya
                        this.showToast("Anda telah keluar", "success");
                    }).catch((error) => {
                        console.error("Error signing out:", error);
                        this.showToast('Gagal keluar, coba lagi', 'error');
                        this.state.isExplicitLogout = false;
                    });
                } else {
                    // Jika tidak ada pengguna yang login, langsung reload halaman
                    window.location.reload();
                }
            }
        };
        
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>
</html>
