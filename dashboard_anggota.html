<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BGT PRO - Aplikasi</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Leaflet CSS untuk Peta -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
    <style>
        /* ... (Semua CSS yang lama tetap sama, saya hanya menambahkan yang baru) ... */
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; background-color: #f0f0f0; display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
        .phone-container { width: 350px; height: 750px; background-color: #ffffff; border-radius: 16px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15); overflow: hidden; position: relative; }
        .app-container { height: 100%; overflow-y: auto; background-color: #f8f9fa; position: relative; }
        .header { background: linear-gradient(135deg, #4285f4, #1a73e8); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 12px rgba(26, 115, 232, 0.3); position: sticky; top: 0; z-index: 100; }
        .header-left { display: flex; align-items: center; gap: 12px; }
        .profile-photo { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 2px solid white; cursor: pointer; transition: transform 0.3s, box-shadow 0.3s; }
        .profile-photo:hover { transform: scale(1.1); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); }
        .logo { font-size: 20px; font-weight: 800; letter-spacing: -0.5px; position: absolute; left: 50%; transform: translateX(-50%); }
        .header-right { display: flex; align-items: center; gap: 12px; margin-left: auto; }
        .balance { display: none; }
        .notification-btn { position: relative; background: none; border: none; color: white; font-size: 18px; cursor: pointer; padding: 5px; border-radius: 8px; transition: background-color 0.3s; }
        .notification-btn:hover { background-color: rgba(255, 255, 255, 0.2); }
        .notification-badge { position: absolute; top: -2px; right: -2px; background: linear-gradient(135deg, #ff4757, #ff6348); color: white; font-size: 9px; font-weight: 700; width: 16px; height: 16px; border-radius: 50%; display: flex; justify-content: center; align-items: center; box-shadow: 0 2px 6px rgba(255, 71, 87, 0.4); }
        .menu-btn { background: none; border: none; color: white; font-size: 20px; cursor: pointer; padding: 5px; border-radius: 8px; transition: background-color 0.3s; }
        .menu-btn:hover { background-color: rgba(255, 255, 255, 0.2); }
        .side-menu { position: absolute; top: 0; right: -280px; width: 280px; height: 100%; background-color: white; box-shadow: -4px 0 20px rgba(0, 0, 0, 0.3); transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 1000; display: flex; flex-direction: column; border-radius: 0 16px 16px 0; }
        .side-menu.active { right: 0; }
        .side-menu-header { background: linear-gradient(135deg, #4285f4, #1a73e8); color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; border-radius: 0 0 0 16px; }
        .close-menu { background: none; border: none; color: white; font-size: 24px; cursor: pointer; padding: 5px; border-radius: 8px; transition: background-color 0.3s; }
        .close-menu:hover { background-color: rgba(255, 255, 255, 0.2); }
        .side-menu-content { flex: 1; padding: 20px; overflow-y: auto; }
        .menu-item { display: flex; align-items: center; padding: 15px; margin-bottom: 10px; border-radius: 12px; cursor: pointer; transition: all 0.3s; background-color: #f8f9fa; }
        .menu-item:hover { background-color: #e9ecef; transform: translateX(-5px); }
        .menu-item i { font-size: 20px; margin-right: 15px; color: #4285f4; }
        .menu-item span { font-size: 16px; font-weight: 600; color: #2c3e50; }
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); z-index: 999; opacity: 0; visibility: hidden; transition: all 0.3s; border-radius: 16px; }
        .overlay.active { opacity: 1; visibility: visible; }
        .admin-carousel { margin: 15px; position: relative; overflow: hidden; border-radius: 16px; background: white; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); }
        .carousel-container { position: relative; height: 180px; overflow: hidden; }
        .carousel-slide { position: absolute; width: 100%; height: 100%; opacity: 0; transition: opacity 1s ease-in-out; cursor: pointer; }
        .carousel-slide.active { opacity: 1; }
        .carousel-slide img { width: 100%; height: 100%; object-fit: cover; }
        .carousel-content { position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); color: white; padding: 15px; transform: translateY(100%); transition: transform 0.3s; }
        .carousel-slide.active .carousel-content { transform: translateY(0); }
        .carousel-title { font-size: 18px; font-weight: 700; margin-bottom: 5px; }
        .carousel-desc { font-size: 13px; opacity: 0.9; }
        .carousel-indicators { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 8px; z-index: 10; }
        .indicator { width: 8px; height: 8px; border-radius: 50%; background-color: rgba(255, 255, 255, 0.5); cursor: pointer; transition: all 0.3s; }
        .indicator.active { width: 24px; border-radius: 4px; background-color: white; }
        .promo-carousel { margin: 0 15px 15px; position: relative; overflow: hidden; border-radius: 16px; }
        .promo-section-title { font-size: 18px; font-weight: 700; margin-bottom: 10px; color: #2c3e50; }
        .carousel-scroll { display: flex; animation: scroll 20s linear infinite; width: fit-content; }
        .carousel-scroll:hover { animation-play-state: paused; }
        @keyframes scroll { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }
        .promo-card { min-width: 280px; background-color: white; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); margin-right: 15px; cursor: pointer; transition: transform 0.3s, box-shadow 0.3s; }
        .promo-card:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12); }
        .promo-card-image { width: 100%; height: 160px; object-fit: cover; }
        .promo-card-info { padding: 15px; }
        .promo-card-title { font-size: 16px; font-weight: 700; margin-bottom: 5px; color: #2c3e50; }
        .promo-card-desc { font-size: 13px; color: #7f8c8d; line-height: 1.5; }
        .event-section { margin: 0 15px 15px; background-color: white; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); transition: transform 0.3s, box-shadow 0.3s; cursor: pointer; position: relative; }
        .event-section:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12); }
        .event-image { width: 100%; height: 180px; object-fit: cover; display: none; }
        .event-info { padding: 15px; position: relative; }
        .event-title { font-size: 18px; font-weight: 700; margin-bottom: 5px; color: #2c3e50; display: flex; align-items: center; gap: 8px; }
        .event-time { color: #7f8c8d; font-size: 14px; font-weight: 500; display: flex; align-items: center; gap: 6px; }
        .event-badge { position: absolute; top: 10px; right: 10px; background: linear-gradient(135deg, #ff4757, #ff6348); color: white; font-size: 11px; font-weight: 700; padding: 4px 10px; border-radius: 12px; text-transform: uppercase; letter-spacing: 0.5px; box-shadow: 0 2px 8px rgba(255, 71, 87, 0.3); }
        .bottom-nav { position: absolute; bottom: 0; left: 0; right: 0; background-color: white; display: flex; justify-content: space-around; padding: 10px 0 15px; box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.08); border-top: 1px solid #f0f0f0; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #95a5a6; cursor: pointer; transition: all 0.3s; position: relative; padding: 5px; }
        .nav-item.active { color: #4285f4; }
        .nav-item.active i { transform: scale(1.1); }
        .nav-item i { font-size: 20px; margin-bottom: 4px; transition: transform 0.3s; }
        .nav-item span { font-size: 10px; font-weight: 600; }
        .modal { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); z-index: 2000; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s; border-radius: 16px; }
        .modal.active { display: flex; opacity: 1; }
        .modal-content { background-color: white; border-radius: 20px; width: 90%; max-width: 320px; max-height: 80%; overflow: hidden; position: relative; animation: modalSlideIn 0.3s; }
        @keyframes modalSlideIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header { padding: 18px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 18px; font-weight: 700; color: #2c3e50; }
        .modal-close { background: none; border: none; font-size: 22px; color: #95a5a6; cursor: pointer; transition: color 0.3s; }
        .modal-close:hover { color: #2c3e50; }
        .modal-body { padding: 18px; max-height: 60vh; overflow-y: auto; }
        .modal-image { width: 100%; border-radius: 12px; margin-bottom: 18px; }
        .modal-details { color: #2c3e50; }
        .modal-details h3 { font-size: 16px; margin-bottom: 8px; }
        .modal-details p { font-size: 13px; line-height: 1.6; color: #7f8c8d; margin-bottom: 15px; white-space: pre-line; }
        .modal-action { background: linear-gradient(135deg, #4285f4, #1a73e8); color: white; border: none; padding: 10px 20px; border-radius: 20px; font-size: 14px; font-weight: 600; cursor: pointer; width: 100%; transition: transform 0.3s, box-shadow 0.3s; }
        .modal-action:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(66, 133, 244, 0.4); }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in-up { animation: fadeInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
        .app-container::-webkit-scrollbar { width: 4px; } .app-container::-webkit-scrollbar-track { background: transparent; } .app-container::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 2px; }
        .side-menu-content::-webkit-scrollbar { width: 4px; } .side-menu-content::-webkit-scrollbar-track { background: transparent; } .side-menu-content::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 2px; }
        .realtime-indicator { position: absolute; top: 15px; right: 15px; width: 10px; height: 10px; border-radius: 50%; background-color: #4CAF50; opacity: 0; transition: opacity 0.3s; }
        .realtime-indicator.active { opacity: 1; }
        .promo-card-no-image { min-height: 120px; display: flex; flex-direction: column; justify-content: center; }
        .event-section-no-image { min-height: 120px; display: flex; flex-direction: column; justify-content: center; }
        .error-message { background-color: #ff4757; color: white; padding: 10px 15px; border-radius: 8px; margin: 10px 15px; font-size: 13px; display: flex; align-items: center; gap: 8px; }
        .error-message i { font-size: 16px; }
        .error-message a { color: white; text-decoration: underline; font-weight: 600; }
        .permission-guide { background-color: #4285f4; color: white; padding: 15px; border-radius: 8px; margin: 10px 15px; font-size: 13px; display: none; }
        .permission-guide.active { display: block; }
        .permission-guide h4 { margin-bottom: 10px; font-size: 16px; }
        .permission-guide ol { padding-left: 20px; margin-bottom: 10px; }
        .permission-guide li { margin-bottom: 5px; }
        .permission-guide code { background-color: rgba(255, 255, 255, 0.2); padding: 2px 5px; border-radius: 4px; font-family: monospace; }
        .permission-guide .copy-btn { background-color: rgba(255, 255, 255, 0.2); border: none; color: white; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-top: 10px; font-size: 12px; transition: background-color 0.3s; }
        .permission-guide .copy-btn:hover { background-color: rgba(255, 255, 255, 0.3); }

        /* --- GAYA UNTUK HALAMAN PROFIL (BARU) --- */
        .page-view { display: none; padding: 20px; animation: fadeInUp 0.5s ease-out; }
        .page-view.active { display: block; }
        .profile-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .profile-header h2 { font-size: 24px; color: #2c3e50; }
        .back-btn { background: none; border: 1px solid #ddd; color: #7f8c8d; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 14px; transition: all 0.3s; }
        .back-btn:hover { background-color: #f8f9fa; border-color: #adb5bd; }
        .profile-content { display: flex; flex-direction: column; align-items: center; }
        .profile-avatar { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 4px solid white; box-shadow: 0 4px 12px rgba(0,0,0,0.15); margin-bottom: 20px; }
        .profile-info { text-align: center; }
        .profile-info h3 { font-size: 22px; color: #2c3e50; margin: 0 0 5px 0; }
        .profile-info p { font-size: 14px; color: #7f8c8d; margin: 5px 0; }
        .profile-stats { display: flex; justify-content: space-around; width: 100%; margin-top: 20px; padding-top: 20px; border-top: 1px solid #e9ecef; }
        .stat-item { text-align: center; }
        .stat-item .stat-value { font-size: 18px; font-weight: 700; color: #2c3e50; }
        .stat-item .stat-label { font-size: 12px; color: #95a5a6; text-transform: uppercase; margin-top: 5px; }

        /* --- GAYA UNTUK HALAMAN KAS (BARU) --- */
        .kas-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .kas-header h2 { font-size: 24px; color: #2c3e50; }
        .kas-content { display: flex; flex-direction: column; gap: 15px; }
        .kas-card { background-color: white; border-radius: 16px; padding: 15px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); }
        .kas-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .kas-card-title { font-size: 18px; font-weight: 700; color: #2c3e50; display: flex; align-items: center; gap: 8px; }
        .kas-card-amount { font-size: 20px; font-weight: 700; color: #2c3e50; }
        .kas-card-list { max-height: 200px; overflow-y: auto; }
        .kas-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f0f0f0; }
        .kas-item:last-child { border-bottom: none; }
        .kas-item-name { font-size: 14px; color: #2c3e50; }
        .kas-item-amount { font-size: 14px; font-weight: 600; }
        .kas-item-amount.positive { color: #27ae60; }
        .kas-item-amount.negative { color: #e74c3c; }
        .kas-empty { text-align: center; padding: 20px; color: #95a5a6; font-size: 14px; }
        .kas-add-btn { background: linear-gradient(135deg, #4285f4, #1a73e8); color: white; border: none; padding: 10px 15px; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: transform 0.3s, box-shadow 0.3s; }
        .kas-add-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(66, 133, 244, 0.4); }

        /* --- GAYA UNTUK HALAMAN PROMO (BARU) --- */
        .promo-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .promo-header h2 { font-size: 24px; color: #2c3e50; }
        .promo-content { display: flex; flex-direction: column; gap: 15px; }
        .promo-detail-card { background-color: white; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); }
        .promo-detail-image { width: 100%; height: 180px; object-fit: cover; }
        .promo-detail-info { padding: 15px; }
        .promo-detail-title { font-size: 18px; font-weight: 700; margin-bottom: 10px; color: #2c3e50; }
        .promo-detail-desc { font-size: 14px; color: #7f8c8d; line-height: 1.5; margin-bottom: 15px; }
        .promo-detail-expiry { font-size: 13px; color: #e74c3c; display: flex; align-items: center; gap: 5px; }

        /* --- GAYA UNTUK HALAMAN PETA (BARU & DIPERBAIKI) --- */
        .map-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .map-header h2 { font-size: 24px; color: #2c3e50; }
        .map-container { background-color: white; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); height: 400px; position: relative; }
        #map { height: 100%; width: 100%; }
        .map-controls { position: absolute; top: 10px; right: 10px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
        .map-control-btn { background-color: white; border: none; width: 40px; height: 40px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15); display: flex; justify-content: center; align-items: center; cursor: pointer; transition: all 0.3s; }
        .map-control-btn:hover { background-color: #f8f9fa; transform: scale(1.05); }
        .map-control-btn i { color: #4285f4; font-size: 18px; }
        .location-list { background-color: white; border-radius: 16px; margin-top: 15px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); max-height: 200px; overflow-y: auto; }
        .location-item { display: flex; align-items: center; padding: 12px 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: background-color 0.3s; }
        .location-item:last-child { border-bottom: none; }
        .location-item:hover { background-color: #f8f9fa; }
        .location-item-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; margin-right: 12px; }
        .location-item-info { flex: 1; }
        .location-item-name { font-size: 14px; font-weight: 600; color: #2c3e50; }
        .location-item-time { font-size: 12px; color: #7f8c8d; }
        .location-item-distance { font-size: 12px; color: #4285f4; font-weight: 600; }

        /* --- GAYA UNTUK HALAMAN PESAN (BARU) --- */
        .message-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .message-header h2 { font-size: 24px; color: #2c3e50; }
        .message-compose { background-color: white; border-radius: 16px; padding: 15px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); margin-bottom: 15px; }
        .message-compose-input { width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 10px; font-size: 14px; margin-bottom: 10px; resize: none; }
        .message-compose-btn { background: linear-gradient(135deg, #4285f4, #1a73e8); color: white; border: none; padding: 10px 15px; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; transition: transform 0.3s, box-shadow 0.3s; }
        .message-compose-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(66, 133, 244, 0.4); }
        .message-list { display: flex; flex-direction: column; gap: 15px; }
        .message-item { background-color: white; border-radius: 16px; padding: 15px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); }
        .message-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .message-item-sender { font-size: 16px; font-weight: 700; color: #2c3e50; }
        .message-item-time { font-size: 12px; color: #95a5a6; }
        .message-item-content { font-size: 14px; color: #7f8c8d; line-height: 1.5; }

        /* --- GAYA UNTUK HALAMAN PENGATURAN (BARU) --- */
        .settings-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .settings-header h2 { font-size: 24px; color: #2c3e50; }
        .settings-content { display: flex; flex-direction: column; gap: 15px; }
        .settings-card { background-color: white; border-radius: 16px; padding: 15px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); }
        .settings-card-title { font-size: 18px; font-weight: 700; margin-bottom: 15px; color: #2c3e50; }
        .settings-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f0f0f0; }
        .settings-item:last-child { border-bottom: none; }
        .settings-item-label { font-size: 14px; color: #2c3e50; }
        .settings-toggle { position: relative; width: 50px; height: 26px; background-color: #ccc; border-radius: 13px; cursor: pointer; transition: background-color 0.3s; }
        .settings-toggle.active { background-color: #4285f4; }
        .settings-toggle-slider { position: absolute; top: 3px; left: 3px; width: 20px; height: 20px; background-color: white; border-radius: 50%; transition: transform 0.3s; }
        .settings-toggle.active .settings-toggle-slider { transform: translateX(24px); }
        .settings-btn { background: none; border: 1px solid #ddd; color: #7f8c8d; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 14px; transition: all 0.3s; }
        .settings-btn:hover { background-color: #f8f9fa; border-color: #adb5bd; }

        /* --- GAYA UNTUK HALAMAN BANTUAN (BARU) --- */
        .help-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .help-header h2 { font-size: 24px; color: #2c3e50; }
        .help-content { display: flex; flex-direction: column; gap: 15px; }
        .help-card { background-color: white; border-radius: 16px; padding: 15px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08); }
        .help-card-title { font-size: 18px; font-weight: 700; margin-bottom: 10px; color: #2c3e50; display: flex; align-items: center; gap: 8px; }
        .help-card-content { font-size: 14px; color: #7f8c8d; line-height: 1.5; }
        .help-contact { display: flex; align-items: center; gap: 10px; margin-top: 15px; padding-top: 15px; border-top: 1px solid #f0f0f0; }
        .help-contact-item { display: flex; align-items: center; gap: 5px; font-size: 14px; color: #4285f4; }

        /* --- GAYA UNTUK DISRUPSI (BARU) --- */
        #disruption-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease-in-out, visibility 0.5s ease-in-out;
            border-radius: 16px;
        }
        #disruption-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        #disruption-overlay img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            border: 3px solid red;
            animation: glitch 1.5s infinite;
        }
        #disruption-overlay h1 {
            font-family: 'Courier New', Courier, monospace;
            font-size: 2.5rem;
            color: #ff0000;
            text-shadow: 0 0 10px #ff0000, 0 0 20px #ff00de;
            text-align: center;
            margin-top: 20px;
            animation: textGlitch 0.3s infinite;
        }
        @keyframes glitch {
            0%, 100% { transform: translate(0, 0); }
            20% { transform: translate(-5px, 5px); }
            40% { transform: translate(-5px, -5px); }
            60% { transform: translate(5px, 5px); }
            80% { transform: translate(5px, -5px); }
        }
        @keyframes textGlitch {
            0%, 100% { text-shadow: 0 0 10px red, 0 0 20px #ff00de; }
            50% { text-shadow: 0 0 10px #ff00de, 0 0 20px red; }
        }

        @media (max-width: 480px) {
            .phone-container { width: 100%; height: 100vh; border-radius: 0; }
            body { padding: 0; }
        }
    </style>
</head>
<body>
    <div class="phone-container">
        <div class="app-container">
            <!-- Konten Utama (Home, Promo, dll) -->
            <div id="main-content">
                <div class="header">
                    <div class="header-left">
                        <img src="https://picsum.photos/seed/default-user/100/100.jpg" alt="Profile" class="profile-photo" id="headerProfilePhoto" onclick="showProfile()">
                    </div>
                    <div class="logo">BGT PRO</div>
                    <div class="header-right">
                        <button class="notification-btn" onclick="showNotifications()">
                            <i class="fas fa-bell"></i>
                            <div class="notification-badge">3</div>
                        </button>
                        <button class="menu-btn" onclick="toggleMenu()">
                            <i class="fas fa-bars"></i>
                        </button>
                    </div>
                </div>
                
                <div class="event-section fade-in-up" style="animation-delay: 0.05s;" id="eventSection">
                    <div class="event-badge">Upcoming</div>
                    <img alt="Event" class="event-image" id="eventImage">
                    <div class="event-info">
                        <div class="event-title" id="eventTitle">
                            <i class="fas fa-calendar-alt" style="color: #4285f4;"></i>
                            KOPDAR RUTIN
                        </div>
                        <div class="event-time" id="eventTime">
                            <i class="fas fa-clock" style="font-size: 12px;"></i>
                            Sabtu, 20:00 WIB
                        </div>
                    </div>
                </div>
                
                <div class="admin-carousel fade-in-up">
                    <div class="carousel-container" id="adminCarousel"></div>
                    <div class="carousel-indicators" id="carouselIndicators"></div>
                </div>
                
                <div class="promo-carousel fade-in-up" style="animation-delay: 0.1s;">
                    <div class="promo-section-title">Promo Terbaru</div>
                    <div class="carousel-scroll" id="promoCarousel"></div>
                </div>
                
                <div style="height: 80px;"></div>
            </div>

            <!-- Halaman Profil (DISEMBUNYIKAN SECARA DEFAULT) -->
            <div id="profile-page" class="page-view">
                <div class="profile-header">
                    <h2>Profil Saya</h2>
                    <button class="back-btn" onclick="showMainContent()">
                        <i class="fas fa-arrow-left"></i> Kembali
                    </button>
                </div>
                <div class="profile-content">
                    <img src="https://picsum.photos/seed/default-user/100/100.jpg" alt="Profile Avatar" class="profile-avatar" id="profilePageAvatar">
                    <div class="profile-info">
                        <h3 id="profilePageUsername">Loading...</h3>
                        <p id="profilePageEmail">Loading...</p>
                    </div>
                    <div class="profile-stats">
                        <div class="stat-item">
                            <div class="stat-value" id="profilePageRole">-</div>
                            <div class="stat-label">Role</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value">-</div>
                            <div class="stat-label">Status</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Halaman Kas (DISEMBUNYIKAN SECARA DEFAULT) -->
            <div id="kas-page" class="page-view">
                <div class="kas-header">
                    <h2>Manajemen Kas</h2>
                    <button class="back-btn" onclick="showMainContent()">
                        <i class="fas fa-arrow-left"></i> Kembali
                    </button>
                </div>
                <div class="kas-content">
                    <!-- Total Kas Card -->
                    <div class="kas-card">
                        <div class="kas-card-header">
                            <div class="kas-card-title">
                                <i class="fas fa-wallet" style="color: #4285f4;"></i>
                                Total Kas
                            </div>
                            <div class="kas-card-amount" id="totalKasAmount">Rp 0</div>
                        </div>
                        <div class="kas-card-list" id="kasList">
                            <div class="kas-empty">Memuat data kas...</div>
                        </div>
                    </div>
                    
                    <!-- Pinjaman Card -->
                    <div class="kas-card">
                        <div class="kas-card-header">
                            <div class="kas-card-title">
                                <i class="fas fa-hand-holding-usd" style="color: #e74c3c;"></i>
                                Pinjaman
                            </div>
                            <div class="kas-card-amount" id="pinjamanAmount">Rp 0</div>
                        </div>
                        <div class="kas-card-list" id="pinjamanList">
                            <div class="kas-empty">Memuat data pinjaman...</div>
                        </div>
                    </div>
                    
                    <!-- Belum Bayar Kas Card -->
                    <div class="kas-card">
                        <div class="kas-card-header">
                            <div class="kas-card-title">
                                <i class="fas fa-exclamation-circle" style="color: #f39c12;"></i>
                                Belum Bayar Kas
                            </div>
                            <div class="kas-card-amount" id="belumBayarAmount">Rp 0</div>
                        </div>
                        <div class="kas-card-list" id="belumBayarList">
                            <div class="kas-empty">Memuat data belum bayar...</div>
                        </div>
                    </div>
                    
                    <!-- Iuran Card -->
                    <div class="kas-card">
                        <div class="kas-card-header">
                            <div class="kas-card-title">
                                <i class="fas fa-coins" style="color: #27ae60;"></i>
                                Iuran
                            </div>
                            <div class="kas-card-amount" id="iuranAmount">Rp 0</div>
                        </div>
                        <div class="kas-card-list" id="iuranList">
                            <div class="kas-empty">Memuat data iuran...</div>
                        </div>
                    </div>
                    
                    <button class="kas-add-btn" onclick="showAddTransactionModal()">
                        <i class="fas fa-plus-circle"></i>
                        Tambah Transaksi
                    </button>
                </div>
            </div>

            <!-- Halaman Promo (DISEMBUNYIKAN SECARA DEFAULT) -->
            <div id="promo-page" class="page-view">
                <div class="promo-header">
                    <h2>Promo Aktif</h2>
                    <button class="back-btn" onclick="showMainContent()">
                        <i class="fas fa-arrow-left"></i> Kembali
                    </button>
                </div>
                <div class="promo-content" id="promoContent">
                    <div class="kas-empty">Memuat data promo...</div>
                </div>
            </div>

            <!-- Halaman Peta (DISEMBUNYIKAN SECARA DEFAULT) -->
            <div id="peta-page" class="page-view">
                <div class="map-header">
                    <h2>Peta Lokasi Anggota</h2>
                    <button class="back-btn" onclick="showMainContent()">
                        <i class="fas fa-arrow-left"></i> Kembali
                    </button>
                </div>
                <div class="map-container">
                    <div id="map"></div>
                    <div class="map-controls">
                        <button class="map-control-btn" id="locateBtn" title="Lokasi Saya">
                            <i class="fas fa-crosshairs"></i>
                        </button>
                        <button class="map-control-btn" id="refreshBtn" title="Perbarui Lokasi">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
                <div class="location-list" id="locationList">
                    <div class="kas-empty">Memuat lokasi anggota...</div>
                </div>
            </div>

            <!-- Halaman Pesan (DISEMBUNYIKAN SECARA DEFAULT) -->
            <div id="pesan-page" class="page-view">
                <div class="message-header">
                    <h2>Pesan</h2>
                    <button class="back-btn" onclick="showMainContent()">
                        <i class="fas fa-arrow-left"></i> Kembali
                    </button>
                </div>
                <div class="message-compose">
                    <textarea class="message-compose-input" placeholder="Tulis pesan..." id="messageInput"></textarea>
                    <button class="message-compose-btn" onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i> Kirim
                    </button>
                </div>
                <div class="message-list" id="messageList">
                    <div class="kas-empty">Memuat data pesan...</div>
                </div>
            </div>

            <!-- Halaman Pengaturan (DISEMBUNYIKAN SECARA DEFAULT) -->
            <div id="pengaturan-page" class="page-view">
                <div class="settings-header">
                    <h2>Pengaturan</h2>
                    <button class="back-btn" onclick="showMainContent()">
                        <i class="fas fa-arrow-left"></i> Kembali
                    </button>
                </div>
                <div class="settings-content">
                    <div class="settings-card">
                        <div class="settings-card-title">Notifikasi</div>
                        <div class="settings-item">
                            <div class="settings-item-label">Notifikasi Promo</div>
                            <div class="settings-toggle active" onclick="toggleSetting(this)">
                                <div class="settings-toggle-slider"></div>
                            </div>
                        </div>
                        <div class="settings-item">
                            <div class="settings-item-label">Notifikasi Event</div>
                            <div class="settings-toggle active" onclick="toggleSetting(this)">
                                <div class="settings-toggle-slider"></div>
                            </div>
                        </div>
                        <div class="settings-item">
                            <div class="settings-item-label">Notifikasi Pesan</div>
                            <div class="settings-toggle" onclick="toggleSetting(this)">
                                <div class="settings-toggle-slider"></div>
                            </div>
                        </div>
                    </div>
                    <div class="settings-card">
                        <div class="settings-card-title">Akun</div>
                        <div class="settings-item">
                            <div class="settings-item-label">Ganti Password</div>
                            <button class="settings-btn" onclick="showChangePasswordModal()">
                                <i class="fas fa-key"></i> Ubah
                            </button>
                        </div>
                        <div class="settings-item">
                            <div class="settings-item-label">Keluar</div>
                            <button class="settings-btn" onclick="logout()">
                                <i class="fas fa-sign-out-alt"></i> Keluar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Halaman Bantuan (DISEMBUNYIKAN SECARA DEFAULT) -->
            <div id="bantuan-page" class="page-view">
                <div class="help-header">
                    <h2>Bantuan</h2>
                    <button class="back-btn" onclick="showMainContent()">
                        <i class="fas fa-arrow-left"></i> Kembali
                    </button>
                </div>
                <div class="help-content">
                    <div class="help-card">
                        <div class="help-card-title">
                            <i class="fas fa-question-circle" style="color: #4285f4;"></i>
                            Tentang Aplikasi
                        </div>
                        <div class="help-card-content">
                            BGT PRO adalah aplikasi manajemen komunitas yang membantu mengelola kas, acara, dan komunikasi anggota.
                        </div>
                    </div>
                    <div class="help-card">
                        <div class="help-card-title">
                            <i class="fas fa-book" style="color: #4285f4;"></i>
                            Panduan Penggunaan
                        </div>
                        <div class="help-card-content">
                            1. Menu Home: Menampilkan informasi utama seperti event terdekat, banner, dan promo terbaru.<br>
                            2. Menu Kas: Mengelola transaksi kas, pinjaman, dan iuran.<br>
                            3. Menu Profil: Menampilkan informasi profil pengguna.<br>
                            4. Menu Peta: Menampilkan lokasi real-time anggota komunitas.<br>
                            5. Menu Pengaturan: Mengatur preferensi aplikasi dan akun.
                        </div>
                    </div>
                    <div class="help-card">
                        <div class="help-card-title">
                            <i class="fas fa-headset" style="color: #4285f4;"></i>
                            Hubungi Kami
                        </div>
                        <div class="help-card-content">
                            Jika Anda memerlukan bantuan lebih lanjut, silakan hubungi kami melalui:
                        </div>
                        <div class="help-contact">
                            <div class="help-contact-item">
                                <i class="fas fa-envelope"></i>
                                <span>support@bgtpro.com</span>
                            </div>
                            <div class="help-contact-item">
                                <i class="fas fa-phone"></i>
                                <span>+62 812-3456-7890</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="bottom-nav">
            <div class="nav-item active" onclick="handleNavClick(this, 'Home')">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </div>
            <div class="nav-item" onclick="handleNavClick(this, 'Explore')">
                <i class="fas fa-compass"></i>
                <span>Explore</span>
            </div>
            <div class="nav-item" onclick="handleNavClick(this, 'Activity')">
                <i class="fas fa-chart-line"></i>
                <span>Activity</span>
            </div>
            <div class="nav-item" onclick="handleNavClick(this, 'Profile')">
                <i class="fas fa-user"></i>
                <span>Profile</span>
            </div>
        </div>

        <div class="side-menu" id="sideMenu">
            <div class="side-menu-header">
                <div class="logo">Menu</div>
                <button class="close-menu" onclick="toggleMenu()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="side-menu-content">
                <div class="menu-item" onclick="handleMenuClick('Kas')"><i class="fas fa-wallet"></i><span>Kas</span></div>
                <div class="menu-item" onclick="handleMenuClick('Promo')"><i class="fas fa-tags"></i><span>Promo</span></div>
                <div class="menu-item" onclick="handleMenuClick('Peta')"><i class="fas fa-map-marked-alt"></i><span>Peta</span></div>
                <div class="menu-item" onclick="handleMenuClick('Pesan')"><i class="fas fa-envelope"></i><span>Pesan</span></div>
                <div class="menu-item" onclick="handleMenuClick('Pengaturan')"><i class="fas fa-cog"></i><span>Pengaturan</span></div>
                <div class="menu-item" onclick="handleMenuClick('Bantuan')"><i class="fas fa-question-circle"></i><span>Bantuan</span></div>
            </div>
        </div>

        <div class="overlay" id="overlay" onclick="toggleMenu()"></div>

        <div class="modal" id="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title" id="modalTitle">Detail</div>
                    <button class="modal-close" onclick="closeModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <img id="modalImage" class="modal-image" src="" alt="" style="display:none;">
                    <div class="modal-details">
                        <h3 id="modalDetailTitle"></h3>
                        <p id="modalDetailDesc"></p>
                        <button class="modal-action" onclick="handleModalAction()">Tutup</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Tambah Transaksi (DISEMBUNYIKAN SECARA DEFAULT) -->
        <div class="modal" id="addTransactionModal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title">Tambah Transaksi</div>
                    <button class="modal-close" onclick="closeAddTransactionModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="modal-details">
                        <div style="margin-bottom: 15px;">
                            <label for="transactionType" style="display: block; margin-bottom: 5px; font-size: 14px; color: #2c3e50;">Jenis Transaksi</label>
                            <select id="transactionType" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 10px; font-size: 14px;">
                                <option value="kas">Kas</option>
                                <option value="pinjaman">Pinjaman</option>
                                <option value="iuran">Iuran</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label for="transactionDescription" style="display: block; margin-bottom: 5px; font-size: 14px; color: #2c3e50;">Deskripsi</label>
                            <input type="text" id="transactionDescription" placeholder="Masukkan deskripsi transaksi" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 10px; font-size: 14px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label for="transactionAmount" style="display: block; margin-bottom: 5px; font-size: 14px; color: #2c3e50;">Jumlah (Rp)</label>
                            <input type="number" id="transactionAmount" placeholder="0" style="width: 100%; padding: 10px; border: 1px solid #e0e0e0; border-radius: 10px; font-size: 14px;">
                        </div>
                        <button class="modal-action" onclick="addTransaction()">Simpan</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Overlay Disrupsi (DISEMBUNYIKAN SECARA DEFAULT) -->
        <div id="disruption-overlay">
            <h1>DISRUPTED!</h1>
            <img src="512B.png" alt="Disrupted">
        </div>

        <div class="realtime-indicator" id="realtimeIndicator"></div>
        
        <div class="permission-guide" id="permissionGuide">
            <h4><i class="fas fa-exclamation-triangle"></i> Konfigurasi Izin Firebase</h4>
            <p>Untuk mengatasi error "Missing or insufficient permissions", ikuti langkah-langkah berikut:</p>
            <ol>
                <li>Buka <a href="https://console.firebase.google.com/" target="_blank" style="color: white; text-decoration: underline;">Firebase Console</a></li>
                <li>Pilih project <strong>bali-global-trans</strong></li>
                <li>Buka menu <strong>Firestore Database</strong></li>
                <li>Klik tab <strong>Rules</strong></li>
                <li>Ganti kode aturan dengan kode di bawah ini:</li>
            </ol>
            <code id="rulesCode">rules_version = '2';<br>service cloud.firestore {<br>&nbsp;&nbsp;match /databases/{database}/documents {<br>&nbsp;&nbsp;&nbsp;&nbsp;allow read: if request.auth != null;<br>&nbsp;&nbsp;&nbsp;&nbsp;allow write: if request.auth != null;<br>&nbsp;&nbsp;}<br>}</code>
            <button class="copy-btn" onclick="copyRulesCode()">Salin Kode</button>
            <p style="margin-top: 10px;">Klik <strong>Publish</strong> setelah mengganti kode aturan.</p>
        </div>
    </div>

    <!-- Leaflet JS untuk Peta -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCahZIFKFXMCokFNxCpFokNSVtKzN4llus",
            authDomain: "cedar-setup-425414-d7.firebaseapp.com",
            databaseURL: "https://cedar-setup-425414-d7-default-rtdb.firebaseio.com",
            projectId: "cedar-setup-425414-d7",
            storageBucket: "cedar-setup-425414-d7.firebasestorage.app",
            messagingSenderId: "723545991983",
            appId: "1:723545991983:web:379548d2b425a502a60fda",
            measurementId: "G-FPL6PF3KWJ"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();

        let currentSlide = 0;
        let firebaseErrorShown = false;
        let indexErrorShown = false;
        let currentUserData = null;
        let map = null;
        let userMarker = null;
        let markers = {};
        let locationWatchId = null;

        // --- FUNGSI UNTUK MENAMPILKAN/MENYEMBUNYIKAN HALAMAN ---
        function showMainContent() {
            document.getElementById('main-content').style.display = 'block';
            document.querySelectorAll('.page-view').forEach(page => page.classList.remove('active'));
            // Reset nav item ke 'Home'
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelector('.nav-item').classList.add('active');
        }

        function showProfilePage() {
            document.getElementById('main-content').style.display = 'none';
            document.querySelectorAll('.page-view').forEach(page => page.classList.remove('active'));
            document.getElementById('profile-page').classList.add('active');
            // Reset nav item ke 'Profile'
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.nav-item')[3].classList.add('active');
        }

        function showKasPage() {
            document.getElementById('main-content').style.display = 'none';
            document.querySelectorAll('.page-view').forEach(page => page.classList.remove('active'));
            document.getElementById('kas-page').classList.add('active');
            // Load data kas
            loadKasData();
        }

        function showPromoPage() {
            document.getElementById('main-content').style.display = 'none';
            document.querySelectorAll('.page-view').forEach(page => page.classList.remove('active'));
            document.getElementById('promo-page').classList.add('active');
            // Load data promo
            loadPromoDetails();
        }

        function showPetaPage() {
            document.getElementById('main-content').style.display = 'none';
            document.querySelectorAll('.page-view').forEach(page => page.classList.remove('active'));
            document.getElementById('peta-page').classList.add('active');
            // Initialize map
            if (!map) {
                initializeMap();
            } else {
                // Refresh map size when page is shown
                setTimeout(() => {
                    map.invalidateSize();
                    centerMapOnUser();
                }, 100);
            }
        }

        function showPesanPage() {
            document.getElementById('main-content').style.display = 'none';
            document.querySelectorAll('.page-view').forEach(page => page.classList.remove('active'));
            document.getElementById('pesan-page').classList.add('active');
            // Load messages
            loadMessages();
        }

        function showPengaturanPage() {
            document.getElementById('main-content').style.display = 'none';
            document.querySelectorAll('.page-view').forEach(page => page.classList.remove('active'));
            document.getElementById('pengaturan-page').classList.add('active');
        }

        function showBantuanPage() {
            document.getElementById('main-content').style.display = 'none';
            document.querySelectorAll('.page-view').forEach(page => page.classList.remove('active'));
            document.getElementById('bantuan-page').classList.add('active');
        }

        // --- FUNGSI UNTUK MEMUAT DATA USER DAN MENAMPILKANNYA ---
        function loadUserDataIntoUI(userData) {
            // Update foto profil di header
            const headerProfilePhoto = document.getElementById('headerProfilePhoto');
            const profilePageAvatar = document.getElementById('profilePageAvatar');
            const profilePageUsername = document.getElementById('profilePageUsername');
            const profilePageEmail = document.getElementById('profilePageEmail');
            const profilePageRole = document.getElementById('profilePageRole');

            const imageUrl = userData.profilePicUrl || 'https://picsum.photos/seed/default-user/100/100.jpg';
            if (imageUrl.startsWith('data:image')) {
                headerProfilePhoto.src = imageUrl;
                profilePageAvatar.src = imageUrl;
            } else {
                headerProfilePhoto.src = imageUrl;
                profilePageAvatar.src = imageUrl;
            }
            headerProfilePhoto.onerror = profilePageAvatar.onerror = function() {
                this.src = 'https://picsum.photos/seed/default-user/100/100.jpg';
            };
            
            profilePageUsername.textContent = userData.username || 'Tidak ada username';
            profilePageEmail.textContent = userData.email || 'Tidak ada email';
            profilePageRole.textContent = userData.role || 'anggota';
        }

        // --- FUNGSI UNTUK MENANGANI DISRUPSI ---
        function triggerDisruption() {
            document.getElementById('disruption-overlay').classList.add('active');
            // Mainkan suara gangguan jika ada (opsional, membutuhkan file audio)
            // const audio = new Audio('path/to/static-noise.mp3');
            // audio.play();
        }

        function stopDisruption() {
            document.getElementById('disruption-overlay').classList.remove('active');
        }

        // --- FUNGSI UNTUK MENANGANI DATA KAS ---
        async function loadKasData() {
            try {
                // Load total kas
                const kasSnapshot = await db.collection('kas').get();
                let totalKas = 0;
                const kasList = document.getElementById('kasList');
                kasList.innerHTML = '';
                
                if (kasSnapshot.empty) {
                    kasList.innerHTML = '<div class="kas-empty">Belum ada data kas</div>';
                } else {
                    kasSnapshot.forEach(doc => {
                        const data = doc.data();
                        totalKas += data.amount || 0;
                        
                        const kasItem = document.createElement('div');
                        kasItem.className = 'kas-item';
                        kasItem.innerHTML = `
                            <div class="kas-item-name">${data.description || 'Tanpa keterangan'}</div>
                            <div class="kas-item-amount ${data.amount >= 0 ? 'positive' : 'negative'}">
                                ${data.amount >= 0 ? '+' : ''}Rp ${Math.abs(data.amount).toLocaleString('id-ID')}
                            </div>
                        `;
                        kasList.appendChild(kasItem);
                    });
                }
                
                document.getElementById('totalKasAmount').textContent = `Rp ${totalKas.toLocaleString('id-ID')}`;
                
                // Load pinjaman
                const pinjamanSnapshot = await db.collection('pinjaman').get();
                let totalPinjaman = 0;
                const pinjamanList = document.getElementById('pinjamanList');
                pinjamanList.innerHTML = '';
                
                if (pinjamanSnapshot.empty) {
                    pinjamanList.innerHTML = '<div class="kas-empty">Belum ada data pinjaman</div>';
                } else {
                    pinjamanSnapshot.forEach(doc => {
                        const data = doc.data();
                        totalPinjaman += data.amount || 0;
                        
                        const pinjamanItem = document.createElement('div');
                        pinjamanItem.className = 'kas-item';
                        pinjamanItem.innerHTML = `
                            <div class="kas-item-name">${data.borrower || 'Tanpa nama'}</div>
                            <div class="kas-item-amount negative">
                                Rp ${data.amount.toLocaleString('id-ID')}
                            </div>
                        `;
                        pinjamanList.appendChild(pinjamanItem);
                    });
                }
                
                document.getElementById('pinjamanAmount').textContent = `Rp ${totalPinjaman.toLocaleString('id-ID')}`;
                
                // Load belum bayar kas
                const belumBayarSnapshot = await db.collection('belum_bayar_kas').get();
                let totalBelumBayar = 0;
                const belumBayarList = document.getElementById('belumBayarList');
                belumBayarList.innerHTML = '';
                
                if (belumBayarSnapshot.empty) {
                    belumBayarList.innerHTML = '<div class="kas-empty">Tidak ada yang belum bayar kas</div>';
                } else {
                    belumBayarSnapshot.forEach(doc => {
                        const data = doc.data();
                        totalBelumBayar += data.amount || 0;
                        
                        const belumBayarItem = document.createElement('div');
                        belumBayarItem.className = 'kas-item';
                        belumBayarItem.innerHTML = `
                            <div class="kas-item-name">${data.memberName || 'Tanpa nama'}</div>
                            <div class="kas-item-amount negative">
                                Rp ${data.amount.toLocaleString('id-ID')}
                            </div>
                        `;
                        belumBayarList.appendChild(belumBayarItem);
                    });
                }
                
                document.getElementById('belumBayarAmount').textContent = `Rp ${totalBelumBayar.toLocaleString('id-ID')}`;
                
                // Load iuran
                const iuranSnapshot = await db.collection('iuran').get();
                let totalIuran = 0;
                const iuranList = document.getElementById('iuranList');
                iuranList.innerHTML = '';
                
                if (iuranSnapshot.empty) {
                    iuranList.innerHTML = '<div class="kas-empty">Belum ada data iuran</div>';
                } else {
                    iuranSnapshot.forEach(doc => {
                        const data = doc.data();
                        totalIuran += data.amount || 0;
                        
                        const iuranItem = document.createElement('div');
                        iuranItem.className = 'kas-item';
                        iuranItem.innerHTML = `
                            <div class="kas-item-name">${data.description || 'Tanpa keterangan'}</div>
                            <div class="kas-item-amount positive">
                                +Rp ${data.amount.toLocaleString('id-ID')}
                            </div>
                        `;
                        iuranList.appendChild(iuranItem);
                    });
                }
                
                document.getElementById('iuranAmount').textContent = `Rp ${totalIuran.toLocaleString('id-ID')}`;
                
            } catch (error) {
                console.error("Error loading kas data:", error);
                handleFirebaseError(error);
            }
        }

        // --- FUNGSI UNTUK MENANGANI DATA PROMO ---
        async function loadPromoDetails() {
            const promoContent = document.getElementById('promoContent');
            promoContent.innerHTML = '<div class="kas-empty">Memuat data promo...</div>';
            
            try {
                const snapshot = await db.collection('promos').where('status', '==', 'active').get();
                
                if (snapshot.empty) {
                    promoContent.innerHTML = '<div class="kas-empty">Tidak ada promo aktif</div>';
                    return;
                }
                
                promoContent.innerHTML = '';
                
                snapshot.forEach(doc => {
                    const promo = doc.data();
                    const promoCard = document.createElement('div');
                    promoCard.className = 'promo-detail-card';
                    
                    const imageUrl = promo.imageUrl || '';
                    const expiryDate = promo.expiryDate ? new Date(promo.expiryDate.toDate()).toLocaleDateString('id-ID') : 'Tidak ada batas waktu';
                    
                    // PERBAIKAN: Menangani gambar base64
                    let imageHtml = '';
                    if (imageUrl) {
                        if (imageUrl.startsWith('data:image')) {
                            // Jika base64, gunakan langsung
                            imageHtml = `<img src="${imageUrl}" alt="${promo.title}" class="promo-detail-image">`;
                        } else if (imageUrl.startsWith('http')) {
                            // Jika URL HTTP, gunakan langsung
                            imageHtml = `<img src="${imageUrl}" alt="${promo.title}" class="promo-detail-image">`;
                        } else if (imageUrl.startsWith('gs://')) {
                            // Jika URL Firebase Storage, coba dapatkan URL unduhan
                            imageHtml = `<img src="" alt="${promo.title}" class="promo-detail-image" data-firebase-url="${imageUrl}">`;
                        }
                    }
                    
                    promoCard.innerHTML = `
                        ${imageHtml}
                        <div class="promo-detail-info">
                            <div class="promo-detail-title">${promo.title}</div>
                            <div class="promo-detail-desc">${promo.description}</div>
                            <div class="promo-detail-expiry">
                                <i class="fas fa-clock"></i> Berlaku hingga: ${expiryDate}
                            </div>
                        </div>
                    `;
                    
                    // Tambahkan event listener untuk menampilkan modal dengan data lengkap
                    promoCard.addEventListener('click', function() {
                        showModal('promo', promo.title, promo.description, imageUrl);
                    });
                    
                    promoContent.appendChild(promoCard);
                    
                    // Jika ada gambar Firebase Storage, coba dapatkan URL unduhan
                    const firebaseImage = promoCard.querySelector('img[data-firebase-url]');
                    if (firebaseImage) {
                        const firebaseUrl = firebaseImage.getAttribute('data-firebase-url');
                        getValidImageUrl(firebaseUrl).then(url => {
                            if (url) {
                                firebaseImage.src = url;
                            } else {
                                firebaseImage.style.display = 'none';
                            }
                        }).catch(error => {
                            console.error("Error loading Firebase image:", error);
                            firebaseImage.style.display = 'none';
                        });
                    }
                });
                
            } catch (error) {
                console.error("Error loading promo details:", error);
                handleFirebaseError(error);
                promoContent.innerHTML = '<div class="kas-empty">Gagal memuat data promo</div>';
            }
        }

        // --- FUNGSI UNTUK MENANGANI PESAN ---
        async function loadMessages() {
            const messageList = document.getElementById('messageList');
            messageList.innerHTML = '<div class="kas-empty">Memuat data pesan...</div>';
            
            try {
                const snapshot = await db.collection('messages').orderBy('timestamp', 'desc').get();
                
                if (snapshot.empty) {
                    messageList.innerHTML = '<div class="kas-empty">Tidak ada pesan</div>';
                    return;
                }
                
                messageList.innerHTML = '';
                
                snapshot.forEach(doc => {
                    const message = doc.data();
                    const messageItem = document.createElement('div');
                    messageItem.className = 'message-item';
                    
                    const senderName = message.senderName || 'Pengguna';
                    const timestamp = message.timestamp ? new Date(message.timestamp.toDate()).toLocaleString('id-ID') : '';
                    
                    messageItem.innerHTML = `
                        <div class="message-item-header">
                            <div class="message-item-sender">${senderName}</div>
                            <div class="message-item-time">${timestamp}</div>
                        </div>
                        <div class="message-item-content">${message.content}</div>
                    `;
                    
                    messageList.appendChild(messageItem);
                });
                
            } catch (error) {
                console.error("Error loading messages:", error);
                handleFirebaseError(error);
                messageList.innerHTML = '<div class="kas-empty">Gagal memuat data pesan</div>';
            }
        }

        async function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const content = messageInput.value.trim();
            
            if (!content) {
                showToast('Pesan tidak boleh kosong');
                return;
            }
            
            try {
                const user = auth.currentUser;
                if (!user) {
                    showToast('Anda harus login untuk mengirim pesan');
                    return;
                }
                
                // Get user data
                const userDoc = await db.collection('users').doc(user.uid).get();
                const userData = userDoc.exists ? userDoc.data() : {};
                const senderName = userData.username || 'Pengguna';
                
                // Add message to Firestore
                await db.collection('messages').add({
                    senderId: user.uid,
                    senderName: senderName,
                    content: content,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Clear input
                messageInput.value = '';
                
                // Reload messages
                loadMessages();
                
                showToast('Pesan terkirim');
                
            } catch (error) {
                console.error("Error sending message:", error);
                handleFirebaseError(error);
                showToast('Gagal mengirim pesan');
            }
        }

        // --- FUNGSI UNTUK MENANGANI PENGATURAN ---
        function toggleSetting(element) {
            element.classList.toggle('active');
            const settingName = element.previousElementSibling.textContent;
            const isActive = element.classList.contains('active');
            showToast(`${settingName} ${isActive ? 'diaktifkan' : 'dinonaktifkan'}`);
        }

        function showChangePasswordModal() {
            showModal('changePassword', 'Ubah Password', 'Fitur ini akan segera hadir');
        }

        function logout() {
            if (confirm('Apakah Anda yakin ingin keluar?')) {
                auth.signOut().then(() => {
                    window.location.href = 'index.html';
                }).catch(error => {
                    console.error("Error signing out:", error);
                    showToast('Gagal keluar');
                });
            }
        }

        // --- FUNGSI UNTUK MENANGANI TRANSAKSI ---
        function showAddTransactionModal() {
            document.getElementById('addTransactionModal').classList.add('active');
            document.querySelector('.app-container').style.overflow = 'hidden';
        }

        function closeAddTransactionModal() {
            document.getElementById('addTransactionModal').classList.remove('active');
            document.querySelector('.app-container').style.overflow = 'auto';
        }

        async function addTransaction() {
            const type = document.getElementById('transactionType').value;
            const description = document.getElementById('transactionDescription').value.trim();
            const amount = parseFloat(document.getElementById('transactionAmount').value);
            
            if (!description || isNaN(amount) || amount <= 0) {
                showToast('Mohon lengkapi semua field dengan benar');
                return;
            }
            
            try {
                const user = auth.currentUser;
                if (!user) {
                    showToast('Anda harus login untuk menambah transaksi');
                    return;
                }
                
                // Add transaction to appropriate collection
                let collectionName = 'kas';
                if (type === 'pinjaman') collectionName = 'pinjaman';
                else if (type === 'iuran') collectionName = 'iuran';
                
                const transactionData = {
                    amount: type === 'kas' && amount < 0 ? amount : Math.abs(amount),
                    description: description,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    userId: user.uid
                };
                
                if (type === 'pinjaman') {
                    transactionData.borrower = description; // For pinjaman, use description as borrower name
                    transactionData.description = `Pinjaman oleh ${description}`;
                }
                
                await db.collection(collectionName).add(transactionData);
                
                // Clear form
                document.getElementById('transactionDescription').value = '';
                document.getElementById('transactionAmount').value = '';
                
                // Close modal
                closeAddTransactionModal();
                
                // Reload kas data
                loadKasData();
                
                showToast('Transaksi berhasil ditambahkan');
                
            } catch (error) {
                console.error("Error adding transaction:", error);
                handleFirebaseError(error);
                showToast('Gagal menambah transaksi');
            }
        }

        // --- FUNGSI UNTUK MENANGANI PETA ---
        function initializeMap() {
            // Initialize the map
            map = L.map('map').setView([-6.2088, 106.8456], 13); // Default to Jakarta
            
            // Add tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            
            // Add locate control
            const locateBtn = document.getElementById('locateBtn');
            locateBtn.addEventListener('click', function() {
                centerMapOnUser();
            });
            
            // Add refresh control
            const refreshBtn = document.getElementById('refreshBtn');
            refreshBtn.addEventListener('click', function() {
                refreshLocations();
            });
            
            // Start tracking user location
            startLocationTracking();
            
            // Load other users' locations
            loadUserLocations();
        }
        
        function startLocationTracking() {
            if (!navigator.geolocation) {
                showToast('Geolocation tidak didukung oleh browser Anda');
                return;
            }
            
            // Get current position
            navigator.geolocation.getCurrentPosition(
                position => {
                    updateUserLocation(position.coords.latitude, position.coords.longitude);
                },
                error => {
                    console.error("Error getting location:", error);
                    showToast('Gagal mendapatkan lokasi Anda');
                }
            );
            
            // Watch position for real-time updates
            locationWatchId = navigator.geolocation.watchPosition(
                position => {
                    updateUserLocation(position.coords.latitude, position.coords.longitude);
                },
                error => {
                    console.error("Error watching location:", error);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: 0
                }
            );
        }
        
        function updateUserLocation(lat, lng) {
            const user = auth.currentUser;
            if (!user) return;
            
            // Update or create user marker
            if (userMarker) {
                userMarker.setLatLng([lat, lng]);
            } else {
                userMarker = L.marker([lat, lng], {
                    icon: L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    })
                }).addTo(map)
                .bindPopup('Lokasi Anda')
                .openPopup();
            }
            
            // Center map on user location
            map.setView([lat, lng], 15);
            
            // Save location to Firebase
            saveUserLocationToFirebase(lat, lng);
        }
        
        function saveUserLocationToFirebase(lat, lng) {
            const user = auth.currentUser;
            if (!user) return;
            
            // Get user data
            db.collection('users').doc(user.uid).get().then(doc => {
                if (doc.exists) {
                    const userData = doc.data();
                    const username = userData.username || 'Pengguna';
                    const profilePicUrl = userData.profilePicUrl || 'https://picsum.photos/seed/default-user/100/100.jpg';
                    
                    // Save location to Firebase
                    db.collection('user_locations').doc(user.uid).set({
                        userId: user.uid,
                        username: username,
                        profilePicUrl: profilePicUrl,
                        latitude: lat,
                        longitude: lng,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
            }).catch(error => {
                console.error("Error getting user data:", error);
            });
        }
        
        function loadUserLocations() {
            const locationList = document.getElementById('locationList');
            locationList.innerHTML = '<div class="kas-empty">Memuat lokasi anggota...</div>';
            
            // Listen for real-time updates
            db.collection('user_locations').onSnapshot(snapshot => {
                locationList.innerHTML = '';
                
                if (snapshot.empty) {
                    locationList.innerHTML = '<div class="kas-empty">Tidak ada lokasi anggota</div>';
                    return;
                }
                
                const user = auth.currentUser;
                const locations = [];
                
                snapshot.forEach(doc => {
                    const location = doc.data();
                    if (location.userId !== user.uid) { // Don't show current user in list
                        locations.push(location);
                        
                        // Add or update marker
                        if (markers[location.userId]) {
                            markers[location.userId].setLatLng([location.latitude, location.longitude]);
                        } else {
                            const marker = L.marker([location.latitude, location.longitude], {
                                icon: L.icon({
                                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                                    iconSize: [25, 41],
                                    iconAnchor: [12, 41],
                                    popupAnchor: [1, -34],
                                    shadowSize: [41, 41]
                                })
                            }).addTo(map)
                            .bindPopup(location.username);
                            
                            markers[location.userId] = marker;
                        }
                    }
                });
                
                // Update location list
                locations.forEach(location => {
                    const locationItem = document.createElement('div');
                    locationItem.className = 'location-item';
                    
                    const timestamp = location.timestamp ? new Date(location.timestamp.toDate()).toLocaleString('id-ID') : '';
                    const distance = calculateDistance(
                        userMarker ? userMarker.getLatLng().lat : 0,
                        userMarker ? userMarker.getLatLng().lng : 0,
                        location.latitude,
                        location.longitude
                    );
                    
                    locationItem.innerHTML = `
                        <img src="${location.profilePicUrl}" alt="${location.username}" class="location-item-avatar">
                        <div class="location-item-info">
                            <div class="location-item-name">${location.username}</div>
                            <div class="location-item-time">${timestamp}</div>
                        </div>
                        <div class="location-item-distance">${distance} km</div>
                    `;
                    
                    locationItem.addEventListener('click', function() {
                        map.setView([location.latitude, location.longitude], 15);
                        markers[location.userId].openPopup();
                    });
                    
                    locationList.appendChild(locationItem);
                });
                
                if (locations.length === 0) {
                    locationList.innerHTML = '<div class="kas-empty">Tidak ada lokasi anggota lain</div>';
                }
            }, error => {
                console.error("Error loading user locations:", error);
                handleFirebaseError(error);
                locationList.innerHTML = '<div class="kas-empty">Gagal memuat lokasi anggota</div>';
            });
        }
        
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of the earth in km
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const d = R * c; // Distance in km
            return d.toFixed(1);
        }
        
        function deg2rad(deg) {
            return deg * (Math.PI/180);
        }
        
        function centerMapOnUser() {
            if (userMarker) {
                map.setView(userMarker.getLatLng(), 15);
                userMarker.openPopup();
            } else {
                showToast('Lokasi Anda belum tersedia');
            }
        }
        
        function refreshLocations() {
            // Force refresh of user location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        updateUserLocation(position.coords.latitude, position.coords.longitude);
                        showToast('Lokasi diperbarui');
                    },
                    error => {
                        console.error("Error refreshing location:", error);
                        showToast('Gagal memperbarui lokasi');
                    }
                );
            }
        }

        // --- FUNGSI UNTUK MENAMPILKAN PROFIL ---
        function showProfile() {
            showProfilePage();
        }

        // --- FUNGSI UNTUK MENAMPILKAN NOTIFIKASI ---
        function showNotifications() {
            showModal('notifications', 'Notifikasi', 'Anda memiliki 3 notifikasi baru:\n\n1. Event KOPDAR RUTIN akan dimulai dalam 2 hari\n2. Promo diskon 20% untuk semua produk\n3. Pengumuman libur tanggal merah');
            const badge = document.querySelector('.notification-badge');
            if (badge) badge.style.display = 'none';
        }

        // --- HELPER FUNCTION UNTUK GAMBAR - DIPERBAIKI ---
        async function getValidImageUrl(imagePath) {
            if (!imagePath) return null;
            
            // Jika base64, kembalikan langsung
            if (imagePath.startsWith('data:image')) {
                return imagePath;
            }
            
            // Jika URL HTTP, kembalikan langsung
            if (imagePath.startsWith('http')) {
                return imagePath;
            }
            
            // Jika URL Firebase Storage, coba dapatkan URL unduhan
            if (imagePath.startsWith('gs://')) {
                try {
                    const storageRef = firebase.storage().refFromURL(imagePath);
                    return await storageRef.getDownloadURL();
                } catch (error) {
                    console.error("Gagal mendapatkan URL unduhan untuk:", imagePath, error);
                    return null;
                }
            }
            
            return null;
        }

        // --- FUNGSI-FUNGSI UTAMA APLIKASI ---
        async function loadBannersFromFirebase() {
            const container = document.getElementById('adminCarousel');
            const indicators = document.getElementById('carouselIndicators');
            container.innerHTML = ''; indicators.innerHTML = '';
            try {
                const snapshot = await db.collection('promos').where('status', '==', 'active').get();
                if (snapshot.empty) { container.innerHTML = '<p style="text-align:center; padding: 20px; color:#999;">Belum ada banner</p>'; return; }
                const banners = []; snapshot.forEach(doc => banners.push({ id: doc.id, ...doc.data() }));
                for (let index = 0; index < banners.length; index++) {
                    const banner = banners[index];
                    const slideDiv = document.createElement('div');
                    slideDiv.className = `carousel-slide ${index === 0 ? 'active' : ''}`;
                    
                    // PERBAIKAN: Menangani gambar base64
                    const imageUrl = banner.imageUrl || '';
                    let imageHtml = '';
                    
                    if (imageUrl) {
                        if (imageUrl.startsWith('data:image')) {
                            // Jika base64, gunakan langsung
                            imageHtml = `<img src="${imageUrl}" alt="${banner.title}">`;
                        } else if (imageUrl.startsWith('http')) {
                            // Jika URL HTTP, gunakan langsung
                            imageHtml = `<img src="${imageUrl}" alt="${banner.title}">`;
                        } else if (imageUrl.startsWith('gs://')) {
                            // Jika URL Firebase Storage, coba dapatkan URL unduhan
                            imageHtml = `<img src="" alt="${banner.title}" data-firebase-url="${imageUrl}">`;
                        }
                    }
                    
                    if (imageHtml) {
                        slideDiv.innerHTML = imageHtml + `
                            <div class="carousel-content">
                                <div class="carousel-title">${banner.title}</div>
                                <div class="carousel-desc">${banner.description}</div>
                            </div>
                        `;
                    } else {
                        slideDiv.innerHTML = `
                            <div style="display:flex;align-items:center;justify-content:center;height:100%;background:linear-gradient(135deg, #4285f4, #1a73e8);color:white;text-align:center;padding:20px;">
                                <div>
                                    <h2 style="margin-bottom:10px;">${banner.title}</h2>
                                    <p>${banner.description}</p>
                                </div>
                            </div>
                        `;
                    }
                    
                    // Tambahkan event listener untuk menampilkan modal dengan data lengkap
                    slideDiv.onclick = () => showModal('banner', banner.title, banner.description, imageUrl);
                    container.appendChild(slideDiv);
                    
                    const indicator = document.createElement('div');
                    indicator.className = `indicator ${index === 0 ? 'active' : ''}`;
                    indicator.onclick = () => goToSlide(index);
                    indicators.appendChild(indicator);
                    
                    // Jika ada gambar Firebase Storage, coba dapatkan URL unduhan
                    const firebaseImage = slideDiv.querySelector('img[data-firebase-url]');
                    if (firebaseImage) {
                        const firebaseUrl = firebaseImage.getAttribute('data-firebase-url');
                        getValidImageUrl(firebaseUrl).then(url => {
                            if (url) {
                                firebaseImage.src = url;
                            } else {
                                // Jika gagal memuat gambar, tampilkan fallback
                                firebaseImage.parentElement.innerHTML = `
                                    <div style="display:flex;align-items:center;justify-content:center;height:100%;background:linear-gradient(135deg, #4285f4, #1a73e8);color:white;text-align:center;padding:20px;">
                                        <div>
                                            <h2 style="margin-bottom:10px;">${banner.title}</h2>
                                            <p>${banner.description}</p>
                                        </div>
                                    </div>
                                `;
                            }
                        }).catch(error => {
                            console.error("Error loading Firebase image:", error);
                            // Jika gagal memuat gambar, tampilkan fallback
                            firebaseImage.parentElement.innerHTML = `
                                <div style="display:flex;align-items:center;justify-content:center;height:100%;background:linear-gradient(135deg, #4285f4, #1a73e8);color:white;text-align:center;padding:20px;">
                                    <div>
                                        <h2 style="margin-bottom:10px;">${banner.title}</h2>
                                        <p>${banner.description}</p>
                                    </div>
                                </div>
                            `;
                        });
                    }
                }
                if (banners.length > 1) setInterval(nextSlide, 5000);
            } catch (error) { console.error("Error loading banners:", error); handleFirebaseError(error); container.innerHTML = '<p style="text-align:center; padding: 20px; color:#999;">Gagal memuat banner</p>'; }
        }
        
        async function loadPromosFromFirebase() {
            const carousel = document.getElementById('promoCarousel');
            carousel.innerHTML = '';
            try {
                const snapshot = await db.collection('promos').where('status', '==', 'active').get();
                if (snapshot.empty) { carousel.innerHTML = '<p style="padding: 20px; color:#999;">Belum ada promo</p>'; return; }
                const promos = []; snapshot.forEach(doc => promos.push({ id: doc.id, ...doc.data() }));
                for (let i = 0; i < 2; i++) {
                    for (const promo of promos) {
                        const card = document.createElement('div');
                        const imageUrl = promo.imageUrl || '';
                        
                        // PERBAIKAN: Menangani gambar base64
                        let imageHtml = '';
                        if (imageUrl) {
                            if (imageUrl.startsWith('data:image')) {
                                // Jika base64, gunakan langsung
                                imageHtml = `<img src="${imageUrl}" alt="${promo.title}" class="promo-card-image">`;
                            } else if (imageUrl.startsWith('http')) {
                                // Jika URL HTTP, gunakan langsung
                                imageHtml = `<img src="${imageUrl}" alt="${promo.title}" class="promo-card-image">`;
                            } else if (imageUrl.startsWith('gs://')) {
                                // Jika URL Firebase Storage, coba dapatkan URL unduhan
                                imageHtml = `<img src="" alt="${promo.title}" class="promo-card-image" data-firebase-url="${imageUrl}">`;
                            }
                        }
                        
                        if (imageHtml) {
                            card.className = 'promo-card';
                            card.innerHTML = imageHtml + `
                                <div class="promo-card-info">
                                    <div class="promo-card-title">${promo.title}</div>
                                    <div class="promo-card-desc">${promo.description}</div>
                                </div>
                            `;
                        } else {
                            card.className = 'promo-card promo-card-no-image';
                            card.innerHTML = `
                                <div class="promo-card-info">
                                    <div class="promo-card-title">${promo.title}</div>
                                    <div class="promo-card-desc">${promo.description}</div>
                                </div>
                            `;
                        }
                        
                        // Tambahkan event listener untuk menampilkan modal dengan data lengkap
                        card.onclick = () => showModal('promo', promo.title, promo.description, imageUrl);
                        carousel.appendChild(card);
                        
                        // Jika ada gambar Firebase Storage, coba dapatkan URL unduhan
                        const firebaseImage = card.querySelector('img[data-firebase-url]');
                        if (firebaseImage) {
                            const firebaseUrl = firebaseImage.getAttribute('data-firebase-url');
                            getValidImageUrl(firebaseUrl).then(url => {
                                if (url) {
                                    firebaseImage.src = url;
                                } else {
                                    // Jika gagal memuat gambar, sembunyikan dan tambahkan class no-image
                                    firebaseImage.style.display = 'none';
                                    card.classList.add('promo-card-no-image');
                                }
                            }).catch(error => {
                                console.error("Error loading Firebase image:", error);
                                // Jika gagal memuat gambar, sembunyikan dan tambahkan class no-image
                                firebaseImage.style.display = 'none';
                                card.classList.add('promo-card-no-image');
                            });
                        }
                    }
                }
            } catch (error) { console.error("Error loading promos:", error); handleFirebaseError(error); carousel.innerHTML = '<p style="padding: 20px; color:#999;">Gagal memuat promo</p>'; }
        }
        
        async function loadEventsFromFirebase() {
            const eventSection = document.getElementById('eventSection');
            const eventImage = document.getElementById('eventImage');
            const eventTitle = document.getElementById('eventTitle');
            const eventTime = document.getElementById('eventTime');
            eventSection.style.display = 'block'; eventImage.style.display = 'none'; eventSection.classList.remove('event-section-no-image');
            try {
                const snapshot = await db.collection('events').where('status', '==', 'active').get();
                if (snapshot.empty) { console.log("Tidak ada event aktif ditemukan di Firebase. Menampilkan default."); eventTitle.innerHTML = '<i class="fas fa-calendar-alt" style="color: #4285f4;"></i> KOPDAR RUTIN'; eventTime.innerHTML = '<i class="fas fa-clock" style="font-size: 12px;"></i> Sabtu, 20:00 WIB'; return; }
                const events = []; snapshot.forEach(doc => { const eventData = { id: doc.id, ...doc.data() }; if (eventData.startDate) { events.push(eventData); } });
                events.sort((a, b) => { const dateA = a.startDate.toDate(); const dateB = b.startDate.toDate(); return dateA - dateB; });
                const event = events.length > 0 ? events[0] : null;
                if (!event) { eventTitle.innerHTML = '<i class="fas fa-calendar-alt" style="color: #4285f4;"></i> KOPDAR RUTIN'; eventTime.innerHTML = '<i class="fas fa-clock" style="font-size: 12px;"></i> Sabtu, 20:00 WIB'; return; }
                console.log("Event ditemukan:", event);
                
                // PERBAIKAN: Menangani gambar base64
                const imageUrl = event.imageUrl || '';
                if (imageUrl) {
                    if (imageUrl.startsWith('data:image')) {
                        // Jika base64, gunakan langsung
                        eventImage.src = imageUrl;
                        eventImage.style.display = 'block';
                    } else if (imageUrl.startsWith('http')) {
                        // Jika URL HTTP, gunakan langsung
                        eventImage.src = imageUrl;
                        eventImage.style.display = 'block';
                    } else if (imageUrl.startsWith('gs://')) {
                        // Jika URL Firebase Storage, coba dapatkan URL unduhan
                        getValidImageUrl(imageUrl).then(url => {
                            if (url) {
                                eventImage.src = url;
                                eventImage.style.display = 'block';
                            } else {
                                eventImage.style.display = 'none';
                                eventSection.classList.add('event-section-no-image');
                            }
                        }).catch(error => {
                            console.error("Error loading event image:", error);
                            eventImage.style.display = 'none';
                            eventSection.classList.add('event-section-no-image');
                        });
                    }
                } else {
                    eventImage.style.display = 'none';
                    eventSection.classList.add('event-section-no-image');
                }
                
                eventImage.onerror = function() { 
                    this.onerror=null; 
                    this.style.display='none'; 
                    eventSection.classList.add('event-section-no-image'); 
                    console.error("Gambar event gagal dimuat, menyembunyikan gambar."); 
                };
                
                eventTitle.innerHTML = `<i class="fas fa-calendar-alt" style="color: #4285f4;"></i> ${event.name || 'KOPDAR RUTIN'}`;
                if (event.startDate) {
                    try {
                        const eventDate = new Date(event.startDate.toDate());
                        const formattedDate = eventDate.toLocaleString('id-ID', { weekday: 'long', hour: '2-digit', minute: '2-digit' });
                        eventTime.innerHTML = `<i class="fas fa-clock" style="font-size: 12px;"></i> ${formattedDate}`;
                    } catch (e) { eventTime.innerHTML = '<i class="fas fa-clock" style="font-size: 12px;"></i> Sabtu, 20:00 WIB'; }
                } else { eventTime.innerHTML = '<i class="fas fa-clock" style="font-size: 12px;"></i> Sabtu, 20:00 WIB'; }
                
                // Tambahkan event listener untuk menampilkan modal dengan data lengkap
                eventSection.onclick = () => showModal('event', event.name || 'KOPDAR RUTIN', event.description || 'Kopdar rutin mingguan komunitas BGT PRO', imageUrl);
            } catch (error) {
                console.error("Error loading events:", error);
                if (error.message.includes("The query requires an index")) { handleIndexError(error); } else { handleFirebaseError(error); }
                eventTitle.innerHTML = '<i class="fas fa-calendar-alt" style="color: #4285f4;"></i> KOPDAR RUTIN';
                eventTime.innerHTML = '<i class="fas fa-clock" style="font-size: 12px;"></i> Sabtu, 20:00 WIB';
            }
        }
        
        function updateBalanceFromFirebase() {
            // DIUBAH: Tidak lagi memperbarui balance di navbar
        }
        
        function setupKasRealtimeListener() {
            db.collection('kas').onSnapshot((snapshot) => {
                if (!snapshot.metadata.hasPendingWrites) { updateBalanceFromFirebase(); showRealtimeIndicator(); }
            }, (error) => { console.error("Error in kas listener:", error); handleFirebaseError(error); });
        }
        
        function setupRealtimeListeners() {
            setupKasRealtimeListener();
            db.collection('promos').onSnapshot((snapshot) => {
                if (!snapshot.metadata.hasPendingWrites) { loadBannersFromFirebase(); loadPromosFromFirebase(); }
            }, (error) => { console.error("Error in promos listener:", error); handleFirebaseError(error); });
            db.collection('events').onSnapshot((snapshot) => {
                if (!snapshot.metadata.hasPendingWrites) { loadEventsFromFirebase(); }
            }, (error) => { console.error("Error in events listener:", error); if (error.message.includes("The query requires an index")) { handleIndexError(error); } else { handleFirebaseError(error); } });
        }
        
        function handleFirebaseError(error) {
            if (firebaseErrorShown) return;
            firebaseErrorShown = true;
            const existingError = document.querySelector('.error-message');
            if (existingError) existingError.remove();
            if (error.message.includes("permission-denied")) {
                const permissionGuide = document.getElementById('permissionGuide');
                permissionGuide.classList.add('active');
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i><span>Anda tidak memiliki izin untuk mengakses data. Lihat panduan di bawah untuk mengatasi masalah ini.</span>`;
                document.getElementById('main-content').insertBefore(errorDiv, document.querySelector('.event-section'));
            } else {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i><span>Terjadi kesalahan saat mengambil data: ${error.message}</span>`;
                document.getElementById('main-content').insertBefore(errorDiv, document.querySelector('.event-section'));
            }
        }
        
        function handleIndexError(error) {
            if (indexErrorShown) return;
            indexErrorShown = true;
            const existingError = document.querySelector('.error-message');
            if (existingError) existingError.remove();
            const urlMatch = error.message.match(/https:\/\/console\.firebase\.google\.com[^\s]+/);
            const indexUrl = urlMatch ? urlMatch[0] : 'https://console.firebase.google.com/';
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i><span>Query memerlukan indeks Firebase. <a href="${indexUrl}" target="_blank">Buat indeks di sini</a></span>`;
            document.getElementById('main-content').insertBefore(errorDiv, document.querySelector('.event-section'));
        }
        
        function copyRulesCode() {
            const rulesCode = document.getElementById('rulesCode').innerText;
            navigator.clipboard.writeText(rulesCode).then(() => { showToast('Kode aturan disalin!'); }).catch(err => { console.error('Gagal menyalin kode: ', err); showToast('Gagal menyalin kode'); });
        }
        
        function toggleMenu() {
            const sideMenu = document.getElementById('sideMenu');
            const overlay = document.getElementById('overlay');
            sideMenu.classList.toggle('active');
            overlay.classList.toggle('active');
            const appContainer = document.querySelector('.app-container');
            appContainer.style.overflow = sideMenu.classList.contains('active') ? 'hidden' : 'auto';
        }
        
        function handleMenuClick(item) {
            if (item === 'Kas') {
                showKasPage();
            } else if (item === 'Promo') {
                showPromoPage();
            } else if (item === 'Peta') {
                showPetaPage();
            } else if (item === 'Pesan') {
                showPesanPage();
            } else if (item === 'Pengaturan') {
                showPengaturanPage();
            } else if (item === 'Bantuan') {
                showBantuanPage();
            }
            toggleMenu();
        }
        
        function showModal(type, title, description, image = null) {
            const modal = document.getElementById('modal');
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalDetailTitle').textContent = title;
            document.getElementById('modalDetailDesc').textContent = description;
            const modalImage = document.getElementById('modalImage');
            
            // PERBAIKAN: Menangani gambar base64 di modal
            if (image) {
                if (image.startsWith('data:image')) {
                    // Jika base64, gunakan langsung
                    modalImage.src = image;
                    modalImage.style.display = 'block';
                } else if (image.startsWith('http')) {
                    // Jika URL HTTP, gunakan langsung
                    modalImage.src = image;
                    modalImage.style.display = 'block';
                } else if (image.startsWith('gs://')) {
                    // Jika URL Firebase Storage, coba dapatkan URL unduhan
                    getValidImageUrl(image).then(url => {
                        if (url) {
                            modalImage.src = url;
                            modalImage.style.display = 'block';
                        } else {
                            modalImage.style.display = 'none';
                        }
                    }).catch(error => {
                        console.error("Error loading modal image:", error);
                        modalImage.style.display = 'none';
                    });
                }
            } else {
                modalImage.style.display = 'none';
            }
            
            modalImage.onerror = function() { 
                this.onerror = null; 
                this.style.display = 'none'; 
            };
            
            modal.classList.add('active');
            document.querySelector('.app-container').style.overflow = 'hidden';
        }
        
        function closeModal() {
            document.getElementById('modal').classList.remove('active');
            document.querySelector('.app-container').style.overflow = 'auto';
        }
        
        function handleModalAction() { closeModal(); }
        
        function handleNavClick(element, section) {
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            element.classList.add('active');
            if (section === 'Profile') {
                showProfilePage();
            } else if (section === 'Home') {
                showMainContent();
            } else {
                showToast(`Navigasi ke ${section}`);
            }
        }
        
        function showToast(message) {
            let toast = document.getElementById('toast');
            if (!toast) {
                toast = document.createElement('div'); toast.id = 'toast';
                toast.style.cssText = 'position:absolute; bottom:80px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.8); color:white; padding:10px 20px; border-radius:20px; z-index:1001; opacity:0; transition:all 0.3s; font-size:13px; font-weight:600; backdrop-filter:blur(10px;';
                document.querySelector('.phone-container').appendChild(toast);
            }
            toast.textContent = message;
            toast.style.opacity = '1'; toast.style.transform = 'translateX(-50%) translateY(-10px)';
            setTimeout(() => { toast.style.opacity = '0'; toast.style.transform = 'translateX(-50%) translateY(0)'; }, 2500);
        }
        
        function showRealtimeIndicator() {
            const indicator = document.getElementById('realtimeIndicator');
            indicator.classList.add('active');
            setTimeout(() => { indicator.classList.remove('active'); }, 2000);
        }
        
        function nextSlide() {
            const slides = document.querySelectorAll('.carousel-slide'); const indicators = document.querySelectorAll('.indicator');
            if(slides.length === 0) return;
            slides[currentSlide].classList.remove('active'); indicators[currentSlide].classList.remove('active');
            currentSlide = (currentSlide + 1) % slides.length;
            slides[currentSlide].classList.add('active'); indicators[currentSlide].classList.add('active');
        }
        
        function goToSlide(index) {
            const slides = document.querySelectorAll('.carousel-slide'); const indicators = document.querySelectorAll('.indicator');
            if(slides.length === 0) return;
            slides[currentSlide].classList.remove('active'); indicators[currentSlide].classList.remove('active');
            currentSlide = index;
            slides[currentSlide].classList.add('active'); indicators[currentSlide].classList.add('active');
        }

        // --- INISIALISASI APLIKASI (DENGAN LISTENER UNTUK PM) ---
        auth.onAuthStateChanged(user => {
            if (user) {
                console.log("User logged in:", user.uid);
                
                // 1. Load data user untuk pertama kali
                db.collection('users').doc(user.uid).get().then(doc => {
                    if (doc.exists) {
                        currentUserData = doc.data();
                        loadUserDataIntoUI(currentUserData);
                        
                        // 2. Setup real-time listener untuk PM
                        db.collection('users').doc(user.uid).onSnapshot(doc => {
                            const updatedUserData = doc.data();
                            if (updatedUserData.pmStatus === 'disrupted') {
                                triggerDisruption();
                            } else {
                                stopDisruption();
                            }
                        }, error => {
                            console.error("Error listening for PM status:", error);
                            stopDisruption(); // Hapus gangguan jika ada error
                        });

                    } else {
                        console.error("User document not found!");
                        currentUserData = { username: 'Anggota', email: user.email, profilePicUrl: 'https://picsum.photos/seed/default-user/100/100.jpg' };
                        loadUserDataIntoUI(currentUserData);
                    }
                }).catch((error) => {
                    console.error("Error getting user document:", error);
                    handleFirebaseError(error);
                });

                // 3. Load konten aplikasi
                loadEventsFromFirebase();
                loadBannersFromFirebase();
                loadPromosFromFirebase();
                updateBalanceFromFirebase();
                setupRealtimeListeners();
                
                document.body.style.opacity = '0';
                document.body.style.transition = 'opacity 0.5s';
                setTimeout(() => { document.body.style.opacity = '1'; }, 100);
            } else {
                console.log("No user logged in. Redirecting to login page...");
                window.location.href = 'index.html';
            }
        });

        window.onclick = function(event) { 
            if (event.target === document.getElementById('modal')) closeModal();
            if (event.target === document.getElementById('addTransactionModal')) closeAddTransactionModal();
        }
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                if (document.getElementById('sideMenu').classList.contains('active')) toggleMenu();
                if (document.getElementById('modal').classList.contains('active')) closeModal();
                if (document.getElementById('addTransactionModal').classList.contains('active')) closeAddTransactionModal();
                if (document.getElementById('disruption-overlay').classList.contains('active')) {
                    stopDisruption(); // Biarkan gangguan dengan tombol ESC
                }
            }
        });
    </script>
</body>
</html>
