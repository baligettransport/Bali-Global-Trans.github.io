<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Pesan - BGT PRO</title>
    
    <!-- External Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
    
    <!-- JsBarcode -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    
    <style>
        /* CSS Variables */
        :root {
            --whatsapp-bg: #f0f2f5;
            --whatsapp-sidebar: #111b21;
            --whatsapp-chat-bg: #efeae2;
            --whatsapp-msg-sent: #d9fdd3;
            --whatsapp-msg-received: #fff;
            --whatsapp-green: #25d366;
            --whatsapp-dark: #202c33;
            --whatsapp-header: #0b141a;
            --whatsapp-hover: #182229;
        }
        
        /* Global Styles */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; 
            background-color: #000; 
            color: var(--whatsapp-dark); 
            width: 100vw;
            height: 100vh; 
            height: 100dvh; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            overflow: hidden; 
        }
        
        /* Phone Container */
        .phone-container { 
            width: 100%; 
            height: 100%; 
            background-color: var(--whatsapp-bg); 
            position: relative; 
            overflow: hidden; 
            display: flex;
        }
        
        .whatsapp-container {
            display: flex;
            flex-direction: row;
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        /* --- SIDEBAR --- */
        .whatsapp-sidebar {
            background-color: var(--whatsapp-sidebar);
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            flex-shrink: 0;
            z-index: 10;
        }
        
        /* --- CHAT WINDOW --- */
        .whatsapp-chat-window {
            display: none; 
            flex-direction: column;
            background-color: var(--whatsapp-chat-bg);
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-size: cover;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 20;
        }
        
        .whatsapp-chat-window.active {
            display: flex;
            animation: slideIn 0.1s ease-out; /* Cepat */
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        
        /* --- MEMBERS LIST --- */
        .members-list {
            display: none;
            flex-direction: column;
            height: 100%;
            background-color: #f0f2f5;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 30;
            animation: fadeIn 0.1s;
        }
        
        .members-list.active {
            display: flex;
        }

        /* --- MESSAGE MENU POPUP (Baru) --- */
        .message-menu {
            position: absolute;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            width: 150px;
            display: none;
            flex-direction: column;
            z-index: 2000;
            overflow: hidden;
            animation: fadeInMenu 0.15s ease-out;
        }

        @keyframes fadeInMenu {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .menu-item {
            padding: 12px 15px;
            font-size: 14px;
            color: #111b21;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.2s;
        }

        .menu-item:hover {
            background-color: #f5f6f6;
        }

        .menu-item.delete { color: #dc3545; }
        .menu-item.delete:hover { background-color: #ffebeb; }
        
        /* --- REPLY BOX (Baru) --- */
        .reply-box {
            display: none;
            background-color: var(--whatsapp-header);
            padding: 8px 10px;
            border-left: 4px solid var(--whatsapp-green);
            flex-direction: column;
            justify-content: center;
            font-size: 12px;
            color: #e9edef;
            position: relative;
        }

        .reply-box.active { display: flex; }

        .reply-text-preview {
            color: #8696a0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 80%;
        }

        .reply-close-btn {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #8696a0;
            cursor: pointer;
            font-size: 16px;
        }
        
        /* --- UI COMPONENTS --- */
        .whatsapp-back-btn {
            display: block; 
            margin-right: 15px;
            color: #8696a0;
            font-size: 20px;
            cursor: pointer;
        }
        
        /* Header Styles */
        .whatsapp-sidebar-header, .whatsapp-chat-header, .members-header {
            padding: 10px 16px;
            display: flex;
            align-items: center;
            background-color: var(--whatsapp-header);
            color: white;
            height: 60px;
            flex-shrink: 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        
        .whatsapp-user-profile {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 5px;
            border-radius: 8px;
            flex-grow: 1;
        }
        
        .whatsapp-chat-header img, 
        .whatsapp-user-profile img,
        .whatsapp-profile-header img {
            width: 40px !important;
            height: 40px !important;
            border-radius: 50% !important;
            object-fit: cover !important;
            max-width: 40px !important;
            max-height: 40px !important;
            border: 1px solid rgba(255,255,255,0.1) !important;
            flex-shrink: 0;
        }

        #whatsapp-profile-pic-large {
            width: 100px !important;
            height: 100px !important;
            border-radius: 50% !important;
            object-fit: cover !important;
            border: 3px solid white !important;
        }
        
        .whatsapp-user-profile-name {
            font-size: 16px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .whatsapp-sidebar-header .icons {
            display: flex;
            gap: 20px;
            font-size: 18px;
            cursor: pointer;
            color: #8696a0;
        }
        
        /* Tabs & Search */
        .whatsapp-filter-tabs {
            display: flex;
            background-color: var(--whatsapp-header);
            color: #8696a0;
            padding: 0 16px;
            height: 44px;
            align-items: center;
            flex-shrink: 0;
        }
        
        .whatsapp-filter-tab {
            padding: 6px 12px;
            margin-right: 15px;
            cursor: pointer;
            font-size: 14px;
            border-radius: 10px;
        }
        
        .whatsapp-filter-tab.active {
            background-color: var(--whatsapp-hover);
            color: white;
        }
        
        .whatsapp-search-box {
            padding: 8px 12px;
            background-color: var(--whatsapp-header);
            flex-shrink: 0;
        }
        
        .whatsapp-search-box input {
            width: 100%;
            padding: 8px 12px;
            border-radius: 8px;
            background-color: var(--whatsapp-hover);
            border: none;
            color: #e9edef;
            outline: none;
            font-size: 14px;
        }
        
        /* List Items */
        .whatsapp-chat-list {
            flex-grow: 1;
            overflow-y: auto;
        }
        
        .whatsapp-chat-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            cursor: pointer;
            color: white;
            transition: background 0.2s;
        }
        
        .whatsapp-chat-item:hover {
            background-color: var(--whatsapp-hover);
        }
        
        .whatsapp-chat-item img {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            margin-right: 13px;
            object-fit: cover;
        }
        
        .whatsapp-chat-item-details {
            flex-grow: 1;
            display: flex;
            justify-content: space-between;
            overflow: hidden;
        }
        
        .whatsapp-chat-item-details h4 {
            font-size: 16px;
            font-weight: 400;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .whatsapp-chat-item-details p {
            font-size: 13px;
            color: #8696a0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 180px;
        }
        
        /* Chat Header */
        .whatsapp-chat-header .info {
            flex-grow: 1;
            overflow: hidden;
        }
        
        .whatsapp-chat-header .info h3 {
            font-size: 16px;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .whatsapp-chat-header .info p {
            font-size: 12px;
            color: #8696a0;
        }
        
        .whatsapp-chat-header .icons {
            display: flex;
            gap: 20px;
            font-size: 18px;
            color: #8696a0;
        }
        
        /* Messages */
        .whatsapp-messages {
            flex-grow: 1;
            padding: 15px 10px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        .whatsapp-message {
            display: flex;
            margin-bottom: 8px;
            max-width: 80%;
            position: relative;
        }
        
        .whatsapp-message.sent {
            align-self: flex-end;
            flex-direction: column;
            align-items: flex-end;
        }
        
        .whatsapp-message.received {
            align-self: flex-start;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .whatsapp-message-bubble {
            padding: 8px 12px;
            border-radius: 7.5px;
            line-height: 1.4;
            font-size: 14px;
            word-wrap: break-word;
            cursor: pointer; /* Indicate clickable */
            user-select: none;
            position: relative;
        }
        
        /* Highlight selected message */
        .whatsapp-message-bubble.selected {
            box-shadow: 0 0 0 2px var(--whatsapp-green);
        }
        
        .whatsapp-message.sent .whatsapp-message-bubble {
            background-color: var(--whatsapp-msg-sent);
        }
        
        .whatsapp-message.received .whatsapp-message-bubble {
            background-color: var(--whatsapp-msg-received);
        }
        
        .whatsapp-message-time {
            font-size: 10px;
            color: #999;
            margin-top: 2px;
            margin-left: 5px;
            float: right;
        }

        /* Reply context visual inside chat */
        .reply-context {
            font-size: 11px;
            color: #555;
            border-left: 3px solid rgba(0,0,0,0.2);
            padding-left: 5px;
            margin-bottom: 4px;
            font-style: italic;
            opacity: 0.8;
            display: block;
        }
        
        /* Input Area */
        .whatsapp-chat-input {
            padding: 8px 12px;
            background-color: var(--whatsapp-header);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .input-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 5px;
        }
        
        .whatsapp-chat-input i {
            color: #8696a0;
            font-size: 22px;
            cursor: pointer;
        }
        
        .whatsapp-chat-input input {
            flex-grow: 1;
            border: none;
            background-color: var(--whatsapp-hover);
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 14px;
            outline: none;
            color: white;
        }
        
        .whatsapp-chat-input button {
            background-color: var(--whatsapp-green);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Welcome & Profile Views */
        .whatsapp-welcome-screen, .whatsapp-profile-view {
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            color: #8696a0;
            text-align: center;
            padding: 20px;
        }

        .whatsapp-welcome-screen.active, .whatsapp-profile-view.active {
            display: flex;
        }
        
        .whatsapp-profile-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .whatsapp-profile-details {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            width: 100%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .whatsapp-detail-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #f0f2f5;
            font-size: 14px;
        }
        
        .whatsapp-edit-btn {
            background-color: var(--whatsapp-green);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 20px;
            width: 100%;
        }

        /* Members List Styles */
        .members-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .member-item {
            display: flex;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            cursor: pointer;
        }
        
        .member-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 15px;
            object-fit: cover;
        }
        
        .member-info {
            flex-grow: 1;
            overflow: hidden;
        }
        
        .member-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--whatsapp-dark);
            margin-bottom: 2px;
        }
        
        .member-status {
            font-size: 12px;
            color: #667781;
        }
    </style>
</head>
<body>
    <div class="phone-container">
        <div class="whatsapp-container">
            <!-- Sidebar Area -->
            <aside class="whatsapp-sidebar" id="whatsapp-sidebar">
                <header class="whatsapp-sidebar-header">
                    <div class="whatsapp-user-profile" id="whatsapp-user-profile">
                        <!-- Placeholder Default -->
                        <img src="https://ui-avatars.com/api/?name=User&background=random" alt="Profile" id="whatsapp-sidebar-profile-pic">
                        <span class="whatsapp-user-profile-name" id="whatsapp-sidebar-username">Pengguna</span>
                    </div>
                    <div class="icons">
                        <i class="fas fa-sign-out-alt" id="btn-logout"></i>
                    </div>
                </header>
                
                <div class="whatsapp-filter-tabs">
                    <div class="whatsapp-filter-tab active" data-filter="all">Semua</div>
                    <div class="whatsapp-filter-tab" data-filter="unread">Belum baca</div>
                    <div class="whatsapp-filter-tab" data-filter="groups">Grup</div>
                </div>
                
                <div class="whatsapp-search-box">
                    <input type="text" placeholder="Cari..." id="whatsapp-search-input">
                </div>
                
                <!-- Chat List -->
                <div class="whatsapp-chat-list" id="whatsapp-chat-list">
                    <!-- Akan diisi JS -->
                </div>
            </aside>

            <!-- Chat Area -->
            <main class="whatsapp-chat-window" id="whatsapp-chat-window">
                <header class="whatsapp-chat-header">
                    <i class="fas fa-arrow-left whatsapp-back-btn" id="whatsapp-back-btn"></i>
                    <img src="https://ui-avatars.com/api/?name=User&background=random" alt="Profile" id="whatsapp-chat-profile-img">
                    <div class="info">
                        <h3 id="whatsapp-chat-name">BGT PRO</h3>
                        <p id="whatsapp-chat-status">Aplikasi Pesan Real-Time</p>
                    </div>
                    <div class="icons">
                        <i class="fas fa-video"></i>
                        <i class="fas fa-phone"></i>
                    </div>
                </header>
                
                <!-- Welcome Screen -->
                <div class="whatsapp-messages" id="whatsapp-messages">
                    <div class="whatsapp-welcome-screen active" id="whatsapp-welcome-screen">
                        <i class="fab fa-whatsapp" style="font-size: 48px; margin-bottom: 20px; color: #25d366;"></i>
                        <h3>Selamat datang di BGT PRO</h3>
                        <p>Pilih anggota untuk mulai chatting</p>
                    </div>
                </div>
                
                <!-- Context Menu (Hidden by default) -->
                <div id="message-menu" class="message-menu">
                    <div class="menu-item" onclick="whatsappApp.handleMenuAction('edit')">
                        <i class="fas fa-edit"></i> Edit
                    </div>
                    <div class="menu-item" onclick="whatsappApp.handleMenuAction('reply')">
                        <i class="fas fa-reply"></i> Balas
                    </div>
                    <div class="menu-item" onclick="whatsappApp.handleMenuAction('forward')">
                        <i class="fas fa-share"></i> Teruskan
                    </div>
                    <div class="menu-item delete" onclick="whatsappApp.handleMenuAction('delete')">
                        <i class="fas fa-trash"></i> Hapus
                    </div>
                </div>
                
                <!-- Profile View -->
                <div class="whatsapp-messages whatsapp-profile-view" id="whatsapp-profile-view">
                    <div class="whatsapp-profile-content">
                        <div class="whatsapp-profile-header">
                            <img src="https://ui-avatars.com/api/?name=User&background=random" alt="Profile" id="whatsapp-profile-pic-large">
                            <h2 id="whatsapp-profile-username">Pengguna</h2>
                            <div style="margin-top: 10px; display: flex; gap: 10px; align-items: center; justify-content: center;">
                                <p id="whatsapp-profile-role" style="color: #667781;">Anggota</p>
                                <svg id="whatsapp-barcode"></svg>
                            </div>
                        </div>
                        
                        <div class="whatsapp-profile-details">
                            <h3 style="margin-bottom: 15px;">Profil Saya</h3>
                            <div class="whatsapp-detail-item">
                                <span>Email</span>
                                <span id="whatsapp-detail-email">-</span>
                            </div>
                            <div class="whatsapp-detail-item">
                                <span>Telepon</span>
                                <span id="whatsapp-detail-phone">-</span>
                            </div>
                            <div class="whatsapp-detail-item">
                                <span>Status</span>
                                <span id="whatsapp-detail-status">-</span>
                            </div>
                        </div>
                        
                        <button class="whatsapp-edit-btn" id="whatsapp-view-members-btn">Lihat Anggota Terdaftar</button>
                    </div>
                </div>
                
                <div class="whatsapp-chat-input" id="whatsapp-chat-input-area" style="display: none;">
                    <!-- Reply Bar (Hidden by default) -->
                    <div id="reply-box" class="reply-box">
                        <span style="font-weight: bold; margin-bottom: 2px;">Membalas pesan</span>
                        <div class="reply-text-preview" id="reply-preview-text">...</div>
                        <i class="fas fa-times reply-close-btn" onclick="whatsappApp.closeReply()"></i>
                    </div>

                    <div class="input-row">
                        <i class="fas fa-smile"></i>
                        <i class="fas fa-paperclip"></i>
                        <input type="text" id="whatsapp-message-input" placeholder="Ketik pesan">
                        <i class="fas fa-microphone" id="whatsapp-mic-icon"></i>
                        <button id="whatsapp-send-btn" style="display: none;"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </main>
            
            <!-- Members List View -->
            <div class="members-list" id="members-list">
                <header class="members-header">
                    <i class="fas fa-arrow-left" id="members-back-btn"></i>
                    <h3>Anggota Terdaftar</h3>
                </header>
                <div class="members-content" id="members-content">
                    <!-- Akan diisi JS -->
                </div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCahZIFKFXMCokFNxCpFokNSVtKzN4llus",
            authDomain: "cedar-setup-425414-d7.firebaseapp.com",
            databaseURL: "https://cedar-setup-425414-d7-default-rtdb.firebaseio.com",
            projectId: "cedar-setup-425414-d7",
            storageBucket: "cedar-setup-425414-d7.firebasestorage.app",
            messagingSenderId: "723545991983",
            appId: "1:723545991983:web:379548d2b425a502a60fda",
            measurementId: "G-FPL6PF3KWJ"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        const whatsappApp = {
            state: {
                activeChatId: null,
                activeFilter: 'all',
                chats: [],
                messages: {},
                currentUserData: null,
                registeredMembers: [],
                selectedMessageId: null, // ID pesan yang sedang dipilih/diklik
                replyingTo: null // { id, text } jika sedang mode balas
            },

            init() {
                if (localStorage.getItem('bgtProSession') !== 'active') {
                    window.location.href = 'dashboard_anggota.html';
                    return;
                }

                this.renderChatList();
                this.renderMembersContent();

                auth.onAuthStateChanged(user => {
                    if (user) {
                        this.loadUserData(user.uid);
                        this.initUI();
                        this.loadRegisteredMembers();
                    } else {
                        window.location.href = 'dashboard_anggota.html';
                    }
                });
                
                // Klik di mana saja untuk menutup menu
                document.addEventListener('click', (e) => {
                    const menu = document.getElementById('message-menu');
                    if (!e.target.closest('.message-menu') && !e.target.closest('.whatsapp-message-bubble')) {
                        menu.style.display = 'none';
                        this.removeSelectionHighlight();
                    }
                });
            },

            async loadUserData(userId) {
                try {
                    const doc = await db.collection('users').doc(userId).get();
                    if (doc.exists) {
                        this.state.currentUserData = { id: doc.id, ...doc.data() };
                        this.updateProfileUI();
                    }
                } catch (e) { console.error(e); }
            },

            async loadRegisteredMembers() {
                try {
                    const snapshot = await db.collection('users').get();
                    this.state.registeredMembers = [];
                    snapshot.forEach(doc => {
                        if (doc.id !== auth.currentUser.uid) {
                            this.state.registeredMembers.push({ id: doc.id, ...doc.data() });
                        }
                    });
                    this.generateSampleChats();
                } catch (e) { 
                    console.error(e);
                    this.renderChatList();
                }
            },

            generateSampleChats() {
                this.state.chats = this.state.registeredMembers.map((member, index) => ({
                    id: member.id,
                    name: member.username || 'Anggota',
                    avatar: member.profilePicUrl || `https://ui-avatars.com/api/?name=${member.username}&background=random`,
                    lastMessage: 'Klik untuk chat',
                    time: '',
                    unread: 0,
                    isGroup: false,
                    userId: member.id
                }));
                this.renderChatList();
            },

            updateProfileUI() {
                const user = this.state.currentUserData;
                if (!user) return;
                
                const imgUrl = user.profilePicUrl || `https://ui-avatars.com/api/?name=${user.username || 'User'}&background=random`;
                
                document.getElementById('whatsapp-sidebar-profile-pic').src = imgUrl;
                document.getElementById('whatsapp-profile-pic-large').src = imgUrl;
                document.getElementById('whatsapp-sidebar-username').textContent = user.username || 'Pengguna';
                document.getElementById('whatsapp-profile-username').textContent = user.username || 'Pengguna';
                document.getElementById('whatsapp-profile-role').textContent = user.role || 'Anggota';
                document.getElementById('whatsapp-detail-email').textContent = user.email || '-';
                document.getElementById('whatsapp-detail-phone').textContent = user.phone || '-';
                document.getElementById('whatsapp-detail-status').textContent = user.status || 'Aktif';

                JsBarcode("#whatsapp-barcode", user.id, { format: "CODE128", width: 1.5, height: 30, displayValue: false });
            },

            initUI() {
                const userProfile = document.getElementById('whatsapp-user-profile');
                const viewMembersBtn = document.getElementById('whatsapp-view-members-btn');
                const membersBackBtn = document.getElementById('members-back-btn');
                const chatBackBtn = document.getElementById('whatsapp-back-btn');
                const logoutBtn = document.getElementById('btn-logout');
                const filterTabs = document.querySelectorAll('.whatsapp-filter-tab');
                const searchInput = document.getElementById('whatsapp-search-input');
                const msgInput = document.getElementById('whatsapp-message-input');
                const sendBtn = document.getElementById('whatsapp-send-btn');
                const micIcon = document.getElementById('whatsapp-mic-icon');

                userProfile.addEventListener('click', () => this.showScreen('profile'));

                viewMembersBtn.addEventListener('click', () => this.showMembersListInstant());

                membersBackBtn.addEventListener('click', () => {
                    window.location.href = 'dashboard_anggota.html';
                });

                chatBackBtn.addEventListener('click', () => {
                    window.location.href = 'pesan.html';
                });

                logoutBtn.addEventListener('click', () => {
                    localStorage.removeItem('bgtProSession');
                    window.location.href = 'dashboard_anggota.html';
                });

                filterTabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        filterTabs.forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        this.state.activeFilter = tab.dataset.filter;
                        this.renderChatList();
                    });
                });

                searchInput.addEventListener('input', (e) => this.renderChatList(e.target.value));

                msgInput.addEventListener('input', (e) => {
                    if (e.target.value.trim()) {
                        sendBtn.style.display = 'flex';
                        micIcon.style.display = 'none';
                    } else {
                        sendBtn.style.display = 'none';
                        micIcon.style.display = 'block';
                    }
                });

                sendBtn.addEventListener('click', () => this.sendMessage());
                msgInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') this.sendMessage(); });
            },

            // --- MENU LOGIC START ---

            showMenu(e, messageId, bubbleEl) {
                e.stopPropagation(); // Mencegah event bubbling

                this.state.selectedMessageId = messageId;
                this.highlightBubble(bubbleEl);

                const menu = document.getElementById('message-menu');
                
                // Posisi Menu
                // Kita gunakan posisi relatif terhadap container utama atau fixed
                // Agar sederhana dan responsif, kita letakkan sedikit di atas atau di samping jari klik
                const rect = bubbleEl.getBoundingClientRect();
                const containerRect = document.querySelector('.whatsapp-chat-window').getBoundingClientRect();
                
                // Default posisi
                let top = rect.top - containerRect.top - 100; 
                let left = rect.left - containerRect.left - 50;

                // Batas agar tidak keluar layar (sederhana)
                if (top < 10) top = rect.bottom - containerRect.top + 10;
                if (left < 10) left = 10;
                
                menu.style.top = `${top}px`;
                menu.style.left = `${left}px`;
                menu.style.display = 'flex';
            },

            highlightBubble(bubbleEl) {
                document.querySelectorAll('.whatsapp-message-bubble').forEach(el => el.classList.remove('selected'));
                if(bubbleEl) bubbleEl.classList.add('selected');
            },

            removeSelectionHighlight() {
                document.querySelectorAll('.whatsapp-message-bubble').forEach(el => el.classList.remove('selected'));
            },

            handleMenuAction(action) {
                const menu = document.getElementById('message-menu');
                menu.style.display = 'none';
                
                const chatId = this.state.activeChatId;
                const msgId = this.state.selectedMessageId;
                const msgObj = this.state.messages[chatId].find(m => m.id === msgId);

                if (!msgObj) return;

                switch (action) {
                    case 'delete':
                        this.deleteMessage(chatId, msgId);
                        break;
                    case 'edit':
                        this.editMessage(chatId, msgId, msgObj.text);
                        break;
                    case 'reply':
                        this.enableReplyMode(msgObj);
                        break;
                    case 'forward':
                        this.forwardMessage(msgObj.text);
                        break;
                }
                this.removeSelectionHighlight();
            },

            async deleteMessage(chatId, msgId) {
                // Filter out message
                const updatedMessages = this.state.messages[chatId].filter(m => m.id !== msgId);
                this.state.messages[chatId] = updatedMessages;
                this.renderMessages(chatId);

                // Update Firestore (overwrite for simplicity in array of objects)
                try {
                    await db.collection('chats').doc(chatId).update({
                        messages: updatedMessages,
                        lastUpdated: new Date()
                    });
                } catch (e) {
                    console.error("Gagal menghapus:", e);
                    alert("Gagal menghapus pesan");
                }
            },

            async editMessage(chatId, msgId, currentText) {
                const newText = prompt("Edit pesan:", currentText);
                if (newText && newText.trim() !== "") {
                    const msgIndex = this.state.messages[chatId].findIndex(m => m.id === msgId);
                    if (msgIndex > -1) {
                        this.state.messages[chatId][msgIndex].text = newText;
                        this.state.messages[chatId][msgIndex].edited = true; // Tandai diedit
                        this.renderMessages(chatId);

                        // Update Firestore
                        try {
                            await db.collection('chats').doc(chatId).update({
                                messages: this.state.messages[chatId],
                                lastUpdated: new Date()
                            });
                        } catch (e) { console.error("Gagal edit:", e); }
                    }
                }
            },

            enableReplyMode(msgObj) {
                this.state.replyingTo = msgObj;
                const replyBox = document.getElementById('reply-box');
                const previewText = document.getElementById('reply-preview-text');
                
                replyBox.classList.add('active');
                previewText.textContent = msgObj.text;
                document.getElementById('whatsapp-message-input').focus();
            },

            closeReply() {
                this.state.replyingTo = null;
                document.getElementById('reply-box').classList.remove('active');
            },

            forwardMessage(text) {
                // Fitur teruskan sederhana: copy teks ke input
                const input = document.getElementById('whatsapp-message-input');
                input.value = text;
                input.focus();
                
                // Tampilkan tombol kirim
                document.getElementById('whatsapp-send-btn').style.display = 'flex';
                document.getElementById('whatsapp-mic-icon').style.display = 'none';
                
                // Opsional: Tampilkan toast atau feedback
                // alert("Pesan disalin ke kolom input. Pilih kontak lain untuk mengirim.");
            },
            // --- MENU LOGIC END ---

            showMembersListInstant() {
                this.showScreen('welcome');
                document.getElementById('members-list').classList.add('active');
                document.getElementById('whatsapp-chat-window').classList.remove('active');
                this.renderMembersContent();
            },

            renderMembersContent() {
                const container = document.getElementById('members-content');
                container.innerHTML = '';

                if(this.state.registeredMembers.length === 0) {
                    container.innerHTML = '<p style="text-align:center; color:#667781; padding:20px;">Tidak ada anggota lain.</p>';
                    return;
                }

                this.state.registeredMembers.forEach(member => {
                    const item = document.createElement('div');
                    item.className = 'member-item';
                    const avatarUrl = member.profilePicUrl || `https://ui-avatars.com/api/?name=${member.username}&background=random`;

                    item.innerHTML = `
                        <img src="${avatarUrl}" class="member-avatar">
                        <div class="member-info">
                            <div class="member-name">${member.username || 'Tanpa Nama'}</div>
                            <div class="member-status">Klik untuk chat</div>
                        </div>
                        <i class="fas fa-comment-dots" style="color: #8696a0;"></i>
                    `;

                    item.addEventListener('click', () => this.openChatFromMembers(member));
                    container.appendChild(item);
                });
            },

            openChatFromMembers(member) {
                let chat = this.state.chats.find(c => c.userId === member.id);
                if (!chat) {
                    chat = {
                        id: member.id,
                        name: member.username,
                        avatar: member.profilePicUrl || `https://ui-avatars.com/api/?name=${member.username}&background=random`,
                        lastMessage: '',
                        userId: member.id
                    };
                }
                this.openChat(chat);
            },

            openChat(chat) {
                const chatWindow = document.getElementById('whatsapp-chat-window');
                document.getElementById('whatsapp-chat-name').textContent = chat.name;
                document.getElementById('whatsapp-chat-status').textContent = 'Online';
                const imgElement = document.getElementById('whatsapp-chat-profile-img');
                imgElement.src = chat.avatar;

                document.getElementById('whatsapp-welcome-screen').classList.remove('active');
                document.getElementById('whatsapp-profile-view').classList.remove('active');
                document.getElementById('whatsapp-chat-input-area').style.display = 'flex';

                chatWindow.classList.add('active');
                document.getElementById('members-list').classList.remove('active');

                this.state.activeChatId = chat.id;
                this.loadMessages(chat.id);
                setTimeout(() => document.getElementById('whatsapp-message-input').focus(), 300);
                
                // Tutup menu jika terbuka
                document.getElementById('message-menu').style.display = 'none';
                this.closeReply();
            },

            showScreen(screenName) {
                const welcome = document.getElementById('whatsapp-welcome-screen');
                const profile = document.getElementById('whatsapp-profile-view');
                const chatName = document.getElementById('whatsapp-chat-name');
                const chatImg = document.getElementById('whatsapp-chat-profile-img');

                if (screenName === 'welcome') {
                    welcome.classList.add('active');
                    profile.classList.remove('active');
                    chatName.textContent = 'BGT PRO';
                    chatImg.src = document.getElementById('whatsapp-sidebar-profile-pic').src;
                    document.getElementById('whatsapp-chat-input-area').style.display = 'none';
                } else if (screenName === 'profile') {
                    welcome.classList.remove('active');
                    profile.classList.add('active');
                    chatName.textContent = 'Profil Saya';
                    chatImg.src = this.state.currentUserData?.profilePicUrl || '';
                    document.getElementById('whatsapp-chat-input-area').style.display = 'none';
                }
            },

            loadMessages(chatId) {
                const container = document.getElementById('whatsapp-messages');
                if (!this.state.messages[chatId]) {
                    this.state.messages[chatId] = [];
                }
                this.renderMessages(chatId);

                db.collection('chats').doc(chatId).onSnapshot(doc => {
                    if (doc.exists && doc.data().messages) {
                        this.state.messages[chatId] = doc.data().messages;
                        this.renderMessages(chatId);
                    }
                });
            },

            renderMessages(chatId) {
                const container = document.getElementById('whatsapp-messages');
                const msgs = this.state.messages[chatId] || [];
                
                let bubbleContainer = document.getElementById('bubble-container');
                if(!bubbleContainer) {
                    bubbleContainer = document.createElement('div');
                    bubbleContainer.id = 'bubble-container';
                    bubbleContainer.style.flexDirection = 'column';
                    bubbleContainer.style.display = 'flex';
                    bubbleContainer.style.width = '100%';
                    container.appendChild(bubbleContainer);
                }
                
                // Simpan scroll position untuk auto-scroll hanya jika user di paling bawah
                const isAtBottom = container.scrollHeight - container.scrollTop === container.clientHeight;

                bubbleContainer.innerHTML = '';

                msgs.forEach(msg => {
                    const isMe = msg.senderId === auth.currentUser.uid || msg.senderId === 'me';
                    const el = document.createElement('div');
                    el.className = `whatsapp-message ${isMe ? 'sent' : 'received'}`;
                    
                    // Menangani pesan reply (jika ada replyTo data)
                    let replyHtml = '';
                    if (msg.replyTo && msg.replyTo.text) {
                        replyHtml = `<span class="reply-context">"${msg.replyTo.text}"</span>`;
                    }

                    // Menangani pesan edit (jika ada edited flag)
                    const timeHtml = `<div class="whatsapp-message-time">${msg.edited ? 'Diedit ' : ''}10:00</div>`;

                    // Tambahkan data-id untuk tracking klik menu
                    // Menggunakan div pembungkus bubble untuk memisahkan area klik bubble dan waktu
                    el.innerHTML = `
                        <div class="whatsapp-message-bubble" data-id="${msg.id}">
                            ${replyHtml}
                            ${msg.text}
                            ${timeHtml}
                        </div>
                    `;
                    
                    // Event Listener untuk Menu
                    const bubble = el.querySelector('.whatsapp-message-bubble');
                    bubble.addEventListener('click', (e) => {
                        // Hanya milik kita yang bisa diedit/dihapus (opsional, di sini semua pesan bisa diklik untuk menu)
                        // if (isMe) ... (uncomment jika ingin batasi fitur edit/hapus hanya milik sendiri)
                        this.showMenu(e, msg.id, bubble);
                    });

                    bubbleContainer.appendChild(el);
                });
                
                if (isAtBottom) {
                    container.scrollTop = container.scrollHeight;
                }
            },

            async sendMessage() {
                const input = document.getElementById('whatsapp-message-input');
                const text = input.value.trim();
                if (!text || !this.state.activeChatId) return;

                // Siapkan objek pesan
                const newMsg = { 
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 9), // ID Unik
                    text: text, 
                    senderId: auth.currentUser.uid, 
                    timestamp: new Date() 
                };

                // Jika sedang mode balas
                if (this.state.replyingTo) {
                    newMsg.replyTo = {
                        id: this.state.replyingTo.id,
                        text: this.state.replyingTo.text
                    };
                    this.closeReply();
                }

                // Update lokal langsung (optimistic UI)
                this.state.messages[this.state.activeChatId].push(newMsg);
                this.renderMessages(this.state.activeChatId);
                
                input.value = '';
                document.getElementById('whatsapp-send-btn').style.display = 'none';
                document.getElementById('whatsapp-mic-icon').style.display = 'block';

                // Kirim ke Firebase
                try {
                    await db.collection('chats').doc(this.state.activeChatId).set({
                        messages: this.state.messages[this.state.activeChatId],
                        lastUpdated: new Date()
                    }, { merge: true });
                } catch (e) { console.error(e); }
            },

            renderChatList(filterText = '') {
                const list = document.getElementById('whatsapp-chat-list');
                list.innerHTML = '';
                
                if (this.state.chats.length === 0) {
                    list.innerHTML = '<p style="text-align:center; color:#667781; padding:20px; font-size:14px;">Belum ada percakapan.</p>';
                    return;
                }

                const filtered = this.state.chats.filter(c => {
                    const matchesFilter = (this.state.activeFilter === 'all') || (this.state.activeFilter === 'unread' && c.unread > 0) || (this.state.activeFilter === 'groups' && c.isGroup);
                    const matchesSearch = c.name.toLowerCase().includes(filterText.toLowerCase());
                    return matchesFilter && matchesSearch;
                });

                if (filtered.length === 0) {
                    list.innerHTML = '<p style="text-align:center; color:#667781; padding:20px; font-size:14px;">Tidak ditemukan.</p>';
                    return;
                }

                filtered.forEach(chat => {
                    const item = document.createElement('div');
                    item.className = 'whatsapp-chat-item';
                    item.innerHTML = `
                        <img src="${chat.avatar}">
                        <div class="whatsapp-chat-item-details">
                            <div class="whatsapp-chat-item-info">
                                <h4>${chat.name}</h4>
                                <p>${chat.lastMessage}</p>
                            </div>
                            <div class="whatsapp-chat-item-meta">
                                <div class="whatsapp-chat-item-time">${chat.time}</div>
                            </div>
                        </div>
                    `;
                    item.addEventListener('click', () => this.openChat(chat));
                    list.appendChild(item);
                });
            }
        };

        document.addEventListener('DOMContentLoaded', () => whatsappApp.init());
    </script>
</body>
</html>
