<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Pesan - BGT PRO</title>
    
    <!-- External Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
    
    <!-- JsBarcode -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    
    <style>
        /* CSS Variables */
        :root {
            --whatsapp-bg: #f0f2f5;
            --whatsapp-sidebar: #111b21;
            --whatsapp-chat-bg: #efeae2;
            --whatsapp-msg-sent: #d9fdd3;
            --whatsapp-msg-received: #fff;
            --whatsapp-green: #25d366;
            --whatsapp-dark: #202c33;
            --whatsapp-header: #0b141a;
            --whatsapp-hover: #182229;
            --recording-red: #dc3545;
            --selection-bar-bg: #2a3942;
        }
        
        /* Global Styles */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; 
            background-color: #000; 
            color: var(--whatsapp-dark); 
            width: 100vw;
            height: 100vh; 
            height: 100dvh; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            overflow: hidden; 
        }
        
        /* Phone Container */
        .phone-container { 
            width: 100%; 
            height: 100%; 
            background-color: var(--whatsapp-bg); 
            position: relative; 
            overflow: hidden; 
            display: flex;
        }
        
        .whatsapp-container {
            display: flex;
            flex-direction: row;
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        /* --- SIDEBAR --- */
        .whatsapp-sidebar {
            background-color: var(--whatsapp-sidebar);
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            flex-shrink: 0;
            z-index: 10;
        }
        
        /* --- CHAT WINDOW --- */
        .whatsapp-chat-window {
            display: none; 
            flex-direction: column;
            background-color: var(--whatsapp-chat-bg);
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-size: cover;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 20;
        }
        
        .whatsapp-chat-window.active {
            display: flex;
            animation: slideIn 0.1s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }

        /* --- SELECTION BAR (Long Press) --- */
        .whatsapp-selection-bar {
            display: none;
            background-color: var(--selection-bar-bg);
            padding: 10px 15px;
            align-items: center;
            justify-content: space-between;
            height: 60px;
            z-index: 26;
            flex-shrink: 0;
        }
        
        .whatsapp-selection-bar.active {
            display: flex;
        }

        .selection-info {
            color: white;
            font-size: 16px;
            font-weight: 500;
        }

        .selection-actions {
            display: flex;
            gap: 20px;
            color: white;
        }
        
        .selection-actions i {
            font-size: 20px;
            cursor: pointer;
        }

        /* --- DELETE CONFIRMATION POPUP (Bottom Sheet) --- */
        .delete-popup {
            display: none;
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: white;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            z-index: 100;
            padding: 20px;
            animation: slideUp 0.2s ease-out;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
        }

        .delete-popup.active { display: block; }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .delete-title {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
            color: var(--whatsapp-dark);
        }

        .delete-option {
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            color: #333;
            font-size: 16px;
        }
        
        .delete-option.cancel { color: var(--whatsapp-green); font-weight: bold; text-align: center; border-bottom: none; }
        
        /* --- MEMBERS LIST --- */
        .members-list {
            display: none;
            flex-direction: column;
            height: 100%;
            background-color: #f0f2f5;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 30;
            animation: fadeIn 0.1s;
        }
        
        .members-list.active {
            display: flex;
        }

        /* --- CAMERA MODAL (Navbar) --- */
        .camera-modal {
            display: none;
            position: absolute;
            top: 60px;
            right: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 200;
            width: 160px;
            flex-direction: column;
            overflow: hidden;
        }

        .camera-modal.active { display: flex; }

        .camera-option {
            padding: 12px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            color: #111b21;
            transition: background 0.2s;
        }
        
        .camera-option:hover { background: #f5f6f6; }

        /* --- CAMERA CAPTURE UI --- */
        .camera-capture-ui {
            display: none;
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            z-index: 250;
            flex-direction: column;
        }
        .camera-capture-ui.active { display: flex; }

        .camera-video-container {
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }

        #camera-preview-video {
            position: absolute;
            min-width: 100%;
            min-height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }
        
        .ratio-bulat #camera-preview-video { width: 300px; height: 300px; border-radius: 50%; object-fit: cover; min-width: auto; min-height: auto; }
        .ratio-potret #camera-preview-video { width: 300px; height: 400px; object-fit: cover; min-width: auto; min-height: auto; }
        .ratio-lanskap #camera-preview-video { width: 350px; height: 200px; object-fit: cover; min-width: auto; min-height: auto; }

        .camera-controls {
            height: 100px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            background: #111;
        }

        .shutter-btn {
            width: 60px; height: 60px;
            border-radius: 50%;
            border: 4px solid white;
            background: transparent;
            cursor: pointer;
            position: relative;
        }
        .shutter-btn:active { background: white; }

        .camera-close-btn { color: white; font-size: 24px; cursor: pointer; }

        /* --- AUDIO RECORDING OVERLAY --- */
        .recording-overlay {
            display: none;
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 30px;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            align-items: center;
            gap: 15px;
            width: 90%;
            max-width: 300px;
            justify-content: space-between;
        }
        .recording-overlay.active { display: flex; }
        .recording-time { font-family: monospace; font-size: 16px; }
        .recording-stop {
            width: 40px; height: 40px; background: var(--recording-red); border-radius: 50%;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            box-shadow: 0 0 10px rgba(220, 53, 69, 0.5);
        }
        .recording-stop i { color: white; }

        /* --- EMOJI PICKER --- */
        .whatsapp-emoji-picker {
            display: none;
            position: absolute;
            bottom: 80px;
            left: 10px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            padding: 10px;
            grid-template-columns: repeat(6, 1fr);
            gap: 5px;
            width: 280px;
            z-index: 2000;
            max-height: 200px;
            overflow-y: auto;
        }
        .whatsapp-emoji-picker.active { display: grid; }
        .emoji-btn {
            font-size: 24px;
            cursor: pointer;
            text-align: center;
            padding: 5px;
            border-radius: 5px;
            transition: background 0.2s;
        }
        .emoji-btn:hover { background-color: #f0f2f5; }

        /* --- MESSAGE MENU POPUP (Click) --- */
        .message-menu {
            position: absolute;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            width: 150px;
            display: none;
            flex-direction: column;
            z-index: 2000;
            overflow: hidden;
            animation: fadeInMenu 0.15s ease-out;
        }

        @keyframes fadeInMenu {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .menu-item {
            padding: 12px 15px;
            font-size: 14px;
            color: #111b21;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.2s;
        }

        .menu-item:hover { background-color: #f5f6f6; }
        .menu-item.delete { color: #dc3545; }
        .menu-item.delete:hover { background-color: #ffebeb; }
        
        /* --- REPLY BOX --- */
        .reply-box {
            display: none;
            background-color: var(--whatsapp-header);
            padding: 8px 10px;
            border-left: 4px solid var(--whatsapp-green);
            flex-direction: column;
            justify-content: center;
            font-size: 12px;
            color: #e9edef;
            position: relative;
        }

        .reply-box.active { display: flex; }

        .reply-text-preview {
            color: #8696a0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 80%;
        }

        .reply-close-btn {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #8696a0;
            cursor: pointer;
            font-size: 16px;
        }
        
        /* --- UI COMPONENTS --- */
        .whatsapp-back-btn {
            display: block; 
            margin-right: 15px;
            color: #8696a0;
            font-size: 20px;
            cursor: pointer;
        }
        
        /* Header Styles */
        .whatsapp-sidebar-header, .whatsapp-chat-header, .members-header {
            padding: 10px 16px;
            display: flex;
            align-items: center;
            background-color: var(--whatsapp-header);
            color: white;
            height: 60px;
            flex-shrink: 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        
        .whatsapp-user-profile {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 5px;
            border-radius: 8px;
            flex-grow: 1;
        }
        
        .whatsapp-chat-header img, 
        .whatsapp-user-profile img,
        .whatsapp-profile-header img {
            width: 40px !important;
            height: 40px !important;
            border-radius: 50% !important;
            object-fit: cover !important;
            max-width: 40px !important;
            max-height: 40px !important;
            border: 1px solid rgba(255,255,255,0.1) !important;
            flex-shrink: 0;
        }

        #whatsapp-profile-pic-large {
            width: 100px !important;
            height: 100px !important;
            border-radius: 50% !important;
            object-fit: cover !important;
            border: 3px solid white !important;
        }
        
        .whatsapp-user-profile-name {
            font-size: 16px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .whatsapp-sidebar-header .icons {
            display: flex;
            gap: 20px;
            font-size: 18px;
            cursor: pointer;
            color: #8696a0;
        }
        
        /* Tabs & Search */
        .whatsapp-filter-tabs {
            display: flex;
            background-color: var(--whatsapp-header);
            color: #8696a0;
            padding: 0 16px;
            height: 44px;
            align-items: center;
            flex-shrink: 0;
        }
        
        .whatsapp-filter-tab {
            padding: 6px 12px;
            margin-right: 15px;
            cursor: pointer;
            font-size: 14px;
            border-radius: 10px;
        }
        
        .whatsapp-filter-tab.active {
            background-color: var(--whatsapp-hover);
            color: white;
        }
        
        .whatsapp-search-box {
            padding: 8px 12px;
            background-color: var(--whatsapp-header);
            flex-shrink: 0;
        }
        
        .whatsapp-search-box input {
            width: 100%;
            padding: 8px 12px;
            border-radius: 8px;
            background-color: var(--whatsapp-hover);
            border: none;
            color: #e9edef;
            outline: none;
            font-size: 14px;
        }
        
        /* List Items */
        .whatsapp-chat-list {
            flex-grow: 1;
            overflow-y: auto;
        }
        
        .whatsapp-chat-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            cursor: pointer;
            color: white;
            transition: background 0.2s;
        }
        
        .whatsapp-chat-item:hover {
            background-color: var(--whatsapp-hover);
        }
        
        .whatsapp-chat-item img {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            margin-right: 13px;
            object-fit: cover;
        }
        
        .whatsapp-chat-item-details {
            flex-grow: 1;
            display: flex;
            justify-content: space-between;
            overflow: hidden;
        }
        
        .whatsapp-chat-item-details h4 {
            font-size: 16px;
            font-weight: 400;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .whatsapp-chat-item-details p {
            font-size: 13px;
            color: #8696a0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 180px;
        }
        
        /* Chat Header */
        .whatsapp-chat-header .info {
            flex-grow: 1;
            overflow: hidden;
        }
        
        .whatsapp-chat-header .info h3 {
            font-size: 16px;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .whatsapp-chat-header .info p {
            font-size: 12px;
            color: #8696a0;
        }
        
        .whatsapp-chat-header .icons {
            display: flex;
            gap: 20px;
            font-size: 18px;
            color: #8696a0;
        }
        
        /* Messages */
        .whatsapp-messages {
            flex-grow: 1;
            padding: 15px 10px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        .whatsapp-message {
            display: flex;
            margin-bottom: 8px;
            max-width: 85%; 
            position: relative;
        }
        
        .whatsapp-message.sent {
            align-self: flex-end;
            flex-direction: column;
            align-items: flex-end;
        }
        
        .whatsapp-message.received {
            align-self: flex-start;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .whatsapp-message-bubble {
            padding: 8px 12px;
            border-radius: 7.5px;
            line-height: 1.4;
            font-size: 14px;
            word-wrap: break-word;
            cursor: pointer;
            user-select: none;
            position: relative;
            min-width: 50px;
            white-space: pre-wrap; /* Kunci paragraf */
        }
        
        .whatsapp-message-bubble.selected {
            box-shadow: 0 0 0 2px var(--whatsapp-green);
        }

        .msg-checkbox {
            position: absolute;
            top: 5px;
            left: 5px;
            color: var(--whatsapp-green);
            display: none;
            background: rgba(255,255,255,0.8);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .whatsapp-message.selected-mode .msg-checkbox { display: flex; }
        .whatsapp-message.selected-mode .whatsapp-message-bubble {
            border-left: 4px solid var(--whatsapp-green);
            padding-left: 8px;
        }
        
        .whatsapp-message.sent .whatsapp-message-bubble {
            background-color: var(--whatsapp-msg-sent);
        }
        
        .whatsapp-message.received .whatsapp-message-bubble {
            background-color: var(--whatsapp-msg-received);
        }
        
        /* Media Styles */
        .message-image {
            max-width: 100%;
            border-radius: 5px;
            margin-bottom: 5px;
            display: block;
        }

        .message-audio {
            width: 200px;
            height: 35px;
            outline: none;
        }

        .message-file {
            background: rgba(0,0,0,0.05);
            padding: 10px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }

        .whatsapp-message-time {
            font-size: 10px;
            color: #999;
            margin-top: 2px;
            margin-left: 5px;
            float: right;
        }

        .reply-context {
            font-size: 11px;
            color: #555;
            border-left: 3px solid rgba(0,0,0,0.2);
            padding-left: 5px;
            margin-bottom: 4px;
            font-style: italic;
            opacity: 0.8;
            display: block;
        }
        
        /* Input Area */
        .whatsapp-chat-input {
            padding: 8px 12px;
            background-color: var(--whatsapp-header);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .input-row {
            display: flex;
            align-items: flex-end; 
            gap: 10px;
            margin-top: 5px;
        }
        
        .whatsapp-chat-input i {
            color: #8696a0;
            font-size: 20px; 
            cursor: pointer;
            padding-bottom: 10px; 
        }
        
        /* TEXTAREA STYLES */
        #whatsapp-message-input {
            flex-grow: 1;
            border: none;
            background-color: var(--whatsapp-hover);
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 15px;
            outline: none;
            color: white;
            max-height: 120px;
            overflow-y: hidden; 
            height: 42px; 
            line-height: 20px;
            resize: none; 
            font-family: inherit;
        }
        
        .whatsapp-chat-input button {
            background-color: var(--whatsapp-green);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1px; 
        }
        
        /* Welcome & Profile Views */
        .whatsapp-welcome-screen, .whatsapp-profile-view {
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            color: #8696a0;
            text-align: center;
            padding: 20px;
        }

        .whatsapp-welcome-screen.active, .whatsapp-profile-view.active {
            display: flex;
        }
        
        .whatsapp-profile-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .whatsapp-profile-details {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            width: 100%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .whatsapp-detail-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #f0f2f5;
            font-size: 14px;
        }
        
        .whatsapp-edit-btn {
            background-color: var(--whatsapp-green);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 20px;
            width: 100%;
        }

        /* Members List Styles */
        .members-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .member-item {
            display: flex;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            cursor: pointer;
        }
        
        .member-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 15px;
            object-fit: cover;
        }
        
        .member-info {
            flex-grow: 1;
            overflow: hidden;
        }
        
        .member-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--whatsapp-dark);
            margin-bottom: 2px;
        }
        
        .member-status {
            font-size: 12px;
            color: #667781;
        }
    </style>
</head>
<body>
    <div class="phone-container">
        <div class="whatsapp-container">
            <!-- Sidebar Area -->
            <aside class="whatsapp-sidebar" id="whatsapp-sidebar">
                <header class="whatsapp-sidebar-header">
                    <div class="whatsapp-user-profile" id="whatsapp-user-profile">
                        <img src="https://ui-avatars.com/api/?name=User&background=random" alt="Profile" id="whatsapp-sidebar-profile-pic">
                        <span class="whatsapp-user-profile-name" id="whatsapp-sidebar-username">Pengguna</span>
                    </div>
                    <div class="icons">
                        <i class="fas fa-sign-out-alt" id="btn-logout"></i>
                    </div>
                </header>
                
                <div class="whatsapp-filter-tabs">
                    <div class="whatsapp-filter-tab active" data-filter="all">Semua</div>
                    <div class="whatsapp-filter-tab" data-filter="unread">Belum baca</div>
                    <div class="whatsapp-filter-tab" data-filter="groups">Grup</div>
                </div>
                
                <div class="whatsapp-search-box">
                    <input type="text" placeholder="Cari..." id="whatsapp-search-input">
                </div>
                
                <!-- Chat List -->
                <div class="whatsapp-chat-list" id="whatsapp-chat-list">
                    <!-- JS -->
                </div>
            </aside>

            <!-- Chat Area -->
            <main class="whatsapp-chat-window" id="whatsapp-chat-window">
                <!-- Normal Chat Header -->
                <header class="whatsapp-chat-header" id="normal-chat-header">
                    <i class="fas fa-arrow-left whatsapp-back-btn" id="whatsapp-back-btn"></i>
                    <img src="https://ui-avatars.com/api/?name=User&background=random" alt="Profile" id="whatsapp-chat-profile-img">
                    <div class="info">
                        <h3 id="whatsapp-chat-name">BGT PRO</h3>
                        <p id="whatsapp-chat-status">Aplikasi Pesan Real-Time</p>
                    </div>
                    <div class="icons">
                        <!-- Navbar Camera (Photos) -->
                        <i class="fas fa-camera" id="btn-camera-nav" title="Kamera"></i>
                        <div class="camera-modal" id="camera-modal">
                            <div class="camera-option" onclick="whatsappApp.openCameraMode('bulat')"><i class="fas fa-circle"></i> Bulat</div>
                            <div class="camera-option" onclick="whatsappApp.openCameraMode('potret')"><i class="fas fa-portrait"></i> Potret</div>
                            <div class="camera-option" onclick="whatsappApp.openCameraMode('lanskap')"><i class="fas fa-video"></i> Lanskap</div>
                        </div>

                        <!-- Navbar Video Call -->
                        <i class="fas fa-video" title="Video Call" id="btn-video-call"></i>
                        
                        <!-- Navbar Phone Call -->
                        <i class="fas fa-phone" title="Panggilan" id="btn-phone-call"></i>
                    </div>
                </header>

                <!-- Selection Header (Long Press) -->
                <div class="whatsapp-selection-bar" id="selection-header">
                    <div class="selection-info" id="selection-count">0 Dipilih</div>
                    <div class="selection-actions">
                        <i class="fas fa-share" title="Teruskan" onclick="whatsappApp.forwardSelectedMessages()"></i>
                        <i class="fas fa-trash" title="Hapus" onclick="whatsappApp.showDeletePopup()"></i>
                    </div>
                </div>
                
                <!-- Welcome Screen -->
                <div class="whatsapp-messages" id="whatsapp-messages">
                    <div class="whatsapp-welcome-screen active" id="whatsapp-welcome-screen">
                        <i class="fab fa-whatsapp" style="font-size: 48px; margin-bottom: 20px; color: #25d366;"></i>
                        <h3>Selamat datang di BGT PRO</h3>
                        <p>Pilih anggota untuk mulai chatting</p>
                    </div>
                </div>
                
                <!-- Single Click Context Menu -->
                <div id="message-menu" class="message-menu">
                    <div class="menu-item" onclick="whatsappApp.handleMenuAction('edit')"><i class="fas fa-edit"></i> Edit</div>
                    <div class="menu-item" onclick="whatsappApp.handleMenuAction('reply')"><i class="fas fa-reply"></i> Balas</div>
                    <div class="menu-item" onclick="whatsappApp.handleMenuAction('forward-single')"><i class="fas fa-share"></i> Teruskan</div>
                    <div class="menu-item delete" onclick="whatsappApp.handleMenuAction('delete')"><i class="fas fa-trash"></i> Hapus</div>
                </div>

                <!-- Delete Confirmation Popup -->
                <div id="delete-popup" class="delete-popup">
                    <div class="delete-title">Hapus Pesan</div>
                    <div class="delete-option" onclick="whatsappApp.deleteSelectedMessages('all')">Hapus untuk semua orang</div>
                    <div class="delete-option" onclick="whatsappApp.deleteSelectedMessages('me')">Hapus untuk saya</div>
                    <div class="delete-option cancel" onclick="whatsappApp.hideDeletePopup()">Batal</div>
                </div>

                <!-- Audio Recording Overlay -->
                <div class="recording-overlay" id="recording-overlay">
                    <div class="recording-info">
                        <i class="fas fa-microphone" style="color:var(--recording-red)"></i>
                        <span class="recording-time" id="recording-timer">00:00</span>
                    </div>
                    <div class="recording-stop" id="btn-stop-recording">
                        <i class="fas fa-stop"></i>
                    </div>
                </div>

                <!-- Emoji Picker -->
                <div id="emoji-picker" class="whatsapp-emoji-picker">
                    <!-- JS -->
                </div>
                
                <!-- Profile View -->
                <div class="whatsapp-messages whatsapp-profile-view" id="whatsapp-profile-view">
                    <div class="whatsapp-profile-content">
                        <div class="whatsapp-profile-header">
                            <img src="https://ui-avatars.com/api/?name=User&background=random" alt="Profile" id="whatsapp-profile-pic-large">
                            <h2 id="whatsapp-profile-username">Pengguna</h2>
                            <div style="margin-top: 10px; display: flex; gap: 10px; align-items: center; justify-content: center;">
                                <p id="whatsapp-profile-role" style="color: #667781;">Anggota</p>
                                <svg id="whatsapp-barcode"></svg>
                            </div>
                        </div>
                        
                        <div class="whatsapp-profile-details">
                            <h3 style="margin-bottom: 15px;">Profil Saya</h3>
                            <div class="whatsapp-detail-item"><span>Email</span><span id="whatsapp-detail-email">-</span></div>
                            <div class="whatsapp-detail-item"><span>Telepon</span><span id="whatsapp-detail-phone">-</span></div>
                            <div class="whatsapp-detail-item"><span>Status</span><span id="whatsapp-detail-status">-</span></div>
                        </div>
                        
                        <button class="whatsapp-edit-btn" id="whatsapp-view-members-btn">Lihat Anggota Terdaftar</button>
                    </div>
                </div>

                <!-- Camera Capture UI (Navbar Photo) -->
                <div class="camera-capture-ui" id="camera-capture-ui">
                    <div class="camera-video-container" id="camera-video-container">
                        <video id="camera-preview-video" autoplay muted playsinline></video>
                    </div>
                    <div class="camera-controls">
                        <i class="fas fa-times camera-close-btn" onclick="whatsappApp.closeCameraUI()"></i>
                        <div class="shutter-btn" onclick="whatsappApp.takePhoto()"></div>
                        <div style="width: 24px;"></div> <!-- Spacer -->
                    </div>
                </div>
                
                <div class="whatsapp-chat-input" id="whatsapp-chat-input-area" style="display: none;">
                    <!-- Reply Bar -->
                    <div id="reply-box" class="reply-box">
                        <span style="font-weight: bold; margin-bottom: 2px;">Membalas pesan</span>
                        <div class="reply-text-preview" id="reply-preview-text">...</div>
                        <i class="fas fa-times reply-close-btn" onclick="whatsappApp.closeReply()"></i>
                    </div>

                    <div class="input-row">
                        <!-- Hidden Inputs -->
                        <input type="file" id="camera-input" accept="image/*" style="display: none;">
                        <input type="file" id="file-input" style="display: none;">

                        <i class="fas fa-smile" id="btn-emoji" title="Emoji"></i>
                        <i class="fas fa-paperclip" id="btn-attach" title="Sematkan Dokumen"></i>
                        
                        <!-- Textarea -->
                        <textarea id="whatsapp-message-input" placeholder="Ketik pesan" rows="1"></textarea>
                        
                        <!-- Action Icons -->
                        <i class="fas fa-microphone" id="whatsapp-mic-icon"></i>
                        <button id="whatsapp-send-btn" style="display: none;"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </main>
            
            <!-- Members List View -->
            <div class="members-list" id="members-list">
                <header class="members-header">
                    <i class="fas fa-arrow-left" id="members-back-btn"></i>
                    <h3 id="members-header-title">Anggota Terdaftar</h3>
                </header>
                <div class="members-content" id="members-content"></div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCahZIFKFXMCokFNxCpFokNSVtKzN4llus",
            authDomain: "cedar-setup-425414-d7.firebaseapp.com",
            databaseURL: "https://cedar-setup-425414-d7-default-rtdb.firebaseio.com",
            projectId: "cedar-setup-425414-d7",
            storageBucket: "cedar-setup-425414-d7.firebasestorage.app",
            messagingSenderId: "723545991983",
            appId: "1:723545991983:web:379548d2b425a502a60fda",
            measurementId: "G-FPL6PF3KWJ"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        const whatsappApp = {
            state: {
                activeChatId: null,
                activeFilter: 'all',
                chats: [],
                messages: {},
                currentUserData: null,
                registeredMembers: [],
                selectedMessageId: null,
                selectedMessageIds: new Set(),
                replyingTo: null,
                isRecordingAudio: false,
                mediaRecorder: null,
                audioChunks: [],
                recordingStartTime: 0,
                recordingInterval: null,
                isCameraOpen: false,
                cameraStream: null,
                cameraMode: 'potret',
                isForwardingMode: false,
                messagesToForward: [],
                swipeStartX: 0
            },

            init() {
                if (localStorage.getItem('bgtProSession') !== 'active') {
                    window.location.href = 'dashboard_anggota.html';
                    return;
                }

                this.renderChatList();
                this.renderMembersContent();
                this.initEmojiPicker();

                auth.onAuthStateChanged(user => {
                    if (user) {
                        this.loadUserData(user.uid);
                        this.initUI();
                        this.loadRegisteredMembers();
                    } else {
                        window.location.href = 'dashboard_anggota.html';
                    }
                });
                
                document.addEventListener('click', (e) => {
                    const menu = document.getElementById('message-menu');
                    const cameraModal = document.getElementById('camera-modal');
                    const emojiPicker = document.getElementById('emoji-picker');
                    
                    if (!e.target.closest('.message-menu') && !e.target.closest('.whatsapp-message-bubble') && !e.target.closest('.whatsapp-message')) {
                        menu.style.display = 'none';
                        if(this.state.selectedMessageIds.size === 0) this.removeSelectionHighlight();
                    }
                    if (!e.target.closest('#btn-camera-nav') && !e.target.closest('.camera-modal')) {
                        cameraModal.classList.remove('active');
                    }
                    if (!e.target.closest('#btn-emoji') && !e.target.closest('.whatsapp-emoji-picker')) {
                        emojiPicker.classList.remove('active');
                    }
                });
            },

            initEmojiPicker() {
                const emojis = ["ðŸ˜€","ðŸ˜‚","ðŸ˜","ðŸ¥°","ðŸ˜Ž","ðŸ˜­","ðŸ˜¡","ðŸ‘","ðŸ‘Ž","ðŸ™","ðŸŽ‰","ðŸ”¥","â¤ï¸","ðŸ’”","ðŸ‘€","ðŸ‘‹","ðŸ¤”","ðŸ˜´","ðŸ˜·","ðŸ¤’","ðŸ‘»","ðŸ’©","ðŸ‘½","ðŸ¤–","ðŸ‘¶","ðŸ‘§","ðŸ‘¦","ðŸ§‘","ðŸ‘±","ðŸ‘¨","ðŸ§”","ðŸ‘©","ðŸ§•","ðŸ‘´","ðŸ‘µ","ðŸ™","ðŸ™Ž","ðŸ™…","ðŸ™†","ðŸ’","ðŸ™‹","ðŸ™‡","ðŸ¤¦","ðŸ¤·","ðŸ‘‚","ðŸ‘ƒ","ðŸ‘€","ðŸ‘…","ðŸ‘„"];
                const picker = document.getElementById('emoji-picker');
                emojis.forEach(emoji => {
                    const span = document.createElement('span');
                    span.textContent = emoji;
                    span.className = 'emoji-btn';
                    span.onclick = () => this.insertEmoji(emoji);
                    picker.appendChild(span);
                });
            },

            insertEmoji(emoji) {
                const textarea = document.getElementById('whatsapp-message-input');
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const text = textarea.value;
                const before = text.substring(0, start);
                const after = text.substring(end, text.length);
                
                textarea.value = before + emoji + after;
                textarea.selectionStart = textarea.selectionEnd = start + emoji.length;
                textarea.dispatchEvent(new Event('input'));
                textarea.focus();
            },

            async loadUserData(userId) {
                try {
                    const doc = await db.collection('users').doc(userId).get();
                    if (doc.exists) {
                        this.state.currentUserData = { id: doc.id, ...doc.data() };
                        this.updateProfileUI();
                    }
                } catch (e) { console.error(e); }
            },

            async loadRegisteredMembers() {
                try {
                    const snapshot = await db.collection('users').get();
                    this.state.registeredMembers = [];
                    snapshot.forEach(doc => {
                        if (doc.id !== auth.currentUser.uid) {
                            this.state.registeredMembers.push({ id: doc.id, ...doc.data() });
                        }
                    });
                    this.generateSampleChats();
                } catch (e) { 
                    console.error(e);
                    this.renderChatList();
                }
            },

            generateSampleChats() {
                this.state.chats = this.state.registeredMembers.map((member, index) => ({
                    id: member.id,
                    name: member.username || 'Anggota',
                    avatar: member.profilePicUrl || `https://ui-avatars.com/api/?name=${member.username}&background=random`,
                    lastMessage: 'Klik untuk chat',
                    time: '',
                    unread: 0,
                    isGroup: false,
                    userId: member.id
                }));
                this.renderChatList();
            },

            updateProfileUI() {
                const user = this.state.currentUserData;
                if (!user) return;
                const imgUrl = user.profilePicUrl || `https://ui-avatars.com/api/?name=${user.username || 'User'}&background=random`;
                document.getElementById('whatsapp-sidebar-profile-pic').src = imgUrl;
                document.getElementById('whatsapp-profile-pic-large').src = imgUrl;
                document.getElementById('whatsapp-sidebar-username').textContent = user.username || 'Pengguna';
                document.getElementById('whatsapp-profile-username').textContent = user.username || 'Pengguna';
                document.getElementById('whatsapp-profile-role').textContent = user.role || 'Anggota';
                document.getElementById('whatsapp-detail-email').textContent = user.email || '-';
                document.getElementById('whatsapp-detail-phone').textContent = user.phone || '-';
                document.getElementById('whatsapp-detail-status').textContent = user.status || 'Aktif';
                JsBarcode("#whatsapp-barcode", user.id, { format: "CODE128", width: 1.5, height: 30, displayValue: false });
            },

            initUI() {
                const userProfile = document.getElementById('whatsapp-user-profile');
                const viewMembersBtn = document.getElementById('whatsapp-view-members-btn');
                const membersBackBtn = document.getElementById('members-back-btn');
                const chatBackBtn = document.getElementById('whatsapp-back-btn');
                const logoutBtn = document.getElementById('btn-logout');
                const filterTabs = document.querySelectorAll('.whatsapp-filter-tab');
                const searchInput = document.getElementById('whatsapp-search-input');
                const msgInput = document.getElementById('whatsapp-message-input');
                const sendBtn = document.getElementById('whatsapp-send-btn');
                const micIcon = document.getElementById('whatsapp-mic-icon');
                const cameraNavBtn = document.getElementById('btn-camera-nav');
                const cameraInput = document.getElementById('camera-input');
                const stopRecBtn = document.getElementById('btn-stop-recording');
                const emojiBtn = document.getElementById('btn-emoji');
                const attachBtn = document.getElementById('btn-attach');
                const attachInput = document.getElementById('file-input');
                const btnVideoCall = document.getElementById('btn-video-call');
                const btnPhoneCall = document.getElementById('btn-phone-call');

                userProfile.addEventListener('click', () => this.showScreen('profile'));
                viewMembersBtn.addEventListener('click', () => {
                    this.state.isForwardingMode = false;
                    this.showMembersListInstant();
                });

                membersBackBtn.addEventListener('click', () => window.location.href = 'dashboard_anggota.html');
                chatBackBtn.addEventListener('click', () => window.location.href = 'pesan.html');
                logoutBtn.addEventListener('click', () => {
                    localStorage.removeItem('bgtProSession');
                    window.location.href = 'dashboard_anggota.html';
                });

                filterTabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        filterTabs.forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        this.state.activeFilter = tab.dataset.filter;
                        this.renderChatList();
                    });
                });

                searchInput.addEventListener('input', (e) => this.renderChatList(e.target.value));

                // TEXTAREA LOGIC
                msgInput.addEventListener('input', function() {
                    this.style.height = 'auto'; 
                    this.style.height = (this.scrollHeight) + 'px'; 
                    if (this.value.trim()) {
                        sendBtn.style.display = 'flex';
                        micIcon.style.display = 'none';
                    } else {
                        sendBtn.style.display = 'none';
                        micIcon.style.display = 'block';
                        this.style.height = '42px';
                    }
                });

                sendBtn.addEventListener('click', () => this.sendMessage());

                // --- AUDIO RECORDING ---
                micIcon.addEventListener('click', () => this.toggleAudioRecording());
                stopRecBtn.addEventListener('click', () => this.stopAudioRecording(true));

                // --- CAMERA NAVBAR (Photo) ---
                cameraNavBtn.addEventListener('click', () => {
                    document.getElementById('camera-modal').classList.toggle('active');
                });

                // --- CAMERA (Image Gallery Backup) ---
                cameraInput.addEventListener('change', (e) => this.handleImageUpload(e));

                // --- CALLS ---
                btnVideoCall.addEventListener('click', () => alert("Memulai Video Call..."));
                btnPhoneCall.addEventListener('click', () => alert("Memanggil..."));

                // --- EMOJI ---
                emojiBtn.addEventListener('click', () => {
                    document.getElementById('emoji-picker').classList.toggle('active');
                });

                // --- ATTACH FILE ---
                attachBtn.addEventListener('click', () => attachInput.click());
                attachInput.addEventListener('change', (e) => this.handleFileAttach(e));
            },

            // --- CAMERA UI LOGIC ---
            async openCameraMode(mode) {
                this.state.cameraMode = mode;
                document.getElementById('camera-modal').classList.remove('active');
                const ui = document.getElementById('camera-capture-ui');
                const videoContainer = document.getElementById('camera-video-container');
                const video = document.getElementById('camera-preview-video');
                
                videoContainer.className = 'camera-video-container ratio-' + mode;
                ui.classList.add('active');

                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
                    this.state.cameraStream = stream;
                    video.srcObject = stream;
                } catch(err) {
                    alert("Gagal akses kamera: " + err.message);
                    this.closeCameraUI();
                }
            },

            closeCameraUI() {
                if(this.state.cameraStream) {
                    this.state.cameraStream.getTracks().forEach(track => track.stop());
                }
                document.getElementById('camera-capture-ui').classList.remove('active');
            },

            takePhoto() {
                const video = document.getElementById('camera-preview-video');
                const canvas = document.createElement('canvas');
                const mode = this.state.cameraMode;

                if (mode === 'bulat') {
                    canvas.width = 300; canvas.height = 300;
                } else if (mode === 'potret') {
                    canvas.width = 300; canvas.height = 400;
                } else {
                    canvas.width = 350; canvas.height = 200;
                }

                const ctx = canvas.getContext('2d');
                const vRatio = video.videoWidth / video.videoHeight;
                const cRatio = canvas.width / canvas.height;
                let sWidth, sHeight, sx, sy;

                if (vRatio > cRatio) {
                    sHeight = video.videoHeight;
                    sWidth = sHeight * cRatio;
                    sx = (video.videoWidth - sWidth) / 2;
                    sy = 0;
                } else {
                    sWidth = video.videoWidth;
                    sHeight = sWidth / cRatio;
                    sx = 0;
                    sy = (video.videoHeight - sHeight) / 2;
                }

                ctx.drawImage(video, sx, sy, sWidth, sHeight, 0, 0, canvas.width, canvas.height);
                const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                this.closeCameraUI();
                this.sendMessage(dataUrl, 'image');
            },

            // --- IMAGE COMPRESSION ---
            async compressImage(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = (event) => {
                        const img = new Image();
                        img.src = event.target.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let width = img.width;
                            let height = img.height;
                            const maxWidth = 800; 
                            if (width > maxWidth) {
                                height *= maxWidth / width;
                                width = maxWidth;
                            }
                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            let quality = 0.7;
                            let dataUrl = canvas.toDataURL('image/jpeg', quality);
                            while(dataUrl.length > 1300000 && quality > 0.1) {
                                quality -= 0.1;
                                dataUrl = canvas.toDataURL('image/jpeg', quality);
                            }
                            resolve(dataUrl);
                        };
                        img.onerror = (err) => reject(err);
                    };
                    reader.onerror = (err) => reject(err);
                });
            },

            async handleImageUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                const compressedImage = await this.compressImage(file);
                this.sendMessage(compressedImage, 'image');
                event.target.value = '';
            },

            // --- MULTI SELECT LOGIC ---
            handleLongPress(msgId, event) {
                event.preventDefault();
                this.toggleSelection(msgId);
                this.updateSelectionUI();
            },

            toggleSelection(msgId) {
                if(this.state.selectedMessageIds.has(msgId)) {
                    this.state.selectedMessageIds.delete(msgId);
                } else {
                    if(this.state.selectedMessageIds.size >= 100) {
                        alert("Maksimal 100 pesan.");
                        return;
                    }
                    this.state.selectedMessageIds.add(msgId);
                }
                this.updateSelectionUI();
                this.renderMessages(this.state.activeChatId);
            },

            updateSelectionUI() {
                const count = this.state.selectedMessageIds.size;
                const selectionHeader = document.getElementById('selection-header');
                const normalHeader = document.getElementById('normal-chat-header');
                const countDisplay = document.getElementById('selection-count');

                if (count > 0) {
                    selectionHeader.classList.add('active');
                    normalHeader.style.display = 'none';
                    countDisplay.textContent = `${count} Dipilih`;
                    document.getElementById('whatsapp-chat-input-area').style.display = 'none';
                } else {
                    selectionHeader.classList.remove('active');
                    normalHeader.style.display = 'flex';
                    document.getElementById('whatsapp-chat-input-area').style.display = 'flex';
                    this.renderMessages(this.state.activeChatId); 
                }
            },

            clearSelection() {
                this.state.selectedMessageIds.clear();
                this.updateSelectionUI();
            },

            showDeletePopup() {
                document.getElementById('delete-popup').classList.add('active');
            },

            hideDeletePopup() {
                document.getElementById('delete-popup').classList.remove('active');
            },

            async deleteSelectedMessages(mode) {
                this.hideDeletePopup();
                const chatId = this.state.activeChatId;
                const toDelete = Array.from(this.state.selectedMessageIds);
                
                if (mode === 'all') {
                    if(!confirm("Hapus untuk semua orang?")) return;
                    // Update DB
                    const updatedMessages = this.state.messages[chatId].filter(m => !toDelete.includes(m.id));
                    this.state.messages[chatId] = updatedMessages;
                    try {
                        await db.collection('chats').doc(chatId).update({
                            messages: updatedMessages,
                            lastUpdated: new Date()
                        });
                    } catch (e) { console.error(e); }
                } else {
                    // Delete for me only (Local only)
                    // In a real app, you'd add a "deletedFor" field. 
                    // Here we just remove from local view.
                    if(!confirm("Hapus untuk saya?")) return;
                    // We keep DB sync but just remove local data? 
                    // For demo, let's just update local state to mimic "deleted for me"
                    // And not save to DB to keep it simple, or we can reload from DB to get it back.
                }

                // Apply deletion locally
                this.state.messages[chatId] = this.state.messages[chatId].filter(m => !toDelete.includes(m.id));
                
                this.clearSelection();
                this.renderMessages(chatId);
            },

            forwardSelectedMessages() {
                const chatId = this.state.activeChatId;
                const ids = Array.from(this.state.selectedMessageIds);
                this.state.messagesToForward = this.state.messages[chatId].filter(m => ids.includes(m.id));
                
                this.state.isForwardingMode = true;
                this.clearSelection();
                
                document.getElementById('members-header-title').textContent = "Teruskan Ke...";
                document.getElementById('members-list').classList.add('active');
                document.getElementById('whatsapp-chat-window').classList.remove('active');
                this.renderMembersContent();
            },

            // --- SINGLE CLICK MENU LOGIC ---
            showMenu(e, messageId, bubbleEl) {
                if (this.state.selectedMessageIds.size > 0) return;

                e.stopPropagation();
                this.state.selectedMessageId = messageId;
                this.highlightBubble(bubbleEl);

                const menu = document.getElementById('message-menu');
                const rect = bubbleEl.getBoundingClientRect();
                const containerRect = document.querySelector('.whatsapp-chat-window').getBoundingClientRect();
                
                let top = rect.top - containerRect.top - 100; 
                let left = rect.left - containerRect.left - 50;

                if (top < 10) top = rect.bottom - containerRect.top + 10;
                if (left < 10) left = 10;
                
                menu.style.top = `${top}px`;
                menu.style.left = `${left}px`;
                menu.style.display = 'flex';
            },

            highlightBubble(bubbleEl) {
                document.querySelectorAll('.whatsapp-message-bubble').forEach(el => el.classList.remove('selected'));
                if(bubbleEl) bubbleEl.classList.add('selected');
            },

            removeSelectionHighlight() {
                document.querySelectorAll('.whatsapp-message-bubble').forEach(el => el.classList.remove('selected'));
            },

            handleMenuAction(action) {
                const menu = document.getElementById('message-menu');
                menu.style.display = 'none';
                
                const chatId = this.state.activeChatId;
                const msgId = this.state.selectedMessageId;
                const msgObj = this.state.messages[chatId].find(m => m.id === msgId);

                if (!msgObj) return;

                switch (action) {
                    case 'delete': this.deleteMessage(chatId, msgId); break;
                    case 'edit': 
                        if (!msgObj.image && !msgObj.audio && !msgObj.file) this.editMessage(chatId, msgId, msgObj.text); 
                        else alert("Tidak bisa mengedit pesan media.");
                        break;
                    case 'reply': this.enableReplyMode(msgObj); break;
                    case 'forward-single':
                        this.state.messagesToForward = [msgObj];
                        this.state.isForwardingMode = true;
                        this.showMembersListInstant();
                        document.getElementById('members-header-title').textContent = "Teruskan Ke...";
                        break;
                }
                this.removeSelectionHighlight();
            },

            async deleteMessage(chatId, msgId) {
                const updatedMessages = this.state.messages[chatId].filter(m => m.id !== msgId);
                this.state.messages[chatId] = updatedMessages;
                this.renderMessages(chatId);
                try {
                    await db.collection('chats').doc(chatId).update({
                        messages: updatedMessages,
                        lastUpdated: new Date()
                    });
                } catch (e) { console.error("Gagal menghapus:", e); }
            },

            async editMessage(chatId, msgId, currentText) {
                const newText = prompt("Edit pesan:", currentText);
                if (newText && newText.trim() !== "") {
                    const msgIndex = this.state.messages[chatId].findIndex(m => m.id === msgId);
                    if (msgIndex > -1) {
                        this.state.messages[chatId][msgIndex].text = newText;
                        this.state.messages[chatId][msgIndex].edited = true;
                        this.renderMessages(chatId);
                        try {
                            await db.collection('chats').doc(chatId).update({
                                messages: this.state.messages[chatId],
                                lastUpdated: new Date()
                            });
                        } catch (e) { console.error("Gagal edit:", e); }
                    }
                }
            },

            enableReplyMode(msgObj) {
                this.state.replyingTo = msgObj;
                const replyBox = document.getElementById('reply-box');
                const previewText = document.getElementById('reply-preview-text');
                
                replyBox.classList.add('active');
                previewText.textContent = msgObj.text || (msgObj.image ? "[Gambar]" : (msgObj.audio ? "[Audio]" : "[File]"));
                document.getElementById('whatsapp-message-input').focus();
            },

            closeReply() {
                this.state.replyingTo = null;
                document.getElementById('reply-box').classList.remove('active');
            },

            // --- AUDIO RECORDING ---
            async toggleAudioRecording() {
                if (!this.state.isRecordingAudio) {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        this.state.mediaRecorder = new MediaRecorder(stream);
                        this.state.audioChunks = [];
                        this.state.mediaRecorder.ondataavailable = (event) => { this.state.audioChunks.push(event.data); };
                        this.state.mediaRecorder.start();
                        this.state.isRecordingAudio = true;
                        this.state.recordingStartTime = Date.now();
                        document.getElementById('recording-overlay').classList.add('active');
                        document.getElementById('whatsapp-chat-input-area').style.display = 'none';
                        this.state.recordingInterval = setInterval(() => {
                            const diff = Math.floor((Date.now() - this.state.recordingStartTime) / 1000);
                            const min = String(Math.floor(diff / 60)).padStart(2, '0');
                            const sec = String(diff % 60).padStart(2, '0');
                            document.getElementById('recording-timer').textContent = `${min}:${sec}`;
                        }, 1000);
                    } catch (err) { alert("Izin mikrofon dibutuhkan."); }
                } else {
                    this.stopAudioRecording(true);
                }
            },

            async stopAudioRecording(send = false) {
                if (this.state.mediaRecorder && this.state.isRecordingAudio) {
                    this.state.mediaRecorder.stop();
                    this.state.mediaRecorder.stream.getTracks().forEach(track => track.stop());
                }
                this.state.isRecordingAudio = false;
                clearInterval(this.state.recordingInterval);
                document.getElementById('recording-overlay').classList.remove('active');
                document.getElementById('whatsapp-chat-input-area').style.display = 'flex';
                if (send && this.state.audioChunks.length > 0) {
                    const audioBlob = new Blob(this.state.audioChunks, { type: 'audio/mp3' });
                    const reader = new FileReader();
                    reader.readAsDataURL(audioBlob);
                    reader.onloadend = () => { this.sendMessage(reader.result, 'audio'); };
                }
                this.state.audioChunks = [];
            },

            handleFileAttach(event) {
                const file = event.target.files[0];
                if (!file) return;
                this.sendMessage(`ðŸ“„ Dokumen: ${file.name}`, 'text');
                event.target.value = '';
            },

            showMembersListInstant() {
                this.showScreen('welcome');
                document.getElementById('members-list').classList.add('active');
                document.getElementById('whatsapp-chat-window').classList.remove('active');
                document.getElementById('members-header-title').textContent = "Anggota Terdaftar";
                this.renderMembersContent();
            },

            renderMembersContent() {
                const container = document.getElementById('members-content');
                container.innerHTML = '';
                if(this.state.registeredMembers.length === 0) {
                    container.innerHTML = '<p style="text-align:center; color:#667781; padding:20px;">Tidak ada anggota lain.</p>';
                    return;
                }

                this.state.registeredMembers.forEach(member => {
                    const item = document.createElement('div');
                    item.className = 'member-item';
                    const avatarUrl = member.profilePicUrl || `https://ui-avatars.com/api/?name=${member.username}&background=random`;
                    item.innerHTML = `
                        <img src="${avatarUrl}" class="member-avatar">
                        <div class="member-info">
                            <div class="member-name">${member.username || 'Tanpa Nama'}</div>
                            <div class="member-status">Klik untuk chat</div>
                        </div>
                        <i class="fas fa-comment-dots" style="color: #8696a0;"></i>
                    `;
                    item.addEventListener('click', () => {
                        if(this.state.isForwardingMode) {
                            this.executeForward(member.id);
                        } else {
                            this.openChatFromMembers(member);
                        }
                    });
                    container.appendChild(item);
                });
            },

            openChatFromMembers(member) {
                let chat = this.state.chats.find(c => c.userId === member.id);
                if (!chat) {
                    chat = {
                        id: member.id,
                        name: member.username,
                        avatar: member.profilePicUrl || `https://ui-avatars.com/api/?name=${member.username}&background=random`,
                        lastMessage: '',
                        userId: member.id
                    };
                }
                this.openChat(chat);
            },

            async executeForward(targetChatId) {
                if(!confirm("Teruskan pesan ini?")) return;
                
                if(!this.state.messages[targetChatId]) this.state.messages[targetChatId] = [];
                
                const msgsToSend = this.state.messagesToForward.map(m => ({
                    ...m,
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                    senderId: auth.currentUser.uid,
                    timestamp: new Date(),
                    replyTo: null 
                }));

                this.state.messages[targetChatId].push(...msgsToSend);
                
                if(targetChatId === this.state.activeChatId) {
                    this.renderMessages(targetChatId);
                }

                try {
                    await db.collection('chats').doc(targetChatId).set({
                        messages: this.state.messages[targetChatId],
                        lastUpdated: new Date()
                    }, { merge: true });
                } catch (e) { console.error(e); }

                this.state.isForwardingMode = false;
                this.state.messagesToForward = [];
                document.getElementById('members-list').classList.remove('active');
                
                const targetMember = this.state.registeredMembers.find(m => m.id === targetChatId);
                if(targetMember) this.openChatFromMembers(targetMember);
            },

            openChat(chat) {
                const chatWindow = document.getElementById('whatsapp-chat-window');
                document.getElementById('whatsapp-chat-name').textContent = chat.name;
                document.getElementById('whatsapp-chat-status').textContent = 'Online';
                const imgElement = document.getElementById('whatsapp-chat-profile-img');
                imgElement.src = chat.avatar;

                document.getElementById('whatsapp-welcome-screen').classList.remove('active');
                document.getElementById('whatsapp-profile-view').classList.remove('active');
                document.getElementById('whatsapp-chat-input-area').style.display = 'flex';

                chatWindow.classList.add('active');
                document.getElementById('members-list').classList.remove('active');

                this.state.activeChatId = chat.id;
                this.loadMessages(chat.id);
                setTimeout(() => document.getElementById('whatsapp-message-input').focus(), 300);
                
                document.getElementById('message-menu').style.display = 'none';
                this.closeReply();
            },

            showScreen(screenName) {
                const welcome = document.getElementById('whatsapp-welcome-screen');
                const profile = document.getElementById('whatsapp-profile-view');
                const chatName = document.getElementById('whatsapp-chat-name');
                const chatImg = document.getElementById('whatsapp-chat-profile-img');

                if (screenName === 'welcome') {
                    welcome.classList.add('active');
                    profile.classList.remove('active');
                    chatName.textContent = 'BGT PRO';
                    chatImg.src = document.getElementById('whatsapp-sidebar-profile-pic').src;
                    document.getElementById('whatsapp-chat-input-area').style.display = 'none';
                } else if (screenName === 'profile') {
                    welcome.classList.remove('active');
                    profile.classList.add('active');
                    chatName.textContent = 'Profil Saya';
                    chatImg.src = this.state.currentUserData?.profilePicUrl || '';
                    document.getElementById('whatsapp-chat-input-area').style.display = 'none';
                }
            },

            loadMessages(chatId) {
                const container = document.getElementById('whatsapp-messages');
                if (!this.state.messages[chatId]) {
                    this.state.messages[chatId] = [];
                }
                this.renderMessages(chatId);

                db.collection('chats').doc(chatId).onSnapshot(doc => {
                    if (doc.exists && doc.data().messages) {
                        this.state.messages[chatId] = doc.data().messages;
                        this.renderMessages(chatId);
                    }
                });
            },

            renderMessages(chatId) {
                const container = document.getElementById('whatsapp-messages');
                const msgs = this.state.messages[chatId] || [];
                
                let bubbleContainer = document.getElementById('bubble-container');
                if(!bubbleContainer) {
                    bubbleContainer = document.createElement('div');
                    bubbleContainer.id = 'bubble-container';
                    bubbleContainer.style.flexDirection = 'column';
                    bubbleContainer.style.display = 'flex';
                    bubbleContainer.style.width = '100%';
                    container.appendChild(bubbleContainer);
                }
                
                const isAtBottom = container.scrollHeight - container.scrollTop === container.clientHeight;
                bubbleContainer.innerHTML = '';

                msgs.forEach(msg => {
                    const isMe = msg.senderId === auth.currentUser.uid || msg.senderId === 'me';
                    const isSelected = this.state.selectedMessageIds.has(msg.id);
                    
                    const el = document.createElement('div');
                    el.className = `whatsapp-message ${isMe ? 'sent' : 'received'} ${isSelected ? 'selected-mode' : ''}`;
                    
                    const checkbox = document.createElement('div');
                    checkbox.className = 'msg-checkbox';
                    checkbox.innerHTML = isSelected ? '<i class="fas fa-check"></i>' : '';
                    el.appendChild(checkbox);

                    let contentHtml = '';
                    if (msg.image) contentHtml += `<img src="${msg.image}" class="message-image" alt="Image">`;
                    
                    if (msg.file) contentHtml += `<div class="message-file"><i class="fas fa-file-alt fa-lg"></i> <span>${msg.text}</span></div>`;
                    
                    if (msg.text && !msg.file) { 
                        let replyHtml = '';
                        if (msg.replyTo && msg.replyTo.text) {
                            replyHtml = `<span class="reply-context">"${msg.replyTo.text}"</span>`;
                        }
                        contentHtml += `${replyHtml}<span>${msg.text}</span>`;
                    }
                    if (msg.audio) contentHtml += `<audio controls src="${msg.audio}" class="message-audio"></audio>`;

                    const timeHtml = `<div class="whatsapp-message-time">${msg.edited ? 'Diedit ' : ''}10:00</div>`;

                    el.innerHTML += `
                        <div class="whatsapp-message-bubble" data-id="${msg.id}">
                            ${contentHtml}
                            ${timeHtml}
                        </div>
                    `;
                    
                    const bubble = el.querySelector('.whatsapp-message-bubble');
                    
                    // --- INTERACTION LOGIC (SWIPE, LONG PRESS, CLICK) ---
                    let pressTimer;
                    let isSwipe = false;

                    el.addEventListener('touchstart', (e) => {
                        this.state.swipeStartX = e.touches[0].clientX;
                        pressTimer = setTimeout(() => {
                            this.handleLongPress(msg.id, e);
                        }, 500);
                    }, {passive: false});
                    
                    el.addEventListener('touchend', (e) => {
                        clearTimeout(pressTimer);
                        const endX = e.changedTouches[0].clientX;
                        const diffX = this.state.swipeStartX - endX;

                        // Check Swipe (Left or Right)
                        if (Math.abs(diffX) > 50) {
                            // Swipe detected -> Reply
                            isSwipe = true;
                            this.enableReplyMode(msg);
                        }
                    });

                    bubble.addEventListener('click', (e) => {
                        if(e.target.tagName === 'AUDIO' || e.target.tagName === 'INPUT') return;
                        
                        // Prevent click if swipe happened
                        if (isSwipe) {
                            isSwipe = false; 
                            return;
                        }

                        if (this.state.selectedMessageIds.size > 0) {
                            this.toggleSelection(msg.id);
                        } else {
                            this.showMenu(e, msg.id, bubble);
                        }
                    });

                    bubbleContainer.appendChild(el);
                });
                
                if (isAtBottom) container.scrollTop = container.scrollHeight;
            },

            async sendMessage(mediaContent = null, mediaType = 'text') {
                const textarea = document.getElementById('whatsapp-message-input');
                const text = textarea.value.trim();

                if ((!text && !mediaContent) || !this.state.activeChatId) return;

                const newMsg = { 
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                    senderId: auth.currentUser.uid, 
                    timestamp: new Date() 
                };

                if (mediaType === 'text') {
                    newMsg.text = text;
                } else if (mediaType === 'image') {
                    newMsg.image = mediaContent;
                    if(text) newMsg.text = text; 
                } else if (mediaType === 'audio') {
                    newMsg.audio = mediaContent;
                }

                if (this.state.replyingTo) {
                    newMsg.replyTo = {
                        id: this.state.replyingTo.id,
                        text: this.state.replyingTo.text || (this.state.replyingTo.image ? "[Gambar]" : (this.state.replyingTo.audio ? "[Audio]" : "[File]"))
                    };
                    this.closeReply();
                }

                this.state.messages[this.state.activeChatId].push(newMsg);
                this.renderMessages(this.state.activeChatId);
                
                textarea.value = '';
                textarea.style.height = '42px';
                document.getElementById('whatsapp-send-btn').style.display = 'none';
                document.getElementById('whatsapp-mic-icon').style.display = 'block';

                try {
                    await db.collection('chats').doc(this.state.activeChatId).set({
                        messages: this.state.messages[this.state.activeChatId],
                        lastUpdated: new Date()
                    }, { merge: true });
                } catch (e) { 
                    console.error("Gagal mengirim pesan:", e);
                    alert("Gagal mengirim pesan. Ukuran mungkin melebihi batas Firestore (1MB).");
                }
            },

            renderChatList(filterText = '') {
                const list = document.getElementById('whatsapp-chat-list');
                list.innerHTML = '';
                
                if (this.state.chats.length === 0) {
                    list.innerHTML = '<p style="text-align:center; color:#667781; padding:20px; font-size:14px;">Belum ada percakapan.</p>';
                    return;
                }

                const filtered = this.state.chats.filter(c => {
                    const matchesFilter = (this.state.activeFilter === 'all') || (this.state.activeFilter === 'unread' && c.unread > 0) || (this.state.activeFilter === 'groups' && c.isGroup);
                    const matchesSearch = c.name.toLowerCase().includes(filterText.toLowerCase());
                    return matchesFilter && matchesSearch;
                });

                if (filtered.length === 0) {
                    list.innerHTML = '<p style="text-align:center; color:#667781; padding:20px; font-size:14px;">Tidak ditemukan.</p>';
                    return;
                }

                filtered.forEach(chat => {
                    const item = document.createElement('div');
                    item.className = 'whatsapp-chat-item';
                    item.innerHTML = `
                        <img src="${chat.avatar}">
                        <div class="whatsapp-chat-item-details">
                            <div class="whatsapp-chat-item-info">
                                <h4>${chat.name}</h4>
                                <p>${chat.lastMessage}</p>
                            </div>
                            <div class="whatsapp-chat-item-meta">
                                <div class="whatsapp-chat-item-time">${chat.time}</div>
                            </div>
                        </div>
                    `;
                    item.addEventListener('click', () => this.openChat(chat));
                    list.appendChild(item);
                });
            }
        };

        document.addEventListener('DOMContentLoaded', () => whatsappApp.init());
    </script>
</body>
</html>
