<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pesan - BGT PRO</title>
    
    <!-- External Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
    
    <!-- Tambahkan library JsBarcode untuk barcode yang fungsional -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    
    <style>
        /* CSS Variables untuk Theme Support */
        :root {
            --primary-color: #4285f4;
            --primary-dark: #1a73e8;
            --secondary-color: #ff6b6b;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --info-color: #3498db;
            
            /* Light Theme */
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --text-color: #2c3e50;
            --text-secondary: #7f8c8d;
            --border-color: #e9ecef;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --overlay-bg: rgba(0, 0, 0, 0.5);
            --header-bg: linear-gradient(135deg, #4285f4, #1a73e8);
            --nav-bg: #ffffff;
            
            /* Transitions */
            --transition-fast: 0.2s;
            --transition-normal: 0.3s;
            
            /* WhatsApp Theme Variables */
            --whatsapp-bg: #f0f2f5;
            --whatsapp-sidebar: #111b21;
            --whatsapp-chat-bg: #e5ddd5;
            --whatsapp-msg-sent: #d9fdd3;
            --whatsapp-msg-received: #fff;
            --whatsapp-green: #25d366;
            --whatsapp-dark: #202c33;
            --whatsapp-header: #0b141a;
            --whatsapp-hover: #182229;
            --whatsapp-filter-active: #8696a0;
            --whatsapp-sidebar-width: 350px;
        }
        
        [data-theme="dark"] {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-color: #ffffff;
            --text-secondary: #b0b0b0;
            --border-color: #333333;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --overlay-bg: rgba(0, 0, 0, 0.7);
            --header-bg: linear-gradient(135deg, #1a73e8, #0d47a1);
            --nav-bg: #1e1e1e;
        }
        
        /* Global Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-color);
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            padding: 0; 
            overflow: hidden; /* Mencegah scroll pada body utama */
            transition: background-color var(--transition-normal);
        }
        
        /* Phone Container */
        .phone-container { 
            width: 100%; 
            height: 100%; 
            background-color: var(--card-bg); 
            position: relative; 
            overflow: hidden; 
            transition: background-color var(--transition-normal);
            display: flex;
        }
        
        @media (min-width: 480px) {
            .phone-container {
                width: 375px;
                height: 750px;
                border-radius: 16px; 
                box-shadow: 0 10px 30px var(--shadow-color); 
                border: 1px solid var(--border-color);
            }
        }
        
        /* WhatsApp Container Layout */
        .whatsapp-container {
            display: flex;
            flex-direction: row; /* Default layout sidebar + chat */
            width: 100%;
            height: 100%;
            background-color: var(--whatsapp-bg);
            overflow: hidden;
            position: relative;
        }
        
        /* --- SIDEBAR --- */
        .whatsapp-sidebar {
            background-color: var(--whatsapp-sidebar);
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            flex-shrink: 0;
            z-index: 10;
            transition: transform 0.3s ease;
        }
        
        /* Desktop Layout */
        @media (min-width: 769px) {
            .whatsapp-sidebar {
                width: 350px;
                border-right: 1px solid #333;
            }
        }
        
        /* --- CHAT WINDOW --- */
        .whatsapp-chat-window {
            display: none; /* Hidden by default on mobile */
            flex-direction: column;
            background-color: #efeae2;
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 20; /* Di atas sidebar */
        }
        
        /* Desktop Chat Window Behavior */
        @media (min-width: 769px) {
            .whatsapp-chat-window {
                display: flex; /* Selalu tampil di desktop */
                position: relative;
                flex-grow: 1;
                z-index: 5;
            }
        }
        
        .whatsapp-chat-window.active {
            display: flex;
            animation: slideInRight 0.2s ease-out;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        
        /* --- MEMBERS LIST (Full Screen Overlay) --- */
        .members-list {
            display: none;
            flex-direction: column;
            height: 100%;
            background-color: #f0f2f5;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 30; /* Paling atas untuk overlay full screen */
            animation: fadeIn 0.2s ease-out;
        }
        
        .members-list.active {
            display: flex;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* --- UI COMPONENTS --- */
        .whatsapp-back-btn {
            display: block; /* Selalu tampilkan di mobile */
            margin-right: 15px;
            color: #8696a0;
            font-size: 20px;
            cursor: pointer;
        }

        @media (min-width: 769px) {
            .whatsapp-back-btn {
                display: none; /* Sembunyikan di desktop */
            }
        }
        
        /* Header Styles */
        .whatsapp-sidebar-header, .whatsapp-chat-header, .members-header {
            padding: 10px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: var(--whatsapp-header);
            color: white;
            height: 60px;
            flex-shrink: 0;
        }
        
        .whatsapp-user-profile {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 5px;
            border-radius: 8px;
            transition: background-color 0.2s;
            flex-grow: 1;
        }
        
        .whatsapp-user-profile:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .whatsapp-user-profile img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 12px;
            object-fit: cover;
        }
        
        .whatsapp-user-profile-name {
            font-size: 16px; /* Sedikit lebih kecil agar muat */
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .whatsapp-sidebar-header .icons {
            display: flex;
            gap: 20px;
            font-size: 18px;
            cursor: pointer;
        }
        
        .whatsapp-sidebar-header .icons i {
            color: #8696a0;
        }
        
        /* Tabs & Search */
        .whatsapp-filter-tabs {
            display: flex;
            background-color: var(--whatsapp-header);
            color: #8696a0;
            padding: 0 16px;
            height: 44px;
            align-items: center;
            flex-shrink: 0;
        }
        
        .whatsapp-filter-tab {
            padding: 6px 12px;
            margin-right: 15px;
            cursor: pointer;
            font-size: 14px;
            border-radius: 10px;
            transition: all 0.2s;
        }
        
        .whatsapp-filter-tab.active {
            background-color: var(--whatsapp-hover);
            color: white;
        }
        
        .whatsapp-search-box {
            padding: 8px 12px;
            background-color: var(--whatsapp-header);
            flex-shrink: 0;
        }
        
        .whatsapp-search-box input {
            width: 100%;
            padding: 8px 12px;
            border-radius: 8px;
            background-color: var(--whatsapp-hover);
            border: none;
            color: #e9edef;
            outline: none;
            font-size: 14px;
        }
        
        /* Chat List Items */
        .whatsapp-chat-list {
            flex-grow: 1;
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        .whatsapp-chat-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            cursor: pointer;
            color: white;
            transition: background-color 0.2s;
            position: relative;
        }
        
        .whatsapp-chat-item:hover {
            background-color: var(--whatsapp-hover);
        }
        
        .whatsapp-chat-item img {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            margin-right: 13px;
            object-fit: cover;
        }
        
        .whatsapp-chat-item-details {
            flex-grow: 1;
            display: flex;
            justify-content: space-between;
            width: 100%;
            overflow: hidden;
        }
        
        .whatsapp-chat-item-details h4 {
            font-size: 16px;
            font-weight: 400;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .whatsapp-chat-item-details p {
            font-size: 13px;
            color: #8696a0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 180px;
        }
        
        .whatsapp-chat-item-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            min-width: 50px;
        }
        
        .whatsapp-chat-item-time {
            font-size: 12px;
            color: #8696a0;
            margin-bottom: 2px;
        }
        
        .whatsapp-unread-badge {
            background-color: var(--whatsapp-green);
            color: white;
            border-radius: 50%;
            min-width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            padding: 0 4px;
        }
        
        /* Chat Window Header */
        .whatsapp-chat-header {
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .whatsapp-chat-header img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 13px;
            object-fit: cover;
        }
        
        .whatsapp-chat-header .info {
            flex-grow: 1;
            overflow: hidden;
        }
        
        .whatsapp-chat-header .info h3 {
            font-size: 16px;
            color: white;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .whatsapp-chat-header .info p {
            font-size: 12px;
            color: #8696a0;
        }
        
        .whatsapp-chat-header .icons {
            display: flex;
            gap: 20px;
            font-size: 18px;
            color: #8696a0;
            cursor: pointer;
        }
        
        /* Messages Area */
        .whatsapp-messages {
            flex-grow: 1;
            padding: 15px 10px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        .whatsapp-message {
            display: flex;
            margin-bottom: 8px;
            max-width: 75%;
        }
        
        .whatsapp-message.sent {
            align-self: flex-end;
            flex-direction: column;
            align-items: flex-end;
        }
        
        .whatsapp-message.received {
            align-self: flex-start;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .whatsapp-message-bubble {
            padding: 8px 12px;
            border-radius: 7.5px;
            line-height: 1.4;
            position: relative;
            max-width: 100%;
            word-wrap: break-word;
            font-size: 14px;
        }
        
        .whatsapp-message.sent .whatsapp-message-bubble {
            background-color: #dcf8c6;
        }
        
        .whatsapp-message.received .whatsapp-message-bubble {
            background-color: white;
        }
        
        .whatsapp-message-time {
            font-size: 10px;
            color: #999;
            margin-top: 2px;
            margin-left: 4px;
            float: right;
        }
        
        /* Chat Input */
        .whatsapp-chat-input {
            padding: 8px 12px;
            background-color: var(--whatsapp-header);
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }
        
        .whatsapp-chat-input i {
            color: #8696a0;
            font-size: 22px;
            cursor: pointer;
        }
        
        .whatsapp-chat-input input {
            flex-grow: 1;
            border: none;
            background-color: var(--whatsapp-hover);
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 14px;
            outline: none;
            color: white;
        }
        
        .whatsapp-chat-input button {
            background-color: var(--whatsapp-green);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Welcome & Profile Views */
        .whatsapp-welcome-screen, .whatsapp-profile-view {
            display: none; /* Default hidden */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            color: #8696a0;
            background-color: #efeae2;
            text-align: center;
            padding: 20px;
        }

        .whatsapp-welcome-screen.active, .whatsapp-profile-view.active {
            display: flex;
        }
        
        .whatsapp-profile-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .whatsapp-profile-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .whatsapp-profile-header img {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 4px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 15px;
            object-fit: cover;
        }
        
        .whatsapp-profile-details {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            width: 100%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .whatsapp-detail-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #f0f2f5;
            font-size: 14px;
        }
        
        .whatsapp-edit-btn {
            background-color: var(--whatsapp-green);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            margin-top: 20px;
            width: 100%;
            max-width: 300px;
        }

        /* Members List Styles */
        .members-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .member-item {
            display: flex;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.1s, background-color 0.2s;
        }
        
        .member-item:active {
            background-color: #f0f2f5;
            transform: scale(0.98);
        }
        
        .member-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 15px;
            object-fit: cover;
            background-color: #ddd;
        }
        
        .member-info {
            flex-grow: 1;
            overflow: hidden;
        }
        
        .member-name {
            font-size: 16px;
            font-weight: 600;
            color: #202c33;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .member-status {
            font-size: 12px;
            color: #667781;
        }

        /* Loading State */
        .loading-state {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100%;
            color: #8696a0;
            background-color: #efeae2;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 5;
        }
        
        .loading-spinner {
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #25d366;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-bottom: 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background-color: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s;
            font-size: 14px;
            pointer-events: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
    </style>
</head>
<body>
    <div class="phone-container">
        <div class="whatsapp-container">
            <!-- Sidebar Area -->
            <aside class="whatsapp-sidebar" id="whatsapp-sidebar">
                <header class="whatsapp-sidebar-header">
                    <div class="whatsapp-user-profile" id="whatsapp-user-profile">
                        <img src="https://picsum.photos/seed/loading/100/100.jpg" alt="Profile" id="whatsapp-sidebar-profile-pic">
                        <span class="whatsapp-user-profile-name" id="whatsapp-sidebar-username">Memuat...</span>
                    </div>
                    <div class="icons">
                        <i class="fas fa-sign-out-alt" id="btn-logout" title="Keluar ke Dashboard"></i>
                    </div>
                </header>
                
                <div class="whatsapp-filter-tabs">
                    <div class="whatsapp-filter-tab active" data-filter="all">Semua</div>
                    <div class="whatsapp-filter-tab" data-filter="unread">Belum baca</div>
                    <div class="whatsapp-filter-tab" data-filter="groups">Grup</div>
                </div>
                
                <div class="whatsapp-search-box">
                    <input type="text" placeholder="Cari..." id="whatsapp-search-input">
                </div>
                
                <div class="whatsapp-chat-list" id="whatsapp-chat-list">
                    <div class="loading-state">
                        <div class="loading-spinner"></div>
                        <p>Memuat...</p>
                    </div>
                </div>
            </aside>

            <!-- Chat Area -->
            <main class="whatsapp-chat-window" id="whatsapp-chat-window">
                <header class="whatsapp-chat-header">
                    <i class="fas fa-arrow-left whatsapp-back-btn" id="whatsapp-back-btn"></i>
                    <img src="https://picsum.photos/seed/loading/100/100.jpg" alt="Profile" id="whatsapp-chat-profile-img">
                    <div class="info">
                        <h3 id="whatsapp-chat-name">BGT PRO</h3>
                        <p id="whatsapp-chat-status">Aplikasi Pesan Real-Time</p>
                    </div>
                    <div class="icons">
                        <i class="fas fa-video"></i>
                        <i class="fas fa-phone"></i>
                    </div>
                </header>
                
                <!-- Welcome Screen -->
                <div class="whatsapp-messages" id="whatsapp-messages">
                    <div class="whatsapp-welcome-screen active" id="whatsapp-welcome-screen">
                        <i class="fab fa-whatsapp" style="font-size: 48px; margin-bottom: 20px; color: #25d366;"></i>
                        <h3>Selamat datang di BGT PRO Chat</h3>
                        <p>Kirim dan terima pesan dengan anggota lain.</p>
                    </div>
                </div>
                
                <!-- Profile View -->
                <div class="whatsapp-messages whatsapp-profile-view" id="whatsapp-profile-view">
                    <div class="whatsapp-profile-content">
                        <div class="whatsapp-profile-header">
                            <img src="https://picsum.photos/seed/loading/100/100.jpg" alt="Profile" id="whatsapp-profile-pic-large">
                            <h2 id="whatsapp-profile-username">Memuat...</h2>
                            <div style="margin-top: 10px; display: flex; gap: 10px; align-items: center;">
                                <p id="whatsapp-profile-role" style="color: #667781;">Memuat...</p>
                                <svg id="whatsapp-barcode"></svg>
                            </div>
                        </div>
                        
                        <div class="whatsapp-profile-details">
                            <h3 style="margin-bottom: 15px; color: var(--whatsapp-dark);">Profil Saya</h3>
                            <div class="whatsapp-detail-item">
                                <span class="whatsapp-detail-label">Email</span>
                                <span class="whatsapp-detail-value" id="whatsapp-detail-email">-</span>
                            </div>
                            <div class="whatsapp-detail-item">
                                <span class="whatsapp-detail-label">Telepon</span>
                                <span class="whatsapp-detail-value" id="whatsapp-detail-phone">-</span>
                            </div>
                            <div class="whatsapp-detail-item">
                                <span class="whatsapp-detail-label">Status</span>
                                <span class="whatsapp-detail-value" id="whatsapp-detail-status">-</span>
                            </div>
                        </div>
                        
                        <button class="whatsapp-edit-btn" id="whatsapp-view-members-btn">Lihat Anggota Terdaftar</button>
                    </div>
                </div>
                
                <div class="whatsapp-chat-input" id="whatsapp-chat-input-area" style="display: none;">
                    <i class="fas fa-smile"></i>
                    <i class="fas fa-paperclip"></i>
                    <input type="text" id="whatsapp-message-input" placeholder="Ketik pesan">
                    <i class="fas fa-microphone" id="whatsapp-mic-icon"></i>
                    <button id="whatsapp-send-btn" style="display: none;"><i class="fas fa-paper-plane"></i></button>
                </div>
            </main>
            
            <!-- Members List View (Full Screen Overlay) -->
            <div class="members-list" id="members-list">
                <header class="members-header">
                    <i class="fas fa-arrow-left" id="members-back-btn"></i>
                    <h3>Anggota Terdaftar</h3>
                </header>
                <div class="members-content" id="members-content">
                    <!-- Member items injected here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">Notifikasi</div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCahZIFKFXMCokFNxCpFokNSVtKzN4llus",
            authDomain: "cedar-setup-425414-d7.firebaseapp.com",
            databaseURL: "https://cedar-setup-425414-d7-default-rtdb.firebaseio.com",
            projectId: "cedar-setup-425414-d7",
            storageBucket: "cedar-setup-425414-d7.firebasestorage.app",
            messagingSenderId: "723545991983",
            appId: "1:723545991983:web:379548d2b425a502a60fda",
            measurementId: "G-FPL6PF3KWJ"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // WhatsApp App State
        const whatsappApp = {
            state: {
                activeChatId: null,
                activeFilter: 'all',
                chats: [],
                messages: {},
                currentUserData: null,
                registeredMembers: [],
                previousView: 'sidebar', // 'sidebar' or 'members'
                isMobile: window.innerWidth <= 768
            },

            init() {
                this.checkExistingSession();
                
                // Auth Listener
                auth.onAuthStateChanged(user => {
                    if (user) {
                        this.loadUserData(user.uid);
                        this.initUI();
                        this.loadRegisteredMembers();
                    } else {
                        window.location.href = 'dashboard_anggota.html';
                    }
                });

                // Handle Resize
                window.addEventListener('resize', () => {
                    this.state.isMobile = window.innerWidth <= 768;
                    this.handleResize();
                });
            },

            checkExistingSession() {
                const session = localStorage.getItem('bgtProSession');
                if (session !== 'active') {
                    const referrer = document.referrer;
                    if (referrer && referrer.includes('dashboard_anggota.html')) {
                        localStorage.setItem('bgtProSession', 'active');
                    } else {
                        window.location.href = 'dashboard_anggota.html';
                    }
                }
            },

            async loadUserData(userId) {
                try {
                    const doc = await db.collection('users').doc(userId).get();
                    if (doc.exists) {
                        this.state.currentUserData = { id: doc.id, ...doc.data() };
                        this.updateProfileUI();
                    }
                } catch (error) {
                    console.error("Error loading user data:", error);
                }
            },

            async loadRegisteredMembers() {
                try {
                    const snapshot = await db.collection('users').get();
                    this.state.registeredMembers = [];
                    snapshot.forEach(doc => {
                        if (doc.id !== auth.currentUser.uid) {
                            this.state.registeredMembers.push({ id: doc.id, ...doc.data() });
                        }
                    });
                    this.generateSampleChats(); // Buat chat list dari anggota
                } catch (error) {
                    console.error("Error loading members:", error);
                }
            },

            generateSampleChats() {
                const sampleChats = this.state.registeredMembers.map((member, index) => ({
                    id: member.id,
                    name: member.username || 'Anggota',
                    avatar: member.profilePicUrl || `https://i.pravatar.cc/150?img=${index + 10}`,
                    lastMessage: 'Klik untuk mulai chat',
                    time: '',
                    unread: 0,
                    isGroup: false,
                    userId: member.id
                }));

                this.state.chats = sampleChats;
                this.renderChatList();
            },

            updateProfileUI() {
                const user = this.state.currentUserData;
                if (!user) return;

                const updateEl = (id, val, isSrc = false) => {
                    const el = document.getElementById(id);
                    if (el) isSrc ? el.src = val : el.textContent = val;
                };

                const imgUrl = user.profilePicUrl || 'https://picsum.photos/seed/default/100/100.jpg';
                
                updateEl('whatsapp-sidebar-profile-pic', imgUrl, true);
                updateEl('whatsapp-profile-pic-large', imgUrl, true);
                updateEl('whatsapp-sidebar-username', user.username || 'User');
                updateEl('whatsapp-profile-username', user.username || 'User');
                updateEl('whatsapp-profile-role', user.role || 'Anggota');
                updateEl('whatsapp-detail-email', user.email || '-');
                updateEl('whatsapp-detail-phone', user.phone || '-');
                updateEl('whatsapp-detail-status', user.status || 'Aktif');

                // Generate Barcode
                JsBarcode("#whatsapp-barcode", user.id, {
                    format: "CODE128", width: 1.5, height: 30, displayValue: false
                });
            },

            initUI() {
                // Elements
                const els = {
                    userProfile: document.getElementById('whatsapp-user-profile'),
                    viewMembersBtn: document.getElementById('whatsapp-view-members-btn'),
                    membersBackBtn: document.getElementById('whatsapp-members-back-btn'), // ID fixed below
                    chatBackBtn: document.getElementById('whatsapp-back-btn'),
                    logoutBtn: document.getElementById('btn-logout'),
                    filterTabs: document.querySelectorAll('.whatsapp-filter-tab'),
                    searchInput: document.getElementById('whatsapp-search-input'),
                    msgInput: document.getElementById('whatsapp-message-input'),
                    sendBtn: document.getElementById('whatsapp-send-btn'),
                    micIcon: document.getElementById('whatsapp-mic-icon')
                };

                // --- Event Listeners ---

                // 1. Klik Profil Sidebar -> Buka Profil
                els.userProfile.addEventListener('click', () => {
                    this.showScreen('profile');
                    this.state.previousView = 'sidebar';
                });

                // 2. Klik Tombol "Lihat Anggota" -> Buka Halaman Anggota (Tanpa Loading)
                els.viewMembersBtn.addEventListener('click', () => {
                    this.showMembersListInstant();
                });

                // 3. Klik Back di Anggota -> Kembali ke Dashboard Utama
                document.getElementById('members-back-btn').addEventListener('click', () => {
                    // Langsung redirect tanpa loading
                    window.location.href = 'dashboard_anggota.html';
                });

                // 4. Klik Back di Chat -> Logika pintar (Sidebar vs Members)
                els.chatBackBtn.addEventListener('click', () => {
                    if (this.state.previousView === 'members') {
                        // Kembali ke List Anggota
                        this.showMembersListInstant();
                    } else {
                        // Kembali ke Sidebar
                        this.closeChat();
                    }
                });

                // 5. Klik Logout -> Dashboard
                els.logoutBtn.addEventListener('click', () => {
                    localStorage.removeItem('bgtProSession');
                    window.location.href = 'dashboard_anggota.html';
                });

                // Filter Tabs
                els.filterTabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        els.filterTabs.forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        this.state.activeFilter = tab.dataset.filter;
                        this.renderChatList();
                    });
                });

                // Search
                els.searchInput.addEventListener('input', (e) => this.renderChatList(e.target.value));

                // Input Pesan
                els.msgInput.addEventListener('input', (e) => {
                    if (e.target.value.trim()) {
                        els.sendBtn.style.display = 'flex';
                        els.micIcon.style.display = 'none';
                    } else {
                        els.sendBtn.style.display = 'none';
                        els.micIcon.style.display = 'block';
                    }
                });

                els.sendBtn.addEventListener('click', () => this.sendMessage());
                els.msgInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') this.sendMessage(); });
            },

            // --- Navigation Logic ---

            showScreen(screenName) {
                const welcome = document.getElementById('whatsapp-welcome-screen');
                const profile = document.getElementById('whatsapp-profile-view');
                const chatName = document.getElementById('whatsapp-chat-name');
                const chatStatus = document.getElementById('whatsapp-chat-status');
                const chatImg = document.getElementById('whatsapp-chat-profile-img');

                if (screenName === 'welcome') {
                    welcome.classList.add('active');
                    profile.classList.remove('active');
                    chatName.textContent = 'BGT PRO';
                    chatStatus.textContent = 'Aplikasi Pesan';
                    chatImg.src = document.getElementById('whatsapp-sidebar-profile-pic').src;
                    document.getElementById('whatsapp-chat-input-area').style.display = 'none';
                } else if (screenName === 'profile') {
                    welcome.classList.remove('active');
                    profile.classList.add('active');
                    chatName.textContent = 'Proil Saya';
                    chatStatus.textContent = 'Data Diri';
                    chatImg.src = this.state.currentUserData?.profilePicUrl || '';
                    document.getElementById('whatsapp-chat-input-area').style.display = 'none';
                }
            },

            // 1. Buka List Anggota (Instant)
            showMembersListInstant() {
                // Hide chat window sidebar profile view logic if active
                this.showScreen('welcome'); 
                
                // Show Members List Overlay
                const membersList = document.getElementById('members-list');
                membersList.classList.add('active');
                
                // Render members (Pastikan data sudah ada di state)
                this.renderMembersContent();
            },

            // 2. Render Anggota
            renderMembersContent() {
                const container = document.getElementById('members-content');
                container.innerHTML = ''; // Clear existing

                if (this.state.registeredMembers.length === 0) {
                    container.innerHTML = '<p style="text-align:center; color:#999; margin-top:20px;">Tidak ada anggota lain.</p>';
                    return;
                }

                this.state.registeredMembers.forEach(member => {
                    const item = document.createElement('div');
                    item.className = 'member-item';
                    
                    const avatarUrl = member.profilePicUrl || `https://ui-avatars.com/api/?name=${member.username}&background=random`;

                    item.innerHTML = `
                        <img src="${avatarUrl}" class="member-avatar" alt="img">
                        <div class="member-info">
                            <div class="member-name">${member.username || 'Tanpa Nama'}</div>
                            <div class="member-status">Klik untuk chat</div>
                        </div>
                        <i class="fas fa-comment-dots" style="color: #8696a0;"></i>
                    `;

                    // 3. Klik Anggota -> Buka Chat Full Screen
                    item.addEventListener('click', () => {
                        this.openChatFromMembers(member);
                    });

                    container.appendChild(item);
                });
            },

            // 4. Buka Chat dari List Anggota
            openChatFromMembers(member) {
                // Cari atau buat objek chat
                let chat = this.state.chats.find(c => c.userId === member.id);
                if (!chat) {
                    chat = {
                        id: member.id,
                        name: member.username,
                        avatar: member.profilePicUrl || `https://ui-avatars.com/api/?name=${member.username}&background=random`,
                        lastMessage: '',
                        userId: member.id
                    };
                }

                // Set state previous view agar tombol back tahu kemana harus balik
                this.state.previousView = 'members';
                
                // Buka Chat Window
                this.openChat(chat);
            },

            openChat(chat) {
                const chatWindow = document.getElementById('whatsapp-chat-window');
                
                // Update Header
                document.getElementById('whatsapp-chat-name').textContent = chat.name;
                document.getElementById('whatsapp-chat-status').textContent = 'Online';
                document.getElementById('whatsapp-chat-profile-img').src = chat.avatar;

                // Hide Screens, Show Input
                document.getElementById('whatsapp-welcome-screen').classList.remove('active');
                document.getElementById('whatsapp-profile-view').classList.remove('active');
                document.getElementById('whatsapp-chat-input-area').style.display = 'flex';

                // Active Chat Window (Full Screen di Mobile karena position absolute)
                chatWindow.classList.add('active');
                
                // Hide Members List Overlay jika sedang aktif (Transisi bersih)
                document.getElementById('members-list').classList.remove('active');

                this.state.activeChatId = chat.id;
                this.loadMessages(chat.id);
                
                // Focus input
                setTimeout(() => document.getElementById('whatsapp-message-input').focus(), 300);
            },

            closeChat() {
                const chatWindow = document.getElementById('whatsapp-chat-window');
                chatWindow.classList.remove('active');
                this.state.activeChatId = null;
                this.showScreen('welcome');
            },

            loadMessages(chatId) {
                const msgContainer = document.getElementById('whatsapp-messages');
                // Simulasi pesan (bisa diganti real-time listener)
                msgContainer.innerHTML = ''; // Clear welcome screen
                
                // Cek local state dulu
                if (!this.state.messages[chatId]) {
                    this.state.messages[chatId] = [
                        { text: 'Halo!', senderId: 'other', timestamp: new Date() },
                        { text: 'Hai, apa kabar?', senderId: 'me', timestamp: new Date() }
                    ];
                }

                this.renderMessages(chatId);

                // Realtime Listener (Optional Logic)
                db.collection('chats').doc(chatId).onSnapshot(doc => {
                    if (doc.exists && doc.data().messages) {
                        this.state.messages[chatId] = doc.data().messages;
                        this.renderMessages(chatId);
                    }
                });
            },

            renderMessages(chatId) {
                const container = document.getElementById('whatsapp-messages');
                const msgs = this.state.messages[chatId] || [];
                
                // Keep welcome/profile screens hidden structure, but inject messages
                // Simple hack: append messages, ensure profile/welcome are display:none via class toggling in openChat
                
                // Clear only messages, keep structure if needed, but here we rebuild
                const existingMessages = container.querySelectorAll('.whatsapp-message');
                existingMessages.forEach(el => el.remove());

                // If no messages and screens are hidden, show empty placeholder? 
                // No, just show the bubbles.
                
                // Note: In this DOM structure, .whatsapp-messages contains both welcome screen and bubbles.
                // We must ensure bubbles are placed correctly.
                // Better approach: Have a dedicated div for bubbles inside messages.
                // For now, let's just append.
                
                // Actually, let's protect the inner screens
                const welcome = document.getElementById('whatsapp-welcome-screen');
                const profile = document.getElementById('whatsapp-profile-view');
                
                // Create a container for bubbles if not exists
                let bubbleContainer = document.getElementById('bubble-container');
                if(!bubbleContainer) {
                    bubbleContainer = document.createElement('div');
                    bubbleContainer.id = 'bubble-container';
                    bubbleContainer.style.flexDirection = 'column';
                    bubbleContainer.style.display = 'flex';
                    bubbleContainer.style.width = '100%';
                    container.appendChild(bubbleContainer);
                }
                
                bubbleContainer.innerHTML = '';

                msgs.forEach(msg => {
                    const isMe = msg.senderId === auth.currentUser.uid || msg.senderId === 'me';
                    const el = document.createElement('div');
                    el.className = `whatsapp-message ${isMe ? 'sent' : 'received'}`;
                    el.innerHTML = `
                        <div class="whatsapp-message-bubble">${msg.text}</div>
                        <div class="whatsapp-message-time">10:00</div>
                    `;
                    bubbleContainer.appendChild(el);
                });

                container.scrollTop = container.scrollHeight;
            },

            async sendMessage() {
                const input = document.getElementById('whatsapp-message-input');
                const text = input.value.trim();
                if (!text || !this.state.activeChatId) return;

                const newMsg = {
                    text: text,
                    senderId: auth.currentUser.uid,
                    timestamp: new Date()
                };

                // Optimistic UI
                this.state.messages[this.state.activeChatId].push(newMsg);
                this.renderMessages(this.state.activeChatId);
                input.value = '';
                document.getElementById('whatsapp-send-btn').style.display = 'none';
                document.getElementById('whatsapp-mic-icon').style.display = 'block';

                try {
                    await db.collection('chats').doc(this.state.activeChatId).set({
                        messages: firebase.firestore.FieldValue.arrayUnion(newMsg),
                        lastUpdated: new Date()
                    }, { merge: true });
                } catch (e) {
                    console.error(e);
                    this.showToast('Gagal mengirim');
                }
            },

            renderChatList(filterText = '') {
                const list = document.getElementById('whatsapp-chat-list');
                list.innerHTML = '';
                
                const filtered = this.state.chats.filter(c => {
                    const matchesFilter = 
                        (this.state.activeFilter === 'all') ||
                        (this.state.activeFilter === 'unread' && c.unread > 0) ||
                        (this.state.activeFilter === 'groups' && c.isGroup);
                    
                    const matchesSearch = c.name.toLowerCase().includes(filterText.toLowerCase());
                    return matchesFilter && matchesSearch;
                });

                if (filtered.length === 0) {
                    list.innerHTML = '<p style="text-align:center; color:#667781; padding:20px;">Tidak ada chat.</p>';
                    return;
                }

                filtered.forEach(chat => {
                    const item = document.createElement('div');
                    item.className = 'whatsapp-chat-item';
                    item.innerHTML = `
                        <img src="${chat.avatar}">
                        <div class="whatsapp-chat-item-details">
                            <div class="whatsapp-chat-item-info">
                                <h4>${chat.name}</h4>
                                <p>${chat.lastMessage}</p>
                            </div>
                            <div class="whatsapp-chat-item-meta">
                                <div class="whatsapp-chat-item-time">${chat.time}</div>
                            </div>
                        </div>
                    `;
                    item.addEventListener('click', () => {
                        this.state.previousView = 'sidebar'; // Standard chat behavior
                        this.openChat(chat);
                    });
                    list.appendChild(item);
                });
            },

            handleResize() {
                const chatWindow = document.getElementById('whatsapp-chat-window');
                if (this.state.isMobile) {
                    // Mobile logic handled by CSS .active class and absolute positioning
                    if (!this.state.activeChatId) {
                        chatWindow.classList.remove('active');
                    }
                } else {
                    // Desktop: Always show chat window
                    chatWindow.style.display = 'flex';
                    chatWindow.classList.remove('active'); // Remove animation class
                }
            },

            showToast(msg) {
                const t = document.getElementById('toast');
                t.textContent = msg;
                t.classList.add('show');
                setTimeout(() => t.classList.remove('show'), 3000);
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            whatsappApp.init();
        });
    </script>
</body>
</html>
